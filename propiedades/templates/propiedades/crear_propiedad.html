{% extends 'core/base.html' %}
{% load static %}

{% block title %}Crear Nueva Propiedad - Tienda Inmobiliaria{% endblock %}

{% block content %}
<!-- Header Section -->
<section class="bg-primary text-white py-5">
    <div class="container">
        <div class="row align-items-center">
            <div class="col-lg-8">
                <h1 class="fw-bold">Crear Nueva Propiedad</h1>
                <p class="lead mb-0">Agrega una nueva propiedad al catálogo inmobiliario</p>
            </div>
            <div class="col-lg-4 text-end">
                <a href="{% url 'propiedades:lista' %}" class="btn btn-outline-light">
                    <i class="fas fa-arrow-left"></i> Volver a Propiedades
                </a>
            </div>
        </div>
    </div>
</section>

<!-- Form Section -->
<section class="py-5">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-lg-8">
                <div class="card border-0 shadow-lg">
                    <div class="card-header bg-light">
                        <h4 class="mb-0">
                            <i class="fas fa-plus-circle text-primary"></i> Información de la Propiedad
                        </h4>
                    </div>
                    <div class="card-body p-4">
                        <!-- Messages -->
                        {% if messages %}
                            {% for message in messages %}
                                <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                                    {{ message }}
                                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                                </div>
                            {% endfor %}
                        {% endif %}

                        <form method="post" enctype="multipart/form-data" id="crearPropiedadForm" action="{% url 'propiedades:crear' %}">
                            {% csrf_token %}
                            
                            <!-- Título y Descripción -->
                            <div class="row mb-4">
                                <div class="col-12 mb-3">
                                    <label for="{{ form.titulo.id_for_label }}" class="form-label fw-bold">
                                        {{ form.titulo.label }}
                                    </label>
                                    {{ form.titulo }}
                                    {% if form.titulo.errors %}
                                        <div class="text-danger mt-1">
                                            {% for error in form.titulo.errors %}
                                                <small>{{ error }}</small>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                    {% if form.titulo.help_text %}
                                        <div class="form-text">{{ form.titulo.help_text }}</div>
                                    {% endif %}
                                </div>
                                
                                <div class="col-12">
                                    <label for="{{ form.descripcion.id_for_label }}" class="form-label fw-bold">
                                        {{ form.descripcion.label }}
                                    </label>
                                    {{ form.descripcion }}
                                    {% if form.descripcion.errors %}
                                        <div class="text-danger mt-1">
                                            {% for error in form.descripcion.errors %}
                                                <small>{{ error }}</small>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                    {% if form.descripcion.help_text %}
                                        <div class="form-text">{{ form.descripcion.help_text }}</div>
                                    {% endif %}
                                </div>
                            </div>

                            <!-- Precio y Tipo -->
                            <div class="row mb-4">
                                <div class="col-md-4 mb-3">
                                    <label for="{{ form.precio.id_for_label }}" class="form-label fw-bold">
                                        {{ form.precio.label }}
                                    </label>
                                    <div class="input-group">
                                        <span class="input-group-text">$</span>
                                        {{ form.precio }}
                                    </div>
                                    {% if form.precio.errors %}
                                        <div class="text-danger mt-1">
                                            {% for error in form.precio.errors %}
                                                <small>{{ error }}</small>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                    {% if form.precio.help_text %}
                                        <div class="form-text">{{ form.precio.help_text }}</div>
                                    {% endif %}
                                </div>
                                
                                <div class="col-md-4 mb-3">
                                    <label for="{{ form.tipo.id_for_label }}" class="form-label fw-bold">
                                        {{ form.tipo.label }}
                                    </label>
                                    {{ form.tipo }}
                                    {% if form.tipo.errors %}
                                        <div class="text-danger mt-1">
                                            {% for error in form.tipo.errors %}
                                                <small>{{ error }}</small>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                                
                                <div class="col-md-4 mb-3">
                                    <label for="{{ form.operacion.id_for_label }}" class="form-label fw-bold">
                                        {{ form.operacion.label }}
                                    </label>
                                    {{ form.operacion }}
                                    {% if form.operacion.errors %}
                                        <div class="text-danger mt-1">
                                            {% for error in form.operacion.errors %}
                                                <small>{{ error }}</small>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                    {% if form.operacion.help_text %}
                                        <div class="form-text">{{ form.operacion.help_text }}</div>
                                    {% endif %}
                                </div>
                            </div>

                            <!-- Estado y Ubicación -->
                            <div class="row mb-4">
                                <div class="col-md-6 mb-3">
                                    <label for="{{ form.estado.id_for_label }}" class="form-label fw-bold">
                                        {{ form.estado.label }}
                                    </label>
                                    {{ form.estado }}
                                    {% if form.estado.errors %}
                                        <div class="text-danger mt-1">
                                            {% for error in form.estado.errors %}
                                                <small>{{ error }}</small>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                                
                                <div class="col-md-6 mb-3">
                                    <label for="{{ form.ubicacion.id_for_label }}" class="form-label fw-bold">
                                        {{ form.ubicacion.label }}
                                    </label>
                                    {{ form.ubicacion }}
                                    {% if form.ubicacion.errors %}
                                        <div class="text-danger mt-1">
                                            {% for error in form.ubicacion.errors %}
                                                <small>{{ error }}</small>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                    {% if form.ubicacion.help_text %}
                                        <div class="form-text">{{ form.ubicacion.help_text }}</div>
                                    {% endif %}
                                </div>
                            </div>

                            <!-- Características -->
                            <div class="row mb-4">
                                <div class="col-md-4 mb-3">
                                    <label for="{{ form.metros_cuadrados.id_for_label }}" class="form-label fw-bold">
                                        {{ form.metros_cuadrados.label }}
                                    </label>
                                    <div class="input-group">
                                        {{ form.metros_cuadrados }}
                                        <span class="input-group-text">m²</span>
                                    </div>
                                    {% if form.metros_cuadrados.errors %}
                                        <div class="text-danger mt-1">
                                            {% for error in form.metros_cuadrados.errors %}
                                                <small>{{ error }}</small>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                                
                                <div class="col-md-4 mb-3">
                                    <label for="{{ form.habitaciones.id_for_label }}" class="form-label fw-bold">
                                        {{ form.habitaciones.label }}
                                    </label>
                                    {{ form.habitaciones }}
                                    {% if form.habitaciones.errors %}
                                        <div class="text-danger mt-1">
                                            {% for error in form.habitaciones.errors %}
                                                <small>{{ error }}</small>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                                
                                <div class="col-md-4 mb-3">
                                    <label for="{{ form.banos.id_for_label }}" class="form-label fw-bold">
                                        {{ form.banos.label }}
                                    </label>
                                    {{ form.banos }}
                                    {% if form.banos.errors %}
                                        <div class="text-danger mt-1">
                                            {% for error in form.banos.errors %}
                                                <small>{{ error }}</small>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>

                            <!-- Imágenes -->
                            <div class="mb-4">
                                <h5 class="mb-3 text-primary">
                                    <i class="fas fa-images me-2"></i>Imágenes de la Propiedad
                                </h5>
                                
                                <!-- Imagen Principal -->
                                <div class="mb-3">
                                    <label for="{{ form.imagen_principal.id_for_label }}" class="form-label fw-bold">
                                        {{ form.imagen_principal.label }}
                                        <span class="text-danger">*</span>
                                    </label>
                                    {{ form.imagen_principal }}
                                    {% if form.imagen_principal.errors %}
                                        <div class="text-danger mt-1">
                                            {% for error in form.imagen_principal.errors %}
                                                <small>{{ error }}</small>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                    {% if form.imagen_principal.help_text %}
                                        <div class="form-text">{{ form.imagen_principal.help_text }}</div>
                                    {% endif %}
                                </div>
                                
                                <!-- Imagen Secundaria -->
                                <div class="mb-3">
                                    <label for="{{ form.imagen_secundaria.id_for_label }}" class="form-label fw-bold">
                                        {{ form.imagen_secundaria.label }}
                                    </label>
                                    {{ form.imagen_secundaria }}
                                    {% if form.imagen_secundaria.errors %}
                                        <div class="text-danger mt-1">
                                            {% for error in form.imagen_secundaria.errors %}
                                                <small>{{ error }}</small>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                    {% if form.imagen_secundaria.help_text %}
                                        <div class="form-text">{{ form.imagen_secundaria.help_text }}</div>
                                    {% endif %}
                                </div>
                                

                                

                                
                                <!-- Campo oculto para fotos adicionales -->
                                {{ form.fotos_adicionales }}
                                
                                <!-- Fotos y Videos Adicionales -->
                                <div class="mb-3">
                                    <label class="form-label fw-bold">
                                        <i class="fas fa-photo-video me-2"></i>Fotos y Videos Adicionales
                                    </label>
                                    <div class="upload-area" id="uploadArea">
                                        <div class="upload-content">
                                            <i class="fas fa-cloud-upload-alt fa-3x text-muted mb-3"></i>
                                            <h6 class="text-muted">Arrastra y suelta archivos aquí o haz clic para seleccionar</h6>
                                            <p class="text-muted small">Máximo 10 archivos de 50MB cada uno</p>
                                            <p class="text-muted small">Imágenes: JPG, PNG | Videos: MP4, AVI, MOV</p>
                                            <input type="file" id="fotosInput" multiple accept="image/*,video/*" class="d-none">
                                            <button type="button" class="btn btn-outline-primary btn-sm" onclick="document.getElementById('fotosInput').click()">
                                                <i class="fas fa-plus me-2"></i>Seleccionar Archivos
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <!-- Preview de archivos seleccionados -->
                                    <div id="fotos-preview" class="mt-3" style="display: none;">
                                        <h6 class="mb-2 text-primary">
                                            <i class="fas fa-photo-video me-2"></i>Archivos seleccionados:
                                        </h6>
                                        <div id="fotos-grid" class="row g-2"></div>
                                    </div>
                                </div>
                                
                                <div class="alert alert-info mt-2">
                                    <i class="fas fa-info-circle me-2"></i>
                                    <strong>Consejo:</strong> La imagen principal se mostrará en el home, la secundaria en el detalle. Los archivos adicionales (fotos y videos) estarán disponibles en la galería completa.
                                </div>
                            </div>

                            <!-- Amenidades -->
                            <div class="mb-4">
                                <label class="form-label fw-bold">
                                    <i class="fas fa-check-circle me-2"></i>Amenidades Incluidas
                                </label>
                                <p class="text-muted small mb-3">Selecciona las amenidades que incluye esta propiedad:</p>
                                
                                <div class="row">
                                    {% for amenidad in amenidades %}
                                    <div class="col-md-6 col-lg-4 mb-2">
                                        <div class="form-check amenidad-checkbox">
                                            <input type="checkbox" name="amenidades" value="{{ amenidad.id }}" id="id_amenidades_{{ forloop.counter0 }}" class="form-check-input">
                                            <label class="form-check-label" for="id_amenidades_{{ forloop.counter0 }}">
                                                <i class="fas me-2 text-primary" data-icon="{{ amenidad.icono }}"></i>
                                                {{ amenidad.nombre }}
                                            </label>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                                
                                {% if form.amenidades.errors %}
                                    <div class="text-danger mt-2">
                                        {% for error in form.amenidades.errors %}
                                            <small>{{ error }}</small>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>

                            <!-- Submit Buttons -->
                            <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                                <a href="{% url 'propiedades:lista' %}" class="btn btn-secondary btn-lg me-md-2">
                                    <i class="fas fa-times"></i> Cancelar
                                </a>
                                <button type="submit" class="btn btn-primary btn-lg">
                                    <i class="fas fa-save"></i> Crear Propiedad
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>
{% endblock %}



{% block extra_css %}
<style>
/* Estilos para el área de upload */
.upload-area {
    border: 2px dashed #dee2e6;
    border-radius: 10px;
    padding: 30px;
    text-align: center;
    background: #f8f9fa;
    transition: all 0.3s ease;
    cursor: pointer;
}

.upload-area:hover {
    border-color: #007bff;
    background: #e3f2fd;
}

.upload-area.dragover {
    border-color: #28a745;
    background: #d4edda;
    transform: scale(1.02);
}

.upload-content {
    pointer-events: none;
}

.upload-content button {
    pointer-events: all;
}

/* Estilos para las amenidades */
.amenidad-checkbox {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 12px;
    transition: all 0.3s ease;
}

.amenidad-checkbox:hover {
    background: #e3f2fd;
    border-color: #007bff;
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0, 123, 255, 0.1);
}

.amenidad-checkbox .form-check-input:checked + .form-check-label {
    color: #007bff;
    font-weight: 600;
}

.amenidad-checkbox .form-check-input:checked {
    background-color: #007bff;
    border-color: #007bff;
}

.amenidad-checkbox .form-check-label {
    cursor: pointer;
    margin-left: 8px;
    font-size: 0.9rem;
}

.amenidad-checkbox .form-check-label i {
    width: 16px;
    text-align: center;
}

/* Estilos para el preview de fotos adicionales */
.fotos-preview-container {
    background: #f8f9fa;
    border: 2px dashed #dee2e6;
    border-radius: 10px;
    padding: 20px;
    margin-top: 15px;
}

.foto-preview-item {
    position: relative;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    overflow: hidden;
    transition: all 0.3s ease;
    background: white;
}

.foto-preview-item:hover {
    border-color: #007bff;
    box-shadow: 0 4px 12px rgba(0, 123, 255, 0.2);
    transform: translateY(-2px);
}

.foto-preview-item img {
    width: 100%;
    height: 120px;
    object-fit: cover;
}

.foto-preview-info {
    padding: 8px;
    background: rgba(0, 0, 0, 0.05);
    text-align: center;
}

.foto-preview-info small {
    font-size: 0.75rem;
    line-height: 1.2;
    color: #6c757d;
}

.foto-preview-remove {
    position: absolute;
    top: 5px;
    right: 5px;
    background: rgba(220, 53, 69, 0.9);
    color: white;
    border: none;
    border-radius: 50%;
    width: 24px;
    height: 24px;
    font-size: 12px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.foto-preview-remove:hover {
    background: rgba(220, 53, 69, 1);
    transform: scale(1.1);
}

/* Responsive para el preview */
@media (max-width: 767px) {
    .foto-preview-item img {
        height: 100px;
    }
    
    .foto-preview-info {
        padding: 6px;
    }
    
    .fotos-preview-container {
        padding: 15px;
    }
}

/* Animación de entrada */
.foto-preview-item {
    animation: slideIn 0.3s ease-out;
}

@keyframes slideIn {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}
</style>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Form validation
    const form = document.getElementById('crearPropiedadForm');
    const precioInput = document.getElementById('{{ form.precio.id_for_label }}');
    const metrosInput = document.getElementById('{{ form.metros_cuadrados.id_for_label }}');
    
    // Formato de precio
    precioInput.addEventListener('input', function(e) {
        let value = e.target.value.replace(/[^\d.]/g, '');
        if (value && !isNaN(value)) {
            value = parseFloat(value).toFixed(2);
            e.target.value = value;
        }
    });
    
    // Validación antes de enviar
    form.addEventListener('submit', function(e) {
        const titulo = document.getElementById('{{ form.titulo.id_for_label }}').value.trim();
        const descripcion = document.getElementById('{{ form.descripcion.id_for_label }}').value.trim();
        const precio = precioInput.value;
        const ubicacion = document.getElementById('{{ form.ubicacion.id_for_label }}').value.trim();
        
        if (!titulo || !descripcion || !precio || !ubicacion) {
            e.preventDefault();
            alert('Por favor completa todos los campos obligatorios.');
            return false;
        }
        
        if (parseFloat(precio) <= 0) {
            e.preventDefault();
            alert('El precio debe ser mayor a 0.');
            return false;
        }
    });
    
    // Preview de imagen principal
    const imagenPrincipalInput = document.getElementById('{{ form.imagen_principal.id_for_label }}');
    imagenPrincipalInput.addEventListener('change', function(e) {
        validateImageFile(e.target, 'imagen principal');
    });
    
    // Preview de imagen secundaria
    const imagenSecundariaInput = document.getElementById('{{ form.imagen_secundaria.id_for_label }}');
    if (imagenSecundariaInput) {
        imagenSecundariaInput.addEventListener('change', function(e) {
            validateImageFile(e.target, 'imagen secundaria');
        });
    }
    
    // Sistema de múltiples fotos adicionales
    const fotosInput = document.getElementById('fotosInput');
    const uploadArea = document.getElementById('uploadArea');
    let fotosSeleccionadas = [];
    
    // Evento para seleccionar archivos
    fotosInput.addEventListener('change', function(e) {
        handleFiles(e.target.files);
    });
    
    // Drag and Drop
    uploadArea.addEventListener('dragover', function(e) {
        e.preventDefault();
        uploadArea.classList.add('dragover');
    });
    
    uploadArea.addEventListener('dragleave', function(e) {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
    });
    
    uploadArea.addEventListener('drop', function(e) {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
        const files = e.dataTransfer.files;
        handleFiles(files);
    });
    
    // Función para manejar archivos seleccionados (fotos y videos)
    function handleFiles(files) {
        const validFiles = Array.from(files).filter(file => {
            // Validar tipo de archivo (imagen o video)
            const isImage = file.type.startsWith('image/');
            const isVideo = file.type.startsWith('video/');
            const validVideoTypes = ['video/mp4', 'video/avi', 'video/quicktime', 'video/x-msvideo'];
            
            if (!isImage && !isVideo) {
                alert(`El archivo ${file.name} no es una imagen o video válido.`);
                return false;
            }
            
            if (isVideo && !validVideoTypes.includes(file.type)) {
                alert(`El formato de video ${file.name} no es compatible. Use MP4, AVI o MOV.`);
                return false;
            }
            
            // Validar tamaño (50MB para videos, 5MB para imágenes)
            const maxSize = isVideo ? 50 * 1024 * 1024 : 5 * 1024 * 1024;
            if (file.size > maxSize) {
                const maxSizeMB = isVideo ? 50 : 5;
                alert(`El archivo ${file.name} excede el tamaño máximo de ${maxSizeMB}MB.`);
                return false;
            }
            
            // Validar cantidad máxima
            if (fotosSeleccionadas.length >= 10) {
                alert('Puedes seleccionar máximo 10 archivos adicionales.');
                return false;
            }
            
            return true;
        });
        
        // Agregar archivos válidos
        fotosSeleccionadas = fotosSeleccionadas.concat(validFiles);
        showFotosPreview();
    }
    
    // Función para mostrar preview de archivos (fotos y videos)
    function showFotosPreview() {
        const previewDiv = document.getElementById('fotos-preview');
        const gridDiv = document.getElementById('fotos-grid');
        
        if (fotosSeleccionadas.length === 0) {
            previewDiv.style.display = 'none';
            return;
        }
        
        previewDiv.style.display = 'block';
        gridDiv.innerHTML = '';
        
        fotosSeleccionadas.forEach((file, index) => {
            const isVideo = file.type.startsWith('video/');
            const col = document.createElement('div');
            col.className = 'col-md-3 col-sm-4 col-6';
            
            if (isVideo) {
                // Preview de video
                const videoURL = URL.createObjectURL(file);
                col.innerHTML = `
                    <div class="foto-preview-item">
                        <button type="button" class="foto-preview-remove" onclick="removeFotoPreview(${index})">
                            <i class="fas fa-times"></i>
                        </button>
                        <div style="position: relative; height: 120px; background: #000; display: flex; align-items: center; justify-content: center; border-radius: 8px 8px 0 0;">
                            <video src="${videoURL}" style="max-width: 100%; max-height: 120px;" controls></video>
                        </div>
                        <div class="foto-preview-info">
                            <small class="text-muted"><i class="fas fa-video me-1"></i>${file.name}</small>
                            <small class="text-muted d-block">${(file.size / 1024 / 1024).toFixed(2)} MB</small>
                        </div>
                    </div>
                `;
                gridDiv.appendChild(col);
            } else {
                // Preview de imagen
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    col.innerHTML = `
                        <div class="foto-preview-item">
                            <button type="button" class="foto-preview-remove" onclick="removeFotoPreview(${index})">
                                <i class="fas fa-times"></i>
                            </button>
                            <img src="${e.target.result}" alt="Preview ${index + 1}" class="img-fluid rounded">
                            <div class="foto-preview-info">
                                <small class="text-muted"><i class="fas fa-image me-1"></i>${file.name}</small>
                                <small class="text-muted d-block">${(file.size / 1024 / 1024).toFixed(2)} MB</small>
                            </div>
                        </div>
                    `;
                    gridDiv.appendChild(col);
                };
                
                reader.readAsDataURL(file);
            }
        });
    }
    
    // Función para remover foto
    function removeFotoPreview(index) {
        fotosSeleccionadas.splice(index, 1);
        showFotosPreview();
    }
    
    // Función para validar archivo de imagen individual
    function validateImageFile(input, fieldName) {
        const file = input.files[0];
        if (file) {
            if (!file.type.startsWith('image/')) {
                alert(`Por favor selecciona solo archivos de imagen para la ${fieldName}.`);
                input.value = '';
                return false;
            }
            
            if (file.size > 5 * 1024 * 1024) { // 5MB
                alert(`La ${fieldName} debe ser menor a 5MB.`);
                input.value = '';
                return false;
            }
        }
        return true;
    }
    
    // Modificar el envío del formulario para incluir las fotos adicionales
    form.addEventListener('submit', function(e) {
        // Crear un FormData con todos los datos del formulario
        const formData = new FormData(form);
        
        // Agregar las fotos adicionales al FormData
        fotosSeleccionadas.forEach((file, index) => {
            formData.append('fotos_adicionales', file);
        });
        
        // Enviar el formulario con las fotos
        fetch(form.action, {
            method: 'POST',
            body: formData
        }).then(response => {
            if (response.ok) {
                window.location.href = response.url;
            } else {
                alert('Error al crear la propiedad. Por favor intenta de nuevo.');
            }
        }).catch(error => {
            console.error('Error:', error);
            alert('Error al crear la propiedad. Por favor intenta de nuevo.');
        });
        
        e.preventDefault();
    });
    
    // Asignar iconos dinámicamente a las amenidades
    document.querySelectorAll('[data-icon]').forEach(function(element) {
        const iconClass = element.getAttribute('data-icon');
        element.classList.add(iconClass);
    });
});
</script>
{% endblock %}

