{% extends 'core/base.html' %}
{% load static %}
{% load webp_tags %}

{% block title %}Envío de CV - Tienda Inmobiliaria{% endblock %}

{% block content %}
<!-- Messages outside the entire section -->
{% if messages %}
    <div class="messages">
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        {% endfor %}
    </div>
{% endif %}

<!-- CV Section -->
<section class="cv-application-section">
    <div class="cv-container">
        <div class="cv-layout">
            <!-- Imagen a la izquierda -->
            <div class="cv-image-section">
                <div class="cv-image-container">
                    <picture>
                        <!-- WebP para navegadores modernos -->
                        <source srcset="{% static 'images/CV2.webp' %}" type="image/webp">
                        <!-- Fallback JPG para navegadores antiguos -->
                        <img src="{% static 'images/cv6.jpg' %}" 
                             alt="Equipo de trabajo profesional" 
                             class="cv-image"
                             loading="eager">
                    </picture>
                </div>
            </div>
            
            <!-- Formulario a la derecha -->
            <div class="cv-form-section">
                <div class="cv-header">
                    <h1 class="cv-title">Envíanos tu CV</h1>
                    <h3 class="cv-subtitle">Únete a nuestro equipo</h3>
                    <p class="cv-description">Forma parte de una empresa líder en el sector inmobiliario. Completa el formulario y te contactaremos pronto.</p>
                    
                    <!-- CV Form -->
                    <div class="cv-form-card">
                        
                        <form method="post" enctype="multipart/form-data" id="cvForm">
                            {% csrf_token %}
                            <div class="row g-1">
                                <div class="col-md-6">
                                    <label for="{{ form.nombre_completo.id_for_label }}" class="form-label">
                                        {{ form.nombre_completo.label }} <span class="required">*</span>
                                    </label>
                                    {{ form.nombre_completo }}
                                    {% if form.nombre_completo.errors %}
                                        <div class="invalid-feedback d-block">
                                            {% for error in form.nombre_completo.errors %}
                                                {{ error }}
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                                <div class="col-md-6">
                                    <label for="{{ form.email.id_for_label }}" class="form-label">
                                        {{ form.email.label }} <span class="required">*</span>
                                    </label>
                                    {{ form.email }}
                                    {% if form.email.errors %}
                                        <div class="invalid-feedback d-block">
                                            {% for error in form.email.errors %}
                                                {{ error }}
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <div class="row g-1">
                                <div class="col-md-6">
                                    <label for="{{ form.telefono.id_for_label }}" class="form-label">
                                        {{ form.telefono.label }}
                                    </label>
                                    {{ form.telefono }}
                                    {% if form.telefono.errors %}
                                        <div class="invalid-feedback d-block">
                                            {% for error in form.telefono.errors %}
                                                {{ error }}
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                                <div class="col-md-6">
                                    <label for="{{ form.experiencia.id_for_label }}" class="form-label">
                                        {{ form.experiencia.label }}
                                    </label>
                                    {{ form.experiencia }}
                                    {% if form.experiencia.errors %}
                                        <div class="invalid-feedback d-block">
                                            {% for error in form.experiencia.errors %}
                                                {{ error }}
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <div class="row g-1">
                                <div class="col-md-6">
                                    <label for="{{ form.posicion.id_for_label }}" class="form-label">
                                        {{ form.posicion.label }} <span class="required">*</span>
                                    </label>
                                    {{ form.posicion }}
                                    {% if form.posicion.errors %}
                                        <div class="invalid-feedback d-block">
                                            {% for error in form.posicion.errors %}
                                                {{ error }}
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                                <div class="col-md-6">
                                    <label for="{{ form.cv_file.id_for_label }}" class="form-label">
                                        {{ form.cv_file.label }} <span class="required">*</span>
                                    </label>
                                    {{ form.cv_file }}
                                    {% if form.cv_file.errors %}
                                        <div class="invalid-feedback d-block">
                                            {% for error in form.cv_file.errors %}
                                                {{ error }}
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                    <div class="form-text">Formatos permitidos: PDF, DOC, DOCX (máximo 5MB)</div>
                                </div>
                            </div>
                            
                            <div class="row g-1">
                                <div class="col-12">
                                    <label for="{{ form.mensaje.id_for_label }}" class="form-label">
                                        {{ form.mensaje.label }}
                                    </label>
                                    {{ form.mensaje }}
                                    {% if form.mensaje.errors %}
                                        <div class="invalid-feedback d-block">
                                            {% for error in form.mensaje.errors %}
                                                {{ error }}
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <div class="row g-1">
                                <div class="col-12">
                                    <button type="submit" class="btn btn-cta w-100">
                                        Enviar CV
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Benefits Section -->
<section class="cv-benefits-section">
    <div class="cv-benefits-overlay"></div>
    <div class="cv-benefits-container">
        <div class="cv-benefits-content">
            <h2 class="cv-benefits-title">¿Por qué trabajar con nosotros?</h2>
            <div class="cv-benefits-grid">
                <div class="cv-benefit-item">
                    <div class="cv-benefit-icon">
                        <i class="fas fa-chart-line"></i>
                    </div>
                    <div class="cv-benefit-content">
                        <h5>Crecimiento Profesional</h5>
                        <p>Oportunidades de desarrollo y crecimiento en tu carrera</p>
                    </div>
                </div>
                <div class="cv-benefit-item">
                    <div class="cv-benefit-icon">
                        <i class="fas fa-users"></i>
                    </div>
                    <div class="cv-benefit-content">
                        <h5>Equipo Dinámico</h5>
                        <p>Trabaja con profesionales apasionados y comprometidos</p>
                    </div>
                </div>
                <div class="cv-benefit-item">
                    <div class="cv-benefit-icon">
                        <i class="fas fa-home"></i>
                    </div>
                    <div class="cv-benefit-content">
                        <h5>Sector Inmobiliario</h5>
                        <p>Forma parte del mercado inmobiliario más dinámico</p>
                    </div>
                </div>
                <div class="cv-benefit-item">
                    <div class="cv-benefit-icon">
                        <i class="fas fa-shield-alt"></i>
                    </div>
                    <div class="cv-benefit-content">
                        <h5>Estabilidad</h5>
                        <p>Empresa consolidada con proyección a largo plazo</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>
{% endblock %}

{% block extra_js %}
<script>
// ========================================
// CV FORM ENHANCEMENTS
// ========================================

// Real-time validation setup
function setupRealTimeValidation() {
    const form = document.getElementById('cvForm');
    const inputs = form.querySelectorAll('input, select, textarea');
    
    inputs.forEach(input => {
        // Validación en tiempo real mientras el usuario escribe
        input.addEventListener('input', function() {
            validateField(this);
        });
        
        // Validación al perder el foco
        input.addEventListener('blur', function() {
            validateField(this);
        });
    });
}

// Función de validación individual
function validateField(field) {
    const value = field.value.trim();
    const fieldName = field.name;
    let isValid = true;
    let errorMessage = '';

    // Limpiar validaciones anteriores
    field.classList.remove('is-invalid');
    const existingFeedback = field.parentNode.querySelector('.invalid-feedback');
    if (existingFeedback) {
        existingFeedback.remove();
    }

    // Validaciones específicas por campo
    switch(fieldName) {
        case 'nombre_completo':
            if (value.length < 2) {
                isValid = false;
                errorMessage = 'El nombre debe tener al menos 2 caracteres';
            }
            break;
            
        case 'email':
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(value)) {
                isValid = false;
                errorMessage = 'Ingresa un email válido';
            }
            break;
            
        case 'telefono':
            const phoneRegex = /^[\+]?[1-9][\d]{0,15}$/;
            if (value && !phoneRegex.test(value)) {
                isValid = false;
                errorMessage = 'Ingresa un teléfono válido';
            }
            break;
            
        case 'experiencia':
            if (value && (isNaN(value) || value < 0)) {
                isValid = false;
                errorMessage = 'La experiencia debe ser un número positivo';
            }
            break;
    }

    // Aplicar resultado de validación
    if (!isValid) {
        field.classList.add('is-invalid');
        const feedback = document.createElement('div');
        feedback.className = 'invalid-feedback';
        feedback.textContent = errorMessage;
        field.parentNode.appendChild(feedback);
    }

    return isValid;
}

// Validación del formulario completo
function validateForm() {
    const form = document.getElementById('cvForm');
    const inputs = form.querySelectorAll('input[required], select[required], textarea[required]');
    let isFormValid = true;

    inputs.forEach(input => {
        if (!validateField(input)) {
            isFormValid = false;
        }
    });

    return isFormValid;
}

// Mejorar UX del formulario
function enhanceFormUX() {
    const form = document.getElementById('cvForm');
    const submitBtn = form.querySelector('.btn-cta');
    
    // Animación de carga en envío
    form.addEventListener('submit', function(e) {
        if (!validateForm()) {
            e.preventDefault();
            return false;
        }
        
        submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Enviando...';
        submitBtn.disabled = true;
    });
    
    // Mejorar accesibilidad
    const inputs = form.querySelectorAll('input, select, textarea');
    inputs.forEach(input => {
        input.addEventListener('focus', function() {
            this.parentNode.classList.add('focused');
        });
        
        input.addEventListener('blur', function() {
            this.parentNode.classList.remove('focused');
        });
    });
}

// Inicializar mejoras cuando el DOM esté listo
document.addEventListener('DOMContentLoaded', function() {
    setupRealTimeValidation();
    enhanceFormUX();
});

// Detectar soporte de WebP y aplicar clases correspondientes
function supportsWebP() {
    return new Promise((resolve) => {
        const webP = new Image();
        webP.onload = webP.onerror = function () {
            resolve(webP.height === 2);
        };
        webP.src = 'data:image/webp;base64,UklGRjoAAABXRUJQVlA4IC4AAACyAgCdASoCAAIALmk0mk0iIiIiIgBoSygABc6WWgAA/veff/0PP8bA//LwYAAA';
    });
}

// Detectar soporte de <picture>
function supportsPicture() {
    return 'HTMLPictureElement' in window;
}

// Aplicar clases según el soporte
supportsWebP().then(webpSupported => {
    const container = document.querySelector('.cv-image-container');
    if (container) {
        if (!supportsPicture()) {
            container.parentElement.classList.add('no-picture');
        }
        if (webpSupported) {
            container.classList.add('webp-supported');
        } else {
            container.classList.add('webp-not-supported');
        }
    }
});
</script>
{% endblock %}
