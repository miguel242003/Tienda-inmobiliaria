{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#3b82f6">
    <title>Dashboard Administrativo - Tienda Inmobiliaria</title>
    
    <!-- CDN de TailwindCSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- CDN de Iconos Lucide -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    
    <!-- Configuración de Tailwind -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#eff6ff',
                            100: '#dbeafe',
                            500: '#3b82f6',
                            600: '#2563eb',
                            700: '#1d4ed8',
                            800: '#1e40af',
                            900: '#1e3a8a',
                        }
                    }
                }
            }
        }
    </script>
    
    <!-- Estilos personalizados -->
    <style>
        /* Variables CSS optimizadas */
        :root {
            --color-bajo: #22C55E;
            --color-medio: #F59E0B;
            --color-alto: #EF4444;
            --color-fondo: #e9ecef;
            --sidebar-width: 280px;
            --sidebar-collapsed: 80px;
            --main-margin: 280px;
            --main-margin-collapsed: 80px;
            --transition-duration: 0.3s;
            --transition-easing: ease;
        }
        
        /* Utility classes */
        .hidden {
            display: none !important;
            visibility: hidden !important;
        }
        
        /* Estilos para las barras del gráfico */
        .bar-chart {
            transition: all 0.3s ease;
            border-radius: 0.5rem 0.5rem 0 0;
        }
        
        /* Animaciones suaves */
        .animate-fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Estilos para contadores animados */
        .counter-animation {
            transition: all 0.3s ease;
        }
        
        /* Estilos responsivos mejorados */
        .widget-container {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }
        
        @media (min-width: 1024px) {
            .widget-container {
                flex-direction: row;
            }
        }
        
        /* Estilos para el modal de Nueva Propiedad */
        /* Estilos para el área de upload */
        .upload-area.dragover {
            border-color: #10b981 !important;
            background-color: #d1fae5 !important;
            transform: scale(1.02);
        }

        .upload-content {
            pointer-events: none;
        }

        .upload-content button {
            pointer-events: all;
        }

        /* Estilos para las amenidades */
        .amenidad-checkbox input[type="checkbox"]:checked + label {
            color: #2563eb;
            font-weight: 600;
        }

        .amenidad-checkbox input[type="checkbox"]:checked {
            background-color: #2563eb;
            border-color: #2563eb;
        }

        .amenidad-checkbox input[type="checkbox"]:checked ~ label {
            color: #2563eb;
            font-weight: 600;
        }

        /* Estilos para el preview de fotos adicionales */
        .foto-preview-item {
            position: relative;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            overflow: hidden;
            transition: all 0.3s ease;
            background: white;
        }

        .foto-preview-item:hover {
            border-color: #2563eb;
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.2);
            transform: translateY(-2px);
        }

        .foto-preview-item img {
            width: 100%;
            height: 120px;
            object-fit: cover;
        }

        .foto-preview-info {
            padding: 8px;
            background: rgba(0, 0, 0, 0.05);
            text-align: center;
        }

        .foto-preview-info small {
            font-size: 0.75rem;
            line-height: 1.2;
            color: #6b7280;
        }

        .foto-preview-remove {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(239, 68, 68, 0.9);
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .foto-preview-remove:hover {
            background: rgba(239, 68, 68, 1);
            transform: scale(1.1);
        }

        /* Animación de entrada */
        .foto-preview-item {
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Estilos para campos del formulario Django */
        #crearPropiedadForm input[type="text"],
        #crearPropiedadForm input[type="number"],
        #crearPropiedadForm input[type="file"],
        #crearPropiedadForm select,
        #crearPropiedadForm textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            line-height: 1.25rem;
            color: #111827;
            background-color: #ffffff;
            transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
        }

        #crearPropiedadForm input[type="text"]:focus,
        #crearPropiedadForm input[type="number"]:focus,
        #crearPropiedadForm input[type="file"]:focus,
        #crearPropiedadForm select:focus,
        #crearPropiedadForm textarea:focus {
            outline: none;
            border-color: #2563eb;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        #crearPropiedadForm input[type="text"]:hover,
        #crearPropiedadForm input[type="number"]:hover,
        #crearPropiedadForm select:hover,
        #crearPropiedadForm textarea:hover {
            border-color: #9ca3af;
        }

        /* Estilos para checkboxes de amenidades */
        #crearPropiedadForm input[type="checkbox"] {
            width: 1rem;
            height: 1rem;
            margin-right: 0.5rem;
            border: 1px solid #d1d5db;
            border-radius: 0.25rem;
            background-color: #ffffff;
        }

        #crearPropiedadForm input[type="checkbox"]:checked {
            background-color: #2563eb;
            border-color: #2563eb;
        }

        /* Estilos para el campo de precio con símbolo $ */
        #crearPropiedadForm input[type="number"][id*="precio"] {
            padding-left: 2rem;
        }

        /* Estilos para el campo de metros cuadrados con m² */
        #crearPropiedadForm input[type="number"][id*="metros"] {
            padding-right: 2.5rem;
        }
        
        /* ===== RESPONSIVE STYLES ===== */
        
        /* Sidebar responsive */
        .sidebar {
            width: var(--sidebar-width);
            transition: width var(--transition-duration) var(--transition-easing), 
                        transform var(--transition-duration) var(--transition-easing);
        }
        
        .sidebar.collapsed {
            width: var(--sidebar-collapsed);
        }
        
        .sidebar.collapsed .sidebar-content {
            padding: 1rem 0.75rem;
        }
        
        .sidebar.collapsed .logo-text,
        .sidebar.collapsed .nav-text,
        .sidebar.collapsed .user-text {
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.2s var(--transition-easing), 
                        visibility 0.2s var(--transition-easing);
        }
        
        .sidebar.collapsed .nav-button {
            justify-content: center;
            padding: 0.75rem;
        }
        
        .sidebar.collapsed .nav-button i {
            margin-right: 0;
        }
        
        .sidebar.collapsed .user-info {
            justify-content: center;
        }
        
        .sidebar.collapsed .user-avatar {
            margin-right: 0;
        }
        
        /* Main content responsive */
        .main-content {
            margin-left: var(--main-margin);
            transition: margin-left var(--transition-duration) var(--transition-easing);
        }
        
        .main-content.sidebar-collapsed {
            margin-left: var(--main-margin-collapsed);
        }
        
        /* Tooltips for collapsed sidebar */
        .nav-button[data-tooltip] {
            position: relative;
        }
        
        .nav-button[data-tooltip]:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            left: 100%;
            top: 50%;
            transform: translateY(-50%);
            background: #1f2937;
            color: white;
            padding: 0.5rem 0.75rem;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            white-space: nowrap;
            z-index: 1000;
            margin-left: 0.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        
        .nav-button[data-tooltip]:hover::before {
            content: '';
            position: absolute;
            left: 100%;
            top: 50%;
            transform: translateY(-50%);
            border: 5px solid transparent;
            border-right-color: #1f2937;
            z-index: 1000;
        }
        
        /* Overlay */
        .sidebar-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 40;
            opacity: 0;
            visibility: hidden;
            transition: opacity var(--transition-duration) var(--transition-easing), 
                        visibility var(--transition-duration) var(--transition-easing);
        }
        
        .sidebar-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        
        /* Responsive breakpoints */
        
        /* Mobile (≤640px) */
        @media (max-width: 640px) {
            .sidebar {
                transform: translateX(-100%);
                width: var(--sidebar-width);
            }
            
            .sidebar.open {
                transform: translateX(0);
            }
            
            .sidebar.collapsed {
                width: var(--sidebar-width);
            }
            
            .main-content {
                margin-left: 0;
                width: 100%;
            }
            
            button, .btn {
                min-height: 44px;
                min-width: 44px;
            }
            
            .text-2xl { font-size: 1.5rem; }
            .text-xl { font-size: 1.25rem; }
            .text-lg { font-size: 1.125rem; }
            .p-6 { padding: 1rem; }
            .mb-8 { margin-bottom: 1.5rem; }
            
            .header-content {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.5rem;
            }
            
            .header-actions {
                width: 100%;
                justify-content: space-between;
            }
            
            .nav-button {
                padding: 0.75rem 1rem;
                font-size: 0.875rem;
            }
            
            .user-info {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.5rem;
            }
            
            #sidebar-collapse {
                display: none;
            }
        }
        
        /* Medium screens auto-collapse (641px - 1035px) */
        @media (max-width: 1035px) and (min-width: 641px) {
            .sidebar {
                width: var(--sidebar-collapsed) !important;
            }
            
            .main-content {
                margin-left: var(--main-margin-collapsed) !important;
            }
            
            .sidebar .logo-text,
            .sidebar .nav-text,
            .sidebar .user-text {
                opacity: 0 !important;
                visibility: hidden !important;
            }
            
            .sidebar .nav-button {
                justify-content: center !important;
                padding: 0.75rem !important;
            }
            
            .sidebar .nav-button i {
                margin-right: 0 !important;
            }
            
            .sidebar .user-info {
                justify-content: center !important;
            }
            
            .sidebar .user-avatar {
                margin-right: 0 !important;
            }
            
            #sidebar-collapse {
                display: none !important;
            }
        }
        
        /* Large Desktop (≥1036px) */
        @media (min-width: 1036px) {
            .sidebar {
                width: var(--sidebar-width);
            }
            
            .sidebar.collapsed {
                width: var(--sidebar-collapsed);
            }
            
            .main-content {
                margin-left: var(--main-margin);
            }
            
            .main-content.sidebar-collapsed {
                margin-left: var(--main-margin-collapsed);
            }
            
            #sidebar-collapse {
                display: flex;
            }
        }
        
        /* Interactive elements */
        .widget-card,
        .nav-button,
        button {
            transition: all 0.2s var(--transition-easing);
        }
        
        button:focus,
        .nav-button:focus,
        .form-input:focus {
            outline: 2px solid #3b82f6;
            outline-offset: 2px;
        }
        
        /* Hover effects */
        @media (hover: hover) {
            .widget-card:hover {
                transform: translateY(-2px);
                box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            }
            
            #sidebar-collapse:hover {
                background-color: #f3f4f6;
            }
        }
        
        @media (hover: none) {
            .widget-card:active {
                transform: scale(0.98);
            }
        }
    </style>
    
    <!-- Optimized initialization script -->
    <script>
        // Dashboard initialization and responsive behavior
        (function() {
            'use strict';
            
            // Configuration
            const CONFIG = {
                breakpoints: {
                    mobile: 640,
                    tablet: 1024,
                    desktop: 1035
                },
                sidebar: {
                    width: 280,
                    collapsed: 80
                },
                storage: {
                    key: 'sidebar-collapsed'
                }
            };
            
            // Utility functions
            const utils = {
                getScreenWidth: () => window.innerWidth,
                isLargeScreen: () => utils.getScreenWidth() > CONFIG.breakpoints.desktop,
                isMediumScreen: () => {
                    const width = utils.getScreenWidth();
                    return width > CONFIG.breakpoints.mobile && width <= CONFIG.breakpoints.desktop;
                },
                isMobileScreen: () => utils.getScreenWidth() <= CONFIG.breakpoints.mobile,
                setCSSVariable: (name, value) => {
                    document.documentElement.style.setProperty(name, value);
                }
            };
            
            // Initialize CSS variables based on screen size
            function initializeCSSVariables() {
                const screenWidth = utils.getScreenWidth();
                
                if (utils.isLargeScreen()) {
                    const isCollapsed = localStorage.getItem(CONFIG.storage.key) === 'true';
                    const sidebarWidth = isCollapsed ? CONFIG.sidebar.collapsed : CONFIG.sidebar.width;
                    const mainMargin = isCollapsed ? CONFIG.sidebar.collapsed : CONFIG.sidebar.width;
                    
                    utils.setCSSVariable('--sidebar-width', `${sidebarWidth}px`);
                    utils.setCSSVariable('--main-margin', `${mainMargin}px`);
                } else {
                    utils.setCSSVariable('--sidebar-width', `${CONFIG.sidebar.width}px`);
                    utils.setCSSVariable('--main-margin', utils.isMobileScreen() ? '0px' : `${CONFIG.sidebar.collapsed}px`);
                }
            }
            
            // Initialize on load
            initializeCSSVariables();
            
            // Make functions globally available
            window.DashboardUtils = utils;
            window.DashboardConfig = CONFIG;
        })();
    </script>
</head>
    
<body class="bg-gray-50 min-h-screen">
    <!-- Layout Principal -->
    <div class="flex h-screen">
        
        <!-- Overlay para móvil -->
        <div id="sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-40 lg:hidden hidden"></div>
        
        <!-- Sidebar -->
        <aside id="sidebar" class="fixed lg:relative inset-y-0 left-0 z-50 w-64 sm:w-72 bg-gradient-to-b from-slate-800 to-slate-900 shadow-lg border-r border-slate-700 flex flex-col transform -translate-x-full lg:translate-x-0 transition-transform duration-300 ease-in-out">
            
            <!-- Logo/Header del Sidebar -->
            <header class="p-4 sm:p-6 border-b border-slate-700">
                <div class="flex items-center">
                    <div class="w-8 h-8 sm:w-10 sm:h-10 bg-slate-700 rounded-lg flex items-center justify-center border border-slate-600">
                        <img src="{% static 'images/Logo empresa.jpeg' %}" alt="Logo Empresa" class="w-6 h-6 sm:w-8 sm:h-8 object-contain">
                    </div>
                    <div class="ml-3">
                        <h2 class="text-base sm:text-lg font-semibold text-white">Inmobiliaria</h2>
                        <p class="text-xs sm:text-sm text-slate-300">Admin Panel</p>
                    </div>
                </div>
            </header>
            
            <!-- Navegación -->
            <nav class="flex-1 px-3 sm:px-4 py-4 sm:py-6 space-y-1 sm:space-y-2">
                <button id="btn-inicio" class="flex items-center w-full px-3 sm:px-4 py-2 sm:py-3 text-white bg-gradient-to-r from-blue-500 to-purple-600 rounded-lg transform scale-105 shadow-lg transition-all duration-200">
                    <i data-lucide="home" class="w-4 h-4 sm:w-5 sm:h-5 mr-2 sm:mr-3"></i>
                    <span class="font-medium text-sm sm:text-base">Inicio</span>
                </button>
                
                <button id="btn-nueva-propiedad" class="flex items-center w-full px-3 sm:px-4 py-2 sm:py-3 text-slate-300 hover:text-white hover:bg-gradient-to-r hover:from-blue-500 hover:to-purple-600 hover:scale-105 rounded-lg transition-all duration-200">
                    <i data-lucide="plus-circle" class="w-4 h-4 sm:w-5 sm:h-5 mr-2 sm:mr-3"></i>
                    <span class="font-medium text-sm sm:text-base">Nueva Propiedad</span>
                </button>
                
                <button id="btn-gestionar-propiedades" class="flex items-center w-full px-3 sm:px-4 py-2 sm:py-3 text-slate-300 hover:text-white hover:bg-gradient-to-r hover:from-blue-500 hover:to-purple-600 hover:scale-105 rounded-lg transition-all duration-200">
                    <i data-lucide="list" class="w-4 h-4 sm:w-5 sm:h-5 mr-2 sm:mr-3"></i>
                    <span class="font-medium text-sm sm:text-base">Gestionar Propiedades</span>
                </button>
                
                <button id="btn-nuevo-usuario" class="flex items-center w-full px-3 sm:px-4 py-2 sm:py-3 text-slate-300 hover:text-white hover:bg-gradient-to-r hover:from-blue-500 hover:to-purple-600 hover:scale-105 rounded-lg transition-all duration-200">
                    <i data-lucide="user-plus" class="w-4 h-4 sm:w-5 sm:h-5 mr-2 sm:mr-3"></i>
                    <span class="font-medium text-sm sm:text-base">Nuevo Usuario</span>
                </button>
                
                <button id="btn-gestionar-resenas" class="flex items-center w-full px-3 sm:px-4 py-2 sm:py-3 text-slate-300 hover:text-white hover:bg-gradient-to-r hover:from-blue-500 hover:to-purple-600 hover:scale-105 rounded-lg transition-all duration-200">
                    <i data-lucide="star" class="w-4 h-4 sm:w-5 sm:h-5 mr-2 sm:mr-3"></i>
                    <span class="font-medium text-sm sm:text-base">Reseñas</span>
                </button>
                
                <button id="btn-configuraciones" class="flex items-center w-full px-3 sm:px-4 py-2 sm:py-3 text-slate-300 hover:text-white hover:bg-gradient-to-r hover:from-blue-500 hover:to-purple-600 hover:scale-105 rounded-lg transition-all duration-200">
                    <i data-lucide="settings" class="w-4 h-4 sm:w-5 sm:h-5 mr-2 sm:mr-3"></i>
                    <span class="font-medium text-sm sm:text-base">Configuraciones</span>
                </button>
            </nav>
            
            <!-- Usuario y Logout -->
            <footer class="p-3 sm:p-4 border-t border-gray-200">
                <div class="flex items-center mb-2 sm:mb-3">
                    <div class="w-7 h-7 sm:w-8 sm:h-8 bg-blue-600 rounded-full flex items-center justify-center overflow-hidden">
                        {% if user.admincredentials.foto_perfil %}
                            <img src="{{ user.admincredentials.foto_perfil.url }}" alt="Foto de perfil" class="w-full h-full object-cover">
                        {% else %}
                        <i data-lucide="user" class="w-3 h-3 sm:w-4 sm:h-4 text-white"></i>
                        {% endif %}
                    </div>
                    <div class="ml-2 sm:ml-3">
                        <p class="text-xs sm:text-sm font-medium text-white truncate">{{ user.admincredentials.get_nombre_completo|default:user.username|default:"Administrador" }}</p>
                        <p class="text-xs text-slate-300">Administrador</p>
                    </div>
                </div>
                <a href="{% url 'login:logout' %}" 
                   class="flex items-center w-full px-2 sm:px-3 py-1.5 sm:py-2 text-xs sm:text-sm text-slate-300 hover:text-white hover:bg-gradient-to-r hover:from-red-500 hover:to-red-600 rounded-lg transition-all duration-200">
                    <i data-lucide="log-out" class="w-3 h-3 sm:w-4 sm:h-4 mr-1.5 sm:mr-2"></i>
                    Cerrar Sesión
                </a>
            </footer>
        </aside>
        
        <!-- Immediate sidebar state application -->
        <script>
            // Apply sidebar state immediately based on screen size
            (function() {
                const screenWidth = window.innerWidth;
                const sidebar = document.getElementById('sidebar');
                const mainContent = document.getElementById('main-content');
                const collapseBtn = document.getElementById('sidebar-collapse');
                
                if (screenWidth <= 1035 && screenWidth > 640) {
                    // Medium screens - auto-collapse (CSS handles this, but ensure classes are applied)
                    if (sidebar) {
                        sidebar.classList.add('collapsed');
                    }
                    if (mainContent) {
                        mainContent.classList.add('sidebar-collapsed');
                    }
                    if (collapseBtn) {
                        collapseBtn.style.display = 'none';
                    }
                } else if (screenWidth > 1035) {
                    // Large screens - check localStorage for manual state
                    const isCollapsed = localStorage.getItem('sidebar-collapsed') === 'true';
                    if (isCollapsed) {
                        if (sidebar) {
                            sidebar.classList.add('collapsed');
                        }
                        if (mainContent) {
                            mainContent.classList.add('sidebar-collapsed');
                        }
                        if (collapseBtn) {
                            const icon = collapseBtn.querySelector('i');
                            if (icon) {
                                icon.className = 'fas fa-chevron-right text-gray-600 text-lg';
                            }
                        }
                    }
                }
            })();
        </script>

    <!-- Contenido Principal -->
        <main class="flex-1 flex flex-col overflow-hidden">
            
            <!-- Header Principal -->
            <header class="bg-gradient-to-r from-indigo-600 via-purple-600 to-pink-600 shadow-lg border-b border-purple-500/30 px-4 sm:px-6 py-7 sm:py-9 relative overflow-hidden">
                <!-- Efecto glassmorphism de fondo -->
                <div class="absolute inset-0 bg-gradient-to-r from-indigo-500/20 via-purple-500/20 to-pink-500/20 backdrop-blur-sm"></div>
                <!-- Contenido del header -->
                <div class="relative z-10">
                <div class="flex items-center justify-between">
                    <div class="flex items-center min-w-0 flex-1">
                        <!-- Botón de menú para móvil con glassmorphism -->
                        <button id="sidebar-toggle" class="lg:hidden mr-3 sm:mr-4 p-2 rounded-lg bg-white/10 backdrop-blur-sm text-white hover:bg-white/20 hover:text-white focus:outline-none focus:ring-2 focus:ring-white/30 border border-white/20 transition-all duration-200">
                            <i data-lucide="menu" class="w-5 h-5"></i>
                        </button>
                        <div class="min-w-0 flex-1">
                            <h1 class="text-lg sm:text-xl lg:text-2xl font-bold text-white truncate">Dashboard Administrativo</h1>
                            <p class="text-xs sm:text-sm text-white mt-1 truncate">Bienvenido, {{ user.admincredentials.get_nombre_completo|default:user.username|default:"Administrador" }}</p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-2 sm:space-x-4 ml-2">
                        <!-- Fecha con tarjeta transparente -->
                        <div class="bg-white/10 backdrop-blur-sm rounded-lg px-3 py-2 border border-white/20">
                            <div class="text-xs sm:text-sm text-white flex items-center">
                                <i data-lucide="calendar" class="w-3 h-3 sm:w-4 sm:h-4 inline mr-1"></i>
                                <span id="currentDateFull" class="hidden xl:inline"></span>
                                <span id="currentDateMedium" class="hidden lg:inline xl:hidden"></span>
                                <span id="currentDateShort" class="hidden md:inline lg:hidden"></span>
                                <span id="currentDateMinimal" class="inline md:hidden"></span>
                            </div>
                        </div>
                    </div>
                </div>
                </div>
            </header>

            <!-- Contenido Principal -->
            <div class="flex-1 overflow-y-auto p-3 sm:p-4 lg:p-6" style="background-color: #e5e7eb;">
                
                <!-- Contenido del Dashboard (por defecto) -->
                <div id="dashboard-content">
                    <!-- Widgets principales en fila -->
                <section class="mb-6 sm:mb-8">
                        <div class="widget-container">
                            
                            <!-- Widget de Clics en Ver Detalle (60%) -->
                            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-4 sm:p-6 animate-fade-in" style="flex: 0 0 60%;">
                        <!-- Header del Widget -->
                        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-6">
                            <h2 class="text-lg sm:text-xl font-semibold text-gray-900 mb-4 sm:mb-0">
                                Clics en Ver Detalle por Mes
                            </h2>
                            
                            <!-- Selector de Propiedad -->
                            <div class="flex items-center space-x-2">
                                <label for="propiedad-select" class="text-sm font-medium text-gray-700">Propiedad:</label>
                                <select id="propiedad-select" class="px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white">
                                    <option value="todas">Todas las Propiedades</option>
                                    {% for propiedad in todas_propiedades %}
                                    <option value="{{ propiedad.id }}">{{ propiedad.titulo }}</option>
                                    {% endfor %}
                                </select>
                        </div>
                        </div>
                        
                        <!-- Gráfico de Barras -->
                        <div class="relative">
                            <!-- Título del Gráfico -->
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-sm font-medium text-gray-600">Clics Mensuales</h3>
                                <div class="text-right">
                                        <div class="text-2xl font-bold text-blue-600 counter-animation" id="total-clicks">{{ total_clicks|default:"0" }}</div>
                                    <div class="text-xs text-gray-500">Total este año</div>
                    </div>
                </div>
                
                            <!-- Gráfico de Barras Verticales -->
                            <div class="h-64 flex items-end justify-between space-x-1 sm:space-x-2 px-2" id="grafico-barras">
                                {% for mes_data in clicks_por_mes %}
                                <div class="flex flex-col items-center flex-1">
                                    <div class="w-full bg-gray-100 rounded-t-lg relative overflow-hidden mb-2" style="height: 120px;">
                                            <div class="bar-chart w-full absolute bottom-0" 
                                                 style="height: 0%;" 
                                                 data-value="{{ mes_data.clicks }}"></div>
                                        <div class="absolute inset-0 flex items-center justify-center text-xs font-semibold text-white">{{ mes_data.clicks }}</div>
                                    </div>
                                    <div class="text-xs text-gray-600 font-medium">{{ mes_data.mes }}</div>
                                </div>
                                {% endfor %}
                            </div>
                            
                            <!-- Leyenda -->
                            <div class="mt-4 pt-4 border-t border-gray-200">
                                <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between text-xs text-gray-500 space-y-2 sm:space-y-0">
                                    <div class="flex items-center space-x-4">
                                        <div class="flex items-center space-x-2">
                                                <div class="w-3 h-3 rounded-full" style="background: linear-gradient(to right, var(--color-bajo), var(--color-medio), var(--color-alto));"></div>
                                            <span>Escala de Calor</span>
                                        </div>
                                        <div class="flex items-center space-x-1">
                                                <span class="text-green-600 font-medium">0-60</span>
                                            <span>→</span>
                                                <span class="text-yellow-600 font-medium">61-150</span>
                                            <span>→</span>
                                                <span class="text-red-600 font-medium">151+</span>
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        <span id="leyenda-maximo">Máximo: 170 clics (Junio)</span>
                        </div>
                        </div>
                    </div>
                </div>
            </div>
            
                        <!-- Tarjeta de Formularios de Contacto (40%) -->
                        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-4 sm:p-6 animate-fade-in" style="flex: 0 0 40%;">
                <!-- Header de la Tarjeta -->
                <div class="text-center mb-6">
                    <!-- Icono Principal -->
                    <div class="w-16 h-16 bg-gradient-to-br from-blue-500 to-green-500 rounded-full flex items-center justify-center mx-auto mb-4 shadow-lg">
                        <i data-lucide="mail" class="w-8 h-8 text-white"></i>
                    </div>
                    
                    <!-- Título -->
                    <h2 class="text-lg sm:text-xl font-semibold text-gray-900 mb-2">
                        Formularios Recibidos
                    </h2>
                    <p class="text-sm text-gray-600">Contactos e interés en propiedades</p>
                </div>
                
                <!-- Contador Principal -->
                <div class="text-center mb-6">
                                <div class="text-4xl sm:text-5xl font-bold bg-gradient-to-r from-blue-600 to-green-600 bg-clip-text text-transparent mb-2 counter-animation" id="total-formularios">
                        1,247
                        </div>
                    <div class="flex items-center justify-center space-x-2 text-sm text-gray-600">
                        <i data-lucide="trending-up" class="w-4 h-4 text-green-500"></i>
                        <span>+18% este mes</span>
                    </div>
                </div>
                
                <!-- Estadísticas Detalladas -->
                <div class="space-y-3 mb-6">
                    <!-- Formularios de Contacto -->
                    <div class="flex items-center justify-between p-3 bg-blue-50 rounded-lg">
                        <div class="flex items-center">
                            <div class="w-8 h-8 bg-blue-100 rounded-lg flex items-center justify-center mr-3">
                                <i data-lucide="user-plus" class="w-4 h-4 text-blue-600"></i>
                            </div>
                            <div>
                                <p class="text-sm font-medium text-gray-900">Contacto General</p>
                                <p class="text-xs text-gray-600">Formularios de contacto</p>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="text-lg font-bold text-blue-600">892</div>
                        </div>
                    </div>
                    
                    <!-- Interés en Propiedades -->
                    <div class="flex items-center justify-between p-3 bg-green-50 rounded-lg">
                        <div class="flex items-center">
                            <div class="w-8 h-8 bg-green-100 rounded-lg flex items-center justify-center mr-3">
                                <i data-lucide="heart" class="w-4 h-4 text-green-600"></i>
                            </div>
                            <div>
                                <p class="text-sm font-medium text-gray-900">Interés en Propiedades</p>
                                <p class="text-xs text-gray-600">Solicitudes específicas</p>
                    </div>
                </div>
                        <div class="text-right">
                            <div class="text-lg font-bold text-green-600">355</div>
                        </div>
                    </div>
                    </div>
                </div>
            </div>
        </section>

                <!-- Tarjetas de Estadísticas -->
                <section class="mb-6 sm:mb-8">
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 sm:gap-6">
                        
                        <!-- Total Propiedades -->
                        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4 sm:p-6 hover:shadow-md transition-all duration-200 animate-fade-in">
                            <div class="flex items-center">
                                <div class="w-10 h-10 sm:w-12 sm:h-12 bg-blue-100 rounded-lg flex items-center justify-center mr-3 sm:mr-4">
                                    <i data-lucide="home" class="w-5 h-5 sm:w-6 sm:h-6 text-blue-600"></i>
                                </div>
                                <div class="min-w-0 flex-1">
                                    <div class="text-xl sm:text-2xl font-bold text-gray-900 mb-1 counter-animation" id="totalProperties">{{ total_propiedades|default:"0" }}</div>
                                    <div class="text-xs sm:text-sm text-gray-600">Total Propiedades</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Total Usuarios -->
                        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4 sm:p-6 hover:shadow-md transition-all duration-200 animate-fade-in">
                            <div class="flex items-center">
                                <div class="w-10 h-10 sm:w-12 sm:h-12 bg-green-100 rounded-lg flex items-center justify-center mr-3 sm:mr-4">
                                    <i data-lucide="users" class="w-5 h-5 sm:w-6 sm:h-6 text-green-600"></i>
                                </div>
                                <div class="min-w-0 flex-1">
                                    <div class="text-xl sm:text-2xl font-bold text-gray-900 mb-1 counter-animation" id="totalUsers">{{ staff_users|default:"0" }}</div>
                                    <div class="text-xs sm:text-sm text-gray-600">Total Usuarios</div>
                                </div>
                            </div>
                </div>
                        
                        <!-- Total Reseñas -->
                        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4 sm:p-6 hover:shadow-md transition-all duration-200 animate-fade-in sm:col-span-2 lg:col-span-1">
                            <div class="flex items-center">
                                <div class="w-10 h-10 sm:w-12 sm:h-12 bg-yellow-100 rounded-lg flex items-center justify-center mr-3 sm:mr-4">
                                    <i data-lucide="star" class="w-5 h-5 sm:w-6 sm:h-6 text-yellow-600"></i>
                                </div>
                                <div class="min-w-0 flex-1">
                                    <div class="text-xl sm:text-2xl font-bold text-gray-900 mb-1 counter-animation" id="totalReviews">{{ total_resenas|default:"0" }}</div>
                                    <div class="text-xs sm:text-sm text-gray-600">Total Reseñas</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Actividades Recientes -->
                <section>
                    <div class="bg-white rounded-lg shadow-sm border border-gray-200 animate-fade-in">
                        <div class="px-4 sm:px-6 py-3 sm:py-4 border-b border-gray-200">
                            <div class="flex items-center justify-between">
                                <h2 class="text-base sm:text-lg font-semibold text-gray-900 flex items-center">
                                    <i data-lucide="activity" class="w-4 h-4 sm:w-5 sm:h-5 text-blue-600 mr-2"></i>
                                    Actividades Recientes
                                </h2>
                                <button id="btn-refrescar-actividades" class="text-gray-500 hover:text-blue-600 transition-colors" title="Actualizar actividades">
                                    <i data-lucide="refresh-cw" class="w-4 h-4"></i>
                                </button>
                            </div>
                        </div>
                        <div class="p-4 sm:p-6">
                            <div id="actividades-container" class="space-y-3">
                                <!-- Las actividades se cargarán dinámicamente aquí -->
                                <div class="text-center py-8">
                                    <div class="w-12 h-12 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-3">
                                        <i data-lucide="activity" class="w-6 h-6 text-gray-400"></i>
                                    </div>
                                    <p class="text-sm text-gray-500">Cargando actividades...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>
                </div>
                
                <!-- Contenido de Gestión de Propiedades (oculto por defecto) -->
                <div id="gestion-propiedades-content" class="hidden">
                    <!-- Header de Gestión -->
                    <div class="mb-6">
                        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between">
                            <div>
                                <h1 class="text-2xl font-bold text-gray-900 mb-2">
                                    Gestionar Propiedades
                                </h1>
                                <p class="text-gray-600">Administra todas las propiedades del catálogo</p>
                            </div>
                            <div class="mt-4 sm:mt-0 flex gap-2">
                                <button id="btn-volver-inicio-gestion" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition-colors">
                                    <i data-lucide="arrow-left" class="w-4 h-4 mr-2"></i>
                                    Volver al Inicio
                                </button>
                                <button id="btn-nueva-propiedad-gestion" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                                    <i data-lucide="plus" class="w-4 h-4 mr-2"></i>
                                    Nueva Propiedad
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Tabla de Propiedades -->
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200">
                        <div class="p-6 border-b border-gray-200">
                            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between">
                                <div>
                                    <h3 class="text-lg font-semibold text-gray-900 flex items-center">
                                        <i data-lucide="list" class="w-5 h-5 mr-2 text-blue-600"></i>
                                        Lista de Propiedades (<span id="propiedades-count">{{ total_propiedades|default:"0" }}</span>)
                                    </h3>
                                </div>
                                <div class="mt-4 sm:mt-0">
                                    <div class="relative">
                                        <input type="text" id="searchInput" placeholder="Buscar propiedades..." 
                                               class="w-full sm:w-64 pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                        <i data-lucide="search" class="w-4 h-4 absolute left-3 top-3 text-gray-400"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="overflow-x-auto">
                            <table class="w-full" id="propertiesTable">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Imagen</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Título</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tipo</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Precio</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Estado</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ubicación</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fecha</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Acciones</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200" id="propertiesTableBody">
                                    {% for propiedad in propiedades_recientes %}
                                    <tr data-propiedad-id="{{ propiedad.id }}" class="hover:bg-gray-50">
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            {% if propiedad.imagen_principal %}
                                                <img src="{{ propiedad.imagen_principal.url }}" alt="{{ propiedad.titulo }}" 
                                                     class="w-12 h-12 rounded-lg object-cover">
                                            {% else %}
                                                <div class="w-12 h-12 bg-gray-100 rounded-lg flex items-center justify-center">
                                                    <i data-lucide="home" class="w-5 h-5 text-gray-400"></i>
                                                </div>
                                            {% endif %}
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <div>
                                                <div class="text-sm font-medium text-gray-900">{{ propiedad.titulo }}</div>
                                                <div class="text-sm text-gray-500">{{ propiedad.metros_cuadrados }} m²</div>
                                            </div>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-blue-100 text-blue-800">
                                                {{ propiedad.get_tipo_display }}
                                            </span>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <div class="text-sm font-medium text-green-600">{{ propiedad.get_precio_formateado }}</div>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            {% if propiedad.estado == 'disponible' %}
                                                <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800">
                                                    {{ propiedad.get_estado_display }}
                                                </span>
                                            {% elif propiedad.estado == 'vendida' %}
                                                <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-red-100 text-red-800">
                                                    {{ propiedad.get_estado_display }}
                                                </span>
                                            {% else %}
                                                <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-yellow-100 text-yellow-800">
                                                    {{ propiedad.get_estado_display }}
                                                </span>
                                            {% endif %}
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                            {{ propiedad.ubicacion }}
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                            {{ propiedad.fecha_creacion|date:"d/m/Y" }}
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                            <div class="flex space-x-2">
                                                <a href="{% url 'propiedades:detalle' propiedad.id %}" 
                                                   class="text-blue-600 hover:text-blue-900" title="Ver detalles">
                                                    <i data-lucide="eye" class="w-4 h-4"></i>
                                                </a>
                                                <a href="{% url 'login:editar_propiedad' propiedad.id %}" 
                                                   class="text-yellow-600 hover:text-yellow-900" title="Editar">
                                                    <i data-lucide="edit" class="w-4 h-4"></i>
                                                </a>
                                                <button type="button" class="text-red-600 hover:text-red-900" 
                                                        onclick="confirmarEliminar({{ propiedad.id }}, '{{ propiedad.titulo }}')" 
                                                        title="Eliminar">
                                                    <i data-lucide="trash-2" class="w-4 h-4"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                    {% empty %}
                                    <tr>
                                        <td colspan="8" class="px-6 py-12 text-center">
                                            <div class="text-gray-500">
                                                <i data-lucide="home" class="w-12 h-12 mx-auto mb-4 text-gray-300"></i>
                                                <h3 class="text-lg font-medium text-gray-900 mb-2">No hay propiedades registradas</h3>
                                                <p class="text-gray-500 mb-4">Comienza agregando tu primera propiedad al catálogo.</p>
                                                <button id="btn-agregar-primera-propiedad" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                                                    <i data-lucide="plus" class="w-4 h-4 mr-2"></i>
                                                    Agregar Primera Propiedad
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- Contenido de Configuraciones (oculto por defecto) -->
                <div id="configuraciones-content" class="hidden">
                    <!-- Header de Configuraciones -->
                    <div class="mb-6">
                        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between">
                            <div>
                                <h1 class="text-2xl font-bold text-gray-900 mb-2">
                                    Configuraciones
                                </h1>
                                <p class="text-gray-600">Gestiona tu perfil y configuraciones de cuenta</p>
                            </div>
                            <div class="mt-4 sm:mt-0">
                                <button id="btn-volver-inicio-config" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition-colors">
                                    <i data-lucide="arrow-left" class="w-4 h-4 mr-2"></i>
                                    Volver al Inicio
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Formulario de Configuración de Perfil -->
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200">
                        <div class="p-6 border-b border-gray-200">
                            <h3 class="text-lg font-semibold text-gray-900 flex items-center">
                                <i data-lucide="user" class="w-5 h-5 mr-2 text-blue-600"></i>
                                Configuración de Perfil
                            </h3>
                        </div>
                        
                        <div class="p-6">
                            <!-- DEBUG: Datos del usuario -->
                            <!-- Nombre: {{ user.admincredentials.nombre|default:"No definido" }} -->
                            <!-- Apellido: {{ user.admincredentials.apellido|default:"No definido" }} -->
                            <!-- Teléfono: {{ user.admincredentials.telefono|default:"No definido" }} -->
                            <!-- Fecha: {{ user.admincredentials.fecha_nacimiento|default:"No definido" }} -->
                            
                            <form id="configuracion-perfil-form" method="post" enctype="multipart/form-data">
                                {% csrf_token %}
                                
                                <!-- Foto de Perfil -->
                                <div class="mb-8">
                                    <label class="block text-sm font-semibold text-gray-700 mb-4">
                                        <i data-lucide="camera" class="w-4 h-4 mr-2 text-blue-600"></i>
                                        Foto de Perfil
                                    </label>
                                    
                                    <div class="flex items-center space-x-6">
                                        <!-- Preview de la foto actual -->
                                        <div class="relative">
                                            <div id="foto-perfil-preview" class="w-24 h-24 bg-gray-100 rounded-full flex items-center justify-center overflow-hidden">
                                                {% if user.admincredentials.foto_perfil %}
                                                    <img src="{{ user.admincredentials.foto_perfil.url }}" alt="Foto de perfil" class="w-full h-full object-cover">
                                                {% else %}
                                                    <i data-lucide="user" class="w-8 h-8 text-gray-400"></i>
                                                {% endif %}
                                            </div>
                                            <button type="button" id="btn-cambiar-foto" class="absolute -bottom-1 -right-1 w-8 h-8 bg-blue-600 text-white rounded-full flex items-center justify-center hover:bg-blue-700 transition-colors">
                                                <i data-lucide="camera" class="w-4 h-4"></i>
                                            </button>
                                        </div>
                                        
                                        <div class="flex-1">
                                            <input type="file" id="foto-perfil-input" name="foto_perfil" accept="image/*" class="hidden">
                                            <div class="text-sm text-gray-600">
                                                <p class="font-medium">Cambiar foto de perfil</p>
                                                <p class="text-gray-500">JPG, PNG o GIF. Máximo 5MB</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Información Personal -->
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                                    <div>
                                        <label for="nombre" class="block text-sm font-semibold text-gray-700 mb-2">
                                            Nombre
                                        </label>
                                        <input type="text" id="nombre" name="nombre" 
                                               value="{{ user.admincredentials.nombre|default:user.first_name }}" 
                                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                    </div>
                                    
                                    <div>
                                        <label for="apellido" class="block text-sm font-semibold text-gray-700 mb-2">
                                            Apellido
                                        </label>
                                        <input type="text" id="apellido" name="apellido" 
                                               value="{{ user.admincredentials.apellido|default:user.last_name }}" 
                                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                    </div>
                                </div>

                                <!-- Email (solo lectura) -->
                                <div class="mb-6">
                                    <label for="email" class="block text-sm font-semibold text-gray-700 mb-2">
                                        <i data-lucide="mail" class="w-4 h-4 mr-2 text-blue-600"></i>
                                        Correo Electrónico
                                    </label>
                                    <input type="email" id="email" name="email" 
                                           value="{{ user.email }}" 
                                           readonly
                                           class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-50 text-gray-600">
                                    <p class="text-xs text-gray-500 mt-1">El correo electrónico no se puede modificar</p>
                                </div>

                                <!-- Información Adicional -->
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                                    <div>
                                        <label for="telefono" class="block text-sm font-semibold text-gray-700 mb-2">
                                            <i data-lucide="phone" class="w-4 h-4 mr-2 text-blue-600"></i>
                                            Teléfono
                                        </label>
                                        <input type="tel" id="telefono" name="telefono" 
                                               value="{{ user.admincredentials.telefono|default:'' }}" 
                                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                    </div>
                                    
                                    <div>
                                        <label for="fecha_nacimiento" class="block text-sm font-semibold text-gray-700 mb-2">
                                            <i data-lucide="calendar" class="w-4 h-4 mr-2 text-blue-600"></i>
                                            Fecha de Nacimiento
                                        </label>
                                        <input type="date" id="fecha_nacimiento" name="fecha_nacimiento" 
                                               value="{% if user.admincredentials.fecha_nacimiento %}{{ user.admincredentials.fecha_nacimiento|date:'Y-m-d' }}{% endif %}" 
                                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                    </div>
                                </div>

                                <!-- Botones de Acción -->
                                <div class="flex flex-col sm:flex-row gap-4 justify-end">
                                    <button type="button" id="cancelar-config" class="px-6 py-3 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors">
                                        <i data-lucide="x" class="w-4 h-4 mr-2"></i>
                                        Cancelar
                                    </button>
                                    <button type="submit" class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                                        <i data-lucide="save" class="w-4 h-4 mr-2"></i>
                                        Guardar Cambios
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>

                    <!-- Sección de Cambio de Contraseña -->
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 mt-6">
                        <div class="p-6 border-b border-gray-200">
                            <h3 class="text-lg font-semibold text-gray-900 flex items-center">
                                <i data-lucide="lock" class="w-5 h-5 mr-2 text-blue-600"></i>
                                Cambiar Contraseña
                            </h3>
                        </div>
                        
                        <div class="p-6">
                            <!-- Messages para cambio de contraseña -->
                            <div id="password-messages" class="hidden mb-4"></div>
                            
                            <form id="cambiar-password-form" method="post">
                                {% csrf_token %}
                                
                                <!-- Contraseña Actual -->
                                <div class="mb-6">
                                    <label for="password_actual" class="block text-sm font-semibold text-gray-700 mb-2">
                                        <i data-lucide="key" class="w-4 h-4 mr-2 text-blue-600"></i>
                                        Contraseña Actual
                                    </label>
                                    <div class="relative">
                                        <input type="password" id="password_actual" name="password_actual" 
                                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 pr-10"
                                               placeholder="Ingresa tu contraseña actual" required>
                                        <button type="button" class="absolute inset-y-0 right-0 pr-3 flex items-center" onclick="togglePasswordVisibility('password_actual')">
                                            <i data-lucide="eye" class="w-4 h-4 text-gray-400"></i>
                                        </button>
                                    </div>
                                </div>

                                <!-- Nueva Contraseña -->
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                                    <div>
                                        <label for="nueva_password" class="block text-sm font-semibold text-gray-700 mb-2">
                                            <i data-lucide="lock" class="w-4 h-4 mr-2 text-blue-600"></i>
                                            Nueva Contraseña
                                        </label>
                                        <div class="relative">
                                            <input type="password" id="nueva_password" name="nueva_password" 
                                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 pr-10"
                                                   placeholder="Ingresa nueva contraseña" required>
                                            <button type="button" class="absolute inset-y-0 right-0 pr-3 flex items-center" onclick="togglePasswordVisibility('nueva_password')">
                                                <i data-lucide="eye" class="w-4 h-4 text-gray-400"></i>
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <div>
                                        <label for="confirmar_nueva_password" class="block text-sm font-semibold text-gray-700 mb-2">
                                            <i data-lucide="lock" class="w-4 h-4 mr-2 text-blue-600"></i>
                                            Confirmar Nueva Contraseña
                                        </label>
                                        <div class="relative">
                                            <input type="password" id="confirmar_nueva_password" name="confirmar_nueva_password" 
                                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 pr-10"
                                                   placeholder="Confirma nueva contraseña" required>
                                            <button type="button" class="absolute inset-y-0 right-0 pr-3 flex items-center" onclick="togglePasswordVisibility('confirmar_nueva_password')">
                                                <i data-lucide="eye" class="w-4 h-4 text-gray-400"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <!-- Opción de Recuperación por SMS -->
                                <div class="mb-6">
                                    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                                        <div class="flex items-start">
                                            <i data-lucide="smartphone" class="w-5 h-5 text-yellow-600 mr-3 mt-0.5"></i>
                                            <div class="flex-1">
                                                <h4 class="text-sm font-semibold text-yellow-800 mb-2">¿No recuerdas tu contraseña actual?</h4>
                                                <p class="text-sm text-yellow-700 mb-3">
                                                    Te enviaremos un código de verificación al número: 
                                                    <strong>{{ user.admincredentials.telefono|default:"No registrado" }}</strong>
                                                </p>
                                                <button type="button" id="btn-enviar-sms" class="bg-yellow-600 text-white px-4 py-2 rounded-lg hover:bg-yellow-700 transition-colors text-sm">
                                                    <i data-lucide="send" class="w-4 h-4 mr-2"></i>
                                                    Enviar Código por SMS
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Campo para código SMS (oculto inicialmente) -->
                                <div id="sms-verification-section" class="mb-6 hidden">
                                    <label for="codigo_sms" class="block text-sm font-semibold text-gray-700 mb-2">
                                        <i data-lucide="message-square" class="w-4 h-4 mr-2 text-blue-600"></i>
                                        Código de Verificación SMS
                                    </label>
                                    <div class="flex items-center space-x-3">
                                        <input type="text" id="codigo_sms" name="codigo_sms" 
                                               class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                               placeholder="Ingresa el código de 6 dígitos" maxlength="6">
                                        <button type="button" id="btn-verificar-sms" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors">
                                            <i data-lucide="check" class="w-4 h-4 mr-2"></i>
                                            Verificar
                                        </button>
                                    </div>
                                    <p class="text-xs text-gray-500 mt-2">
                                        <i data-lucide="clock" class="w-3 h-3 mr-1"></i>
                                        El código expira en <span id="sms-timer">5:00</span>
                                    </p>
                                </div>

                                <!-- Botones de Acción -->
                                <div class="flex flex-col sm:flex-row gap-4 justify-end">
                                    <button type="button" id="cancelar-password" class="px-6 py-3 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors">
                                        <i data-lucide="x" class="w-4 h-4 mr-2"></i>
                                        Cancelar
                                    </button>
                                    <button type="submit" id="btn-cambiar-password" class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors" disabled>
                                        <i data-lucide="key" class="w-4 h-4 mr-2"></i>
                                        Cambiar Contraseña
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
                
                <!-- Contenido de Gestión de Reseñas (oculto por defecto) -->
                <div id="gestion-resenas-content" class="hidden">
                    <!-- Header de Gestión de Reseñas -->
                    <div class="mb-4 sm:mb-6">
                        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between">
                            <div class="mb-3 sm:mb-0">
                                <h1 class="text-xl sm:text-2xl font-bold text-gray-900 mb-1 sm:mb-2">
                                    Gestión de Reseñas
                                </h1>
                                <p class="text-sm sm:text-base text-gray-600">Modera y administra las reseñas de propiedades</p>
                            </div>
                            <div class="mt-2 sm:mt-0">
                                <button id="btn-volver-inicio-resenas" class="w-full sm:w-auto bg-gray-500 text-white px-3 sm:px-4 py-2 sm:py-2 rounded-lg hover:bg-gray-600 transition-colors text-sm sm:text-base">
                                    <i data-lucide="arrow-left" class="w-4 h-4 mr-1 sm:mr-2"></i>
                                    Volver al Inicio
                                </button>
                            </div>
                        </div>
                    </div>


                    <!-- Filtros de Reseñas -->
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 mb-4 sm:mb-6">
                        <div class="p-4 sm:p-6 border-b border-gray-200">
                            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between">
                                <h3 class="text-base sm:text-lg font-semibold text-gray-900 flex items-center mb-3 sm:mb-0">
                                    <i data-lucide="filter" class="w-4 h-4 sm:w-5 sm:h-5 mr-2 text-blue-600"></i>
                                    Filtros
                                </h3>
                                
                                <!-- Estadísticas pequeñas -->
                                <div class="flex items-center space-x-4 sm:space-x-6">
                                    <!-- En Espera -->
                                    <div class="flex items-center">
                                        <div class="w-6 h-6 bg-yellow-100 rounded-full flex items-center justify-center mr-1.5">
                                            <i data-lucide="clock" class="w-3 h-3 text-yellow-600"></i>
                                        </div>
                                        <div>
                                            <div class="text-sm font-bold text-gray-900" id="resenasEspera">{{ resenas_espera|default:"0" }}</div>
                                            <div class="text-xs text-gray-500">Espera</div>
                                        </div>
                                    </div>

                                    <!-- Aceptadas -->
                                    <div class="flex items-center">
                                        <div class="w-6 h-6 bg-green-100 rounded-full flex items-center justify-center mr-1.5">
                                            <i data-lucide="check-circle" class="w-3 h-3 text-green-600"></i>
                                        </div>
                                        <div>
                                            <div class="text-sm font-bold text-gray-900" id="resenasAceptadas">{{ resenas_aceptadas|default:"0" }}</div>
                                            <div class="text-xs text-gray-500">Aceptadas</div>
                                        </div>
                                    </div>

                                    <!-- Rechazadas -->
                                    <div class="flex items-center">
                                        <div class="w-6 h-6 bg-red-100 rounded-full flex items-center justify-center mr-1.5">
                                            <i data-lucide="x-circle" class="w-3 h-3 text-red-600"></i>
                                        </div>
                                        <div>
                                            <div class="text-sm font-bold text-gray-900" id="resenasRechazadas">{{ resenas_rechazadas|default:"0" }}</div>
                                            <div class="text-xs text-gray-500">Rechazadas</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="p-4 sm:p-6">
                            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3 sm:gap-4">
                                <div>
                                    <label for="filtro-estado" class="block text-xs sm:text-sm font-semibold text-gray-700 mb-1 sm:mb-2">Estado</label>
                                    <select id="filtro-estado" class="w-full px-3 py-2 sm:py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm sm:text-base">
                                        <option value="todos">Todos los estados</option>
                                        <option value="pendiente">Pendientes</option>
                                        <option value="aprobada">Aprobadas</option>
                                        <option value="rechazada">Rechazadas</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="filtro-propiedad" class="block text-xs sm:text-sm font-semibold text-gray-700 mb-1 sm:mb-2">Propiedad</label>
                                    <select id="filtro-propiedad" class="w-full px-3 py-2 sm:py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm sm:text-base">
                                        <option value="todas">Todas las propiedades</option>
                                        {% for propiedad in todas_propiedades %}
                                        <option value="{{ propiedad.id }}">{{ propiedad.titulo }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="sm:col-span-2 lg:col-span-1">
                                    <label for="filtro-calificacion" class="block text-xs sm:text-sm font-semibold text-gray-700 mb-1 sm:mb-2">Calificación</label>
                                    <select id="filtro-calificacion" class="w-full px-3 py-2 sm:py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm sm:text-base">
                                        <option value="todas">Todas las calificaciones</option>
                                        <option value="5">5 estrellas</option>
                                        <option value="4">4 estrellas</option>
                                        <option value="3">3 estrellas</option>
                                        <option value="2">2 estrellas</option>
                                        <option value="1">1 estrella</option>
                                    </select>
                                </div>
                            </div>
                            
                            <!-- Botón para limpiar filtros -->
                            <div class="mt-4 flex justify-end">
                                <button id="btn-limpiar-filtros" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition-colors text-sm">
                                    <i data-lucide="x" class="w-4 h-4 mr-2"></i>
                                    Limpiar Filtros
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Lista de Reseñas -->
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200">
                        <div class="p-4 sm:p-6 border-b border-gray-200">
                            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between">
                                <div class="mb-3 sm:mb-0">
                                    <h3 class="text-base sm:text-lg font-semibold text-gray-900 flex items-center">
                                        <i data-lucide="star" class="w-4 h-4 sm:w-5 sm:h-5 mr-2 text-blue-600"></i>
                                        Reseñas (<span id="resenas-count">0</span>)
                                    </h3>
                                </div>
                                <div class="mt-2 sm:mt-0">
                                    <button id="btn-refrescar-resenas" class="w-full sm:w-auto bg-blue-600 text-white px-3 sm:px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors text-sm">
                                        <i data-lucide="refresh-cw" class="w-4 h-4 mr-1 sm:mr-2"></i>
                                        Refrescar
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div id="resenas-list" class="p-4 sm:p-6">
                            <div class="text-center py-6 sm:py-8 text-gray-500">
                                <i data-lucide="star" class="w-8 h-8 sm:w-12 sm:h-12 mx-auto mb-3 sm:mb-4 text-gray-300"></i>
                                <p class="text-sm sm:text-base">Cargando reseñas...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
    </main>
                                </div>
                                

    <!-- Modal Nueva Propiedad -->
    <div id="modal-nueva-propiedad" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-xl shadow-2xl w-full max-w-6xl max-h-[90vh] overflow-hidden">
                <!-- Header del Modal -->
                <div class="flex items-center justify-between p-6 border-b border-gray-200 bg-blue-600 text-white">
                    <div>
                        <h2 class="text-xl font-bold">Crear Nueva Propiedad</h2>
                        <p class="text-blue-100">Agrega una nueva propiedad al catálogo inmobiliario</p>
                    </div>
                    <button id="cerrar-modal" class="text-white hover:text-blue-200 transition-colors">
                        <i data-lucide="x" class="w-6 h-6"></i>
                    </button>
        </div>
        
                <!-- Contenido del Modal -->
                <div class="overflow-y-auto max-h-[calc(90vh-120px)]">
                    <div class="p-6">
                        <!-- Messages -->
                        <div id="modal-messages" class="hidden"></div>

                        <form method="post" enctype="multipart/form-data" id="crearPropiedadForm" action="{% url 'propiedades:crear' %}">
                            {% csrf_token %}
                            
                            <!-- Título y Descripción -->
                            <div class="grid grid-cols-1 gap-6 mb-6">
                                <div>
                                    <label for="{{ form.titulo.id_for_label }}" class="block text-sm font-semibold text-gray-700 mb-2">
                                        {{ form.titulo.label }}
                                    </label>
                                    {{ form.titulo }}
                                    {% if form.titulo.errors %}
                                        <div class="text-red-600 text-sm mt-1">
                                            {% for error in form.titulo.errors %}
                                                <p>{{ error }}</p>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
    </div>

                                <div>
                                    <label for="{{ form.descripcion.id_for_label }}" class="block text-sm font-semibold text-gray-700 mb-2">
                                        {{ form.descripcion.label }}
                                    </label>
                                    {{ form.descripcion }}
                                    {% if form.descripcion.errors %}
                                        <div class="text-red-600 text-sm mt-1">
                                            {% for error in form.descripcion.errors %}
                                                <p>{{ error }}</p>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>

                            <!-- Precio, Tipo y Operación -->
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                                <div>
                                    <label for="{{ form.precio.id_for_label }}" class="block text-sm font-semibold text-gray-700 mb-2">
                                        {{ form.precio.label }}
                                    </label>
                                    <div class="relative">
                                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                            <span class="text-gray-500 sm:text-sm">$</span>
                                        </div>
                                        {{ form.precio }}
                                    </div>
                                    {% if form.precio.errors %}
                                        <div class="text-red-600 text-sm mt-1">
                                            {% for error in form.precio.errors %}
                                                <p>{{ error }}</p>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                                
                                <div>
                                    <label for="{{ form.tipo.id_for_label }}" class="block text-sm font-semibold text-gray-700 mb-2">
                                        {{ form.tipo.label }}
                                    </label>
                                    {{ form.tipo }}
                                    {% if form.tipo.errors %}
                                        <div class="text-red-600 text-sm mt-1">
                                            {% for error in form.tipo.errors %}
                                                <p>{{ error }}</p>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                                
                                <div>
                                    <label for="{{ form.operacion.id_for_label }}" class="block text-sm font-semibold text-gray-700 mb-2">
                                        {{ form.operacion.label }}
                                    </label>
                                    {{ form.operacion }}
                                    {% if form.operacion.errors %}
                                        <div class="text-red-600 text-sm mt-1">
                                            {% for error in form.operacion.errors %}
                                                <p>{{ error }}</p>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>

                            <!-- Estado y Ubicación -->
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                                <div>
                                    <label for="{{ form.estado.id_for_label }}" class="block text-sm font-semibold text-gray-700 mb-2">
                                        {{ form.estado.label }}
                                    </label>
                                    {{ form.estado }}
                                    {% if form.estado.errors %}
                                        <div class="text-red-600 text-sm mt-1">
                                            {% for error in form.estado.errors %}
                                                <p>{{ error }}</p>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                                
                                <div>
                                    <label for="{{ form.ubicacion.id_for_label }}" class="block text-sm font-semibold text-gray-700 mb-2">
                                        {{ form.ubicacion.label }}
                                    </label>
                                    {{ form.ubicacion }}
                                    {% if form.ubicacion.errors %}
                                        <div class="text-red-600 text-sm mt-1">
                                            {% for error in form.ubicacion.errors %}
                                                <p>{{ error }}</p>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>

                            <!-- Características -->
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                                <div>
                                    <label for="{{ form.metros_cuadrados.id_for_label }}" class="block text-sm font-semibold text-gray-700 mb-2">
                                        {{ form.metros_cuadrados.label }}
                                    </label>
                                    <div class="relative">
                                        {{ form.metros_cuadrados }}
                                        <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none">
                                            <span class="text-gray-500 sm:text-sm">m²</span>
                                        </div>
                                    </div>
                                    {% if form.metros_cuadrados.errors %}
                                        <div class="text-red-600 text-sm mt-1">
                                            {% for error in form.metros_cuadrados.errors %}
                                                <p>{{ error }}</p>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                                
                                <div>
                                    <label for="{{ form.habitaciones.id_for_label }}" class="block text-sm font-semibold text-gray-700 mb-2">
                                        {{ form.habitaciones.label }}
                                    </label>
                                    {{ form.habitaciones }}
                                    {% if form.habitaciones.errors %}
                                        <div class="text-red-600 text-sm mt-1">
                                            {% for error in form.habitaciones.errors %}
                                                <p>{{ error }}</p>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                                
                                <div>
                                    <label for="{{ form.banos.id_for_label }}" class="block text-sm font-semibold text-gray-700 mb-2">
                                        {{ form.banos.label }}
                                    </label>
                                    {{ form.banos }}
                                    {% if form.banos.errors %}
                                        <div class="text-red-600 text-sm mt-1">
                                            {% for error in form.banos.errors %}
                                                <p>{{ error }}</p>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>

                            <!-- Imágenes -->
                            <div class="mb-6">
                                <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                                    <i data-lucide="image" class="w-5 h-5 mr-2 text-blue-600"></i>
                                    Imágenes de la Propiedad
                                </h3>
                                
                                <!-- Imagen Principal -->
                                <div class="mb-4">
                                    <label for="{{ form.imagen_principal.id_for_label }}" class="block text-sm font-semibold text-gray-700 mb-2">
                                        {{ form.imagen_principal.label }}
                                        <span class="text-red-500">*</span>
                                    </label>
                                    {{ form.imagen_principal }}
                                    {% if form.imagen_principal.errors %}
                                        <div class="text-red-600 text-sm mt-1">
                                            {% for error in form.imagen_principal.errors %}
                                                <p>{{ error }}</p>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                                
                                <!-- Imagen Secundaria -->
                                <div class="mb-4">
                                    <label for="{{ form.imagen_secundaria.id_for_label }}" class="block text-sm font-semibold text-gray-700 mb-2">
                                        {{ form.imagen_secundaria.label }}
                                    </label>
                                    {{ form.imagen_secundaria }}
                                    {% if form.imagen_secundaria.errors %}
                                        <div class="text-red-600 text-sm mt-1">
                                            {% for error in form.imagen_secundaria.errors %}
                                                <p>{{ error }}</p>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>

                                <!-- Campo oculto para fotos adicionales -->
                                {{ form.fotos_adicionales }}
                                
                                <!-- Fotos Adicionales -->
                                <div class="mb-4">
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                                        <i data-lucide="images" class="w-4 h-4 mr-2 text-blue-600"></i>
                                        Fotos Adicionales
                                    </label>
                                    <div class="upload-area border-2 border-dashed border-gray-300 rounded-lg p-8 text-center hover:border-blue-400 transition-colors cursor-pointer" id="uploadArea">
                                        <div class="upload-content">
                                            <i data-lucide="upload" class="w-12 h-12 text-gray-400 mx-auto mb-4"></i>
                                            <h6 class="text-gray-600 mb-2">Arrastra y suelta fotos aquí o haz clic para seleccionar</h6>
                                            <p class="text-gray-500 text-sm mb-4">Máximo 10 fotos de 5MB cada una (JPG, PNG)</p>
                                            <input type="file" id="fotosInput" multiple accept="image/*" class="hidden">
                                            <button type="button" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors" onclick="document.getElementById('fotosInput').click()">
                                                <i data-lucide="plus" class="w-4 h-4 mr-2"></i>
                                                Seleccionar Fotos
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <!-- Preview de fotos seleccionadas -->
                                    <div id="fotos-preview" class="mt-4 hidden">
                                        <h6 class="text-sm font-semibold text-gray-700 mb-2">
                                            <i data-lucide="images" class="w-4 h-4 mr-2 text-blue-600"></i>
                                            Fotos seleccionadas:
                                        </h6>
                                        <div id="fotos-grid" class="grid grid-cols-2 md:grid-cols-4 gap-4"></div>
                                    </div>
                                </div>
                                
                                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                                    <div class="flex items-start">
                                        <i data-lucide="info" class="w-5 h-5 text-blue-600 mr-3 mt-0.5"></i>
                                        <div>
                                            <p class="text-sm text-blue-800">
                                                <strong>Consejo:</strong> La imagen principal se mostrará en el home, la secundaria en el detalle, y las adicionales estarán disponibles en la galería completa.
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Amenidades -->
                            <div class="mb-6">
                                <label class="block text-sm font-semibold text-gray-700 mb-2">
                                    <i data-lucide="check-circle" class="w-4 h-4 mr-2 text-blue-600"></i>
                                    Amenidades Incluidas
                                </label>
                                <p class="text-gray-600 text-sm mb-4">Selecciona las amenidades que incluye esta propiedad:</p>
                                
                                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                    {% for amenidad in form.amenidades %}
                                    <div class="amenidad-checkbox bg-gray-50 border border-gray-200 rounded-lg p-4 hover:bg-blue-50 hover:border-blue-300 transition-all cursor-pointer">
                                        {{ amenidad }}
                                        <label class="form-check-label cursor-pointer ml-3" for="{{ amenidad.id_for_label }}">
                                            <i class="fas {{ amenidad.data.attrs.icono|default:'fa-check' }} mr-2 text-blue-600"></i>
                                            {{ amenidad.choice_label }}
                                        </label>
                                    </div>
                                    {% endfor %}
                                </div>
                                
                                {% if form.amenidades.errors %}
                                    <div class="text-red-600 text-sm mt-2">
                                        {% for error in form.amenidades.errors %}
                                            <p>{{ error }}</p>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>

                            <!-- Submit Buttons -->
                            <div class="flex flex-col sm:flex-row gap-4 justify-end">
                                <button type="button" id="cancelar-modal" class="px-6 py-3 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors">
                                    <i data-lucide="x" class="w-4 h-4 mr-2"></i>
                                    Cancelar
                                </button>
                                <button type="submit" class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                                    <i data-lucide="save" class="w-4 h-4 mr-2"></i>
                                    Crear Propiedad
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Nuevo Usuario Administrativo -->
    <div id="modal-nuevo-usuario" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-xl shadow-2xl w-full max-w-6xl max-h-[90vh] overflow-hidden">
                <!-- Header del Modal -->
                <div class="flex items-center justify-between p-6 border-b border-gray-200 bg-green-600 text-white">
                    <div>
                        <h2 class="text-xl font-bold">Gestión de Usuarios Administrativos</h2>
                        <p class="text-green-100">Crea y administra usuarios del sistema</p>
                    </div>
                    <button id="cerrar-modal-usuario" class="text-white hover:text-green-200 transition-colors">
                        <i data-lucide="x" class="w-6 h-6"></i>
                    </button>
                </div>
                
                <!-- Contenido del Modal -->
                <div class="overflow-y-auto max-h-[calc(90vh-120px)]">
                    <div class="p-6">
                        <!-- Tabs -->
                        <div class="flex space-x-1 mb-6 bg-gray-100 p-1 rounded-lg">
                            <button id="tab-crear-usuario" class="flex-1 py-2 px-4 text-sm font-medium rounded-md bg-green-600 text-white transition-colors">
                                <i data-lucide="user-plus" class="w-4 h-4 mr-2"></i>
                                Crear Usuario
                            </button>
                            <button id="tab-gestionar-usuarios" class="flex-1 py-2 px-4 text-sm font-medium rounded-md text-gray-600 hover:bg-gray-200 transition-colors">
                                <i data-lucide="users" class="w-4 h-4 mr-2"></i>
                                Gestionar Usuarios
                            </button>
                        </div>

                        <!-- Tab: Crear Usuario -->
                        <div id="content-crear-usuario">
                            <!-- Messages -->
                            <div id="modal-messages-usuario" class="hidden"></div>

                            <form method="post" enctype="multipart/form-data" id="crearUsuarioForm" action="{% url 'login:crear_nuevo_usuario_admin' %}">
                                {% csrf_token %}
                                
                                <!-- Información Personal -->
                                <div class="mb-6">
                                    <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                                        <i data-lucide="user" class="w-5 h-5 mr-2 text-green-600"></i>
                                        Información Personal
                                    </h3>
                                    
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                        <div>
                                            <label for="nombre_usuario" class="block text-sm font-semibold text-gray-700 mb-2">
                                                Nombre
                                            </label>
                                            <input type="text" id="nombre_usuario" name="nombre" 
                                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500"
                                                   placeholder="Ingresa el nombre" required>
                                        </div>
                                        
                                        <div>
                                            <label for="apellido_usuario" class="block text-sm font-semibold text-gray-700 mb-2">
                                                Apellido
                                            </label>
                                            <input type="text" id="apellido_usuario" name="apellido" 
                                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500"
                                                   placeholder="Ingresa el apellido" required>
                                        </div>
                                    </div>
                                    
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-4">
                                        <div>
                                            <label for="telefono_usuario" class="block text-sm font-semibold text-gray-700 mb-2">
                                                Teléfono
                                            </label>
                                            <input type="tel" id="telefono_usuario" name="telefono" 
                                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500"
                                                   placeholder="+52-1-33-12345678">
                                        </div>
                                        
                                        <div>
                                            <label for="fecha_nacimiento_usuario" class="block text-sm font-semibold text-gray-700 mb-2">
                                                Fecha de Nacimiento
                                            </label>
                                            <input type="date" id="fecha_nacimiento_usuario" name="fecha_nacimiento" 
                                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500">
                                        </div>
                                    </div>
                                    
                                    <div class="mt-4">
                                        <label for="foto_perfil_usuario" class="block text-sm font-semibold text-gray-700 mb-2">
                                            Foto de Perfil
                                        </label>
                                        
                                        <!-- Preview de la foto -->
                                        <div class="text-center mb-3">
                                            <div id="foto-preview-usuario" class="hidden">
                                                <img id="foto-preview-img-usuario" src="" alt="Preview" class="rounded-full border-4 border-green-500 mx-auto" style="width: 120px; height: 120px; object-fit: cover;">
                                                <p class="text-gray-600 text-sm mt-2">Vista previa de la foto de perfil</p>
                                            </div>
                                            <div id="foto-placeholder-usuario" class="border-2 border-dashed border-gray-300 rounded-full flex items-center justify-center mx-auto" style="width: 120px; height: 120px;">
                                                <i data-lucide="camera" class="w-8 h-8 text-gray-400"></i>
                                            </div>
                                        </div>
                                        
                                        <input type="file" id="foto_perfil_usuario" name="foto_perfil" accept="image/*" 
                                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500">
                                    </div>
                                </div>
                                
                                <!-- Información de Acceso -->
                                <div class="mb-6">
                                    <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                                        <i data-lucide="lock" class="w-5 h-5 mr-2 text-green-600"></i>
                                        Información de Acceso
                                    </h3>
                                    
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                        <div>
                                            <label for="email_usuario" class="block text-sm font-semibold text-gray-700 mb-2">
                                                Correo Electrónico
                                            </label>
                                            <input type="email" id="email_usuario" name="email" 
                                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500"
                                                   placeholder="usuario@email.com" required>
                                        </div>
                                        
                                        <div>
                                            <label for="password_usuario" class="block text-sm font-semibold text-gray-700 mb-2">
                                                Contraseña
                                            </label>
                                            <input type="password" id="password_usuario" name="password" 
                                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500"
                                                   placeholder="Mínimo 8 caracteres" required>
                                        </div>
                                    </div>
                                    
                                    <div class="mt-4">
                                        <label for="confirmar_password_usuario" class="block text-sm font-semibold text-gray-700 mb-2">
                                            Confirmar Contraseña
                                        </label>
                                        <input type="password" id="confirmar_password_usuario" name="confirmar_password" 
                                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500"
                                               placeholder="Repite la contraseña" required>
                                    </div>
                                </div>

                                <!-- Submit Buttons -->
                                <div class="flex flex-col sm:flex-row gap-4 justify-end">
                                    <button type="button" id="cancelar-modal-usuario" class="px-6 py-3 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors">
                                        <i data-lucide="x" class="w-4 h-4 mr-2"></i>
                                        Cancelar
                                    </button>
                                    <button type="submit" class="px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors">
                                        <i data-lucide="user-plus" class="w-4 h-4 mr-2"></i>
                                        Crear Usuario
                                    </button>
                                </div>
                            </form>
                        </div>

                        <!-- Tab: Gestionar Usuarios -->
                        <div id="content-gestionar-usuarios" class="hidden">
                            <div class="mb-4">
                                <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                                    <i data-lucide="users" class="w-5 h-5 mr-2 text-blue-600"></i>
                                    Usuarios Administrativos
                                </h3>
                                
                                <!-- Messages para gestión de usuarios -->
                                <div id="usuarios-messages" class="hidden mb-4"></div>
                                
                                <!-- Botón para refrescar -->
                                <div class="flex justify-between items-center mb-4">
                                    <p class="text-sm text-gray-600">Gestiona los usuarios administrativos del sistema</p>
                                    <button id="btn-refrescar-usuarios" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors text-sm">
                                        <i data-lucide="refresh-cw" class="w-4 h-4 mr-2"></i>
                                        Refrescar
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Lista de usuarios -->
                            <div id="usuarios-list" class="space-y-4">
                                <!-- Los usuarios se cargarán aquí dinámicamente -->
                                <div class="text-center py-8 text-gray-500">
                                    <i data-lucide="users" class="w-12 h-12 mx-auto mb-4 text-gray-300"></i>
                                    <p>Cargando usuarios...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Confirmación de Eliminación de Propiedad -->
    <div id="modal-eliminar-propiedad" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-xl shadow-2xl w-full max-w-md">
                <div class="p-6">
                    <div class="flex items-center mb-4">
                        <div class="w-12 h-12 bg-red-100 rounded-full flex items-center justify-center mr-4">
                            <i data-lucide="alert-triangle" class="w-6 h-6 text-red-600"></i>
                        </div>
                        <div>
                            <h3 class="text-lg font-semibold text-gray-900">Confirmar Eliminación</h3>
                            <p class="text-sm text-gray-500">Esta acción no se puede deshacer</p>
                        </div>
                    </div>
                    
                    <div class="mb-6">
                        <p class="text-gray-700">
                            ¿Estás seguro de que quieres eliminar la propiedad 
                            <strong id="propiedad-titulo-eliminar" class="text-gray-900"></strong>?
                        </p>
                    </div>
                    
                    <div class="flex space-x-3">
                        <button id="cancelar-eliminar" class="flex-1 px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition-colors">
                            Cancelar
                        </button>
                        <button id="confirmar-eliminar" class="flex-1 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors">
                            <i data-lucide="trash-2" class="w-4 h-4 mr-2"></i>
                            Sí, Eliminar
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Confirmación de Eliminación de Usuario -->
    <div id="modal-eliminar-usuario" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-xl shadow-2xl w-full max-w-md">
                <div class="p-6">
                    <div class="flex items-center mb-4">
                        <div class="w-12 h-12 bg-red-100 rounded-full flex items-center justify-center mr-4">
                            <i data-lucide="user-x" class="w-6 h-6 text-red-600"></i>
                        </div>
                        <div>
                            <h3 class="text-lg font-semibold text-gray-900">Confirmar Eliminación de Usuario</h3>
                            <p class="text-sm text-gray-500">Esta acción no se puede deshacer</p>
                        </div>
                    </div>
                    
                    <div class="mb-6">
                        <p class="text-gray-700">
                            ¿Estás seguro de que quieres eliminar al usuario 
                            <strong id="usuario-nombre-eliminar" class="text-gray-900"></strong>?
                        </p>
                        <p class="text-sm text-red-600 mt-2">
                            <i data-lucide="alert-circle" class="w-4 h-4 inline mr-1"></i>
                            Se eliminarán todas las credenciales y datos asociados.
                        </p>
                    </div>
                    
                    <div class="flex space-x-3">
                        <button id="cancelar-eliminar-usuario" class="flex-1 px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition-colors">
                            Cancelar
                        </button>
                        <button id="confirmar-eliminar-usuario" class="flex-1 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors">
                            <i data-lucide="user-x" class="w-4 h-4 mr-2"></i>
                            Sí, Eliminar
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript organizado en módulos -->
    <script>
        // ========================================
        // FUNCIONES DE NAVEGACIÓN CENTRALIZADAS
        // ========================================
        
        // Función para ocultar todas las secciones
        function hideAllSections() {
            const sections = [
                'dashboard-content',
                'gestion-propiedades-content', 
                'gestion-resenas-content',
                'configuraciones-content'
            ];
            
            sections.forEach(sectionId => {
                const section = document.getElementById(sectionId);
                if (section) {
                    section.classList.add('hidden');
                }
            });
        }
        
        // Función para mostrar una sección específica
        function showSection(sectionId) {
            hideAllSections(); // Ocultar todas primero
            limpiarModales(); // Limpiar modales activos
            const section = document.getElementById(sectionId);
            if (section) {
                section.classList.remove('hidden');
            }
        }
        
        // Función para actualizar el estado del sidebar
        function updateSidebarState(activeSection) {
            // Remover estado activo de todos los botones
            document.querySelectorAll('#sidebar button, #sidebar a').forEach(btn => {
                btn.classList.remove('text-white', 'bg-gradient-to-r', 'from-blue-500', 'to-purple-600', 'transform', 'scale-105', 'shadow-lg');
                btn.classList.add('text-slate-300', 'hover:text-white', 'hover:bg-gradient-to-r', 'hover:from-blue-500', 'hover:to-purple-600', 'hover:scale-105');
            });
            
            // Agregar estado activo al botón correspondiente
            let activeButton = null;
            switch(activeSection) {
                case 'dashboard':
                    activeButton = document.getElementById('btn-inicio');
                    break;
                case 'gestion':
                    activeButton = document.getElementById('btn-gestionar-propiedades');
                    break;
                case 'resenas':
                    activeButton = document.getElementById('btn-gestionar-resenas');
                    break;
                case 'config':
                    activeButton = document.getElementById('btn-configuraciones');
                    break;
            }
            
            if (activeButton) {
                activeButton.classList.remove('text-slate-300', 'hover:text-white', 'hover:bg-gradient-to-r', 'hover:from-blue-500', 'hover:to-purple-600', 'hover:scale-105');
                activeButton.classList.add('text-white', 'bg-gradient-to-r', 'from-blue-500', 'to-purple-600', 'transform', 'scale-105', 'shadow-lg');
            }
        }

        // ========================================
        // SISTEMA DE ACTIVIDADES RECIENTES
        // ========================================
        
        // Almacenamiento de actividades en localStorage
        const ActivitiesManager = {
            storageKey: 'dashboard-activities',
            maxActivities: 20,
            
            // Agregar una nueva actividad
            addActivity(type, title, description, icon = 'activity', color = 'blue') {
                const activity = {
                    id: Date.now(),
                    type: type,
                    title: title,
                    description: description,
                    icon: icon,
                    color: color,
                    timestamp: new Date().toISOString(),
                    timeAgo: 'ahora'
                };
                
                // Obtener actividades existentes
                const activities = this.getActivities();
                
                // Agregar nueva actividad al inicio
                activities.unshift(activity);
                
                // Limitar a maxActivities
                if (activities.length > this.maxActivities) {
                    activities.splice(this.maxActivities);
                }
                
                // Guardar en localStorage
                localStorage.setItem(this.storageKey, JSON.stringify(activities));
                
                // Actualizar la UI
                this.updateUI();
                
                console.log('Nueva actividad agregada:', activity);
            },
            
            // Obtener todas las actividades
            getActivities() {
                try {
                    const stored = localStorage.getItem(this.storageKey);
                    return stored ? JSON.parse(stored) : [];
                } catch (error) {
                    console.error('Error al obtener actividades:', error);
                    return [];
                }
            },
            
            // Calcular tiempo transcurrido
            getTimeAgo(timestamp) {
                const now = new Date();
                const activityTime = new Date(timestamp);
                const diffMs = now - activityTime;
                const diffMins = Math.floor(diffMs / 60000);
                const diffHours = Math.floor(diffMins / 60);
                const diffDays = Math.floor(diffHours / 24);
                
                if (diffMins < 1) return 'ahora';
                if (diffMins < 60) return `hace ${diffMins}m`;
                if (diffHours < 24) return `hace ${diffHours}h`;
                if (diffDays < 7) return `hace ${diffDays}d`;
                return activityTime.toLocaleDateString('es-ES');
            },
            
            // Actualizar la UI
            updateUI() {
                const container = document.getElementById('actividades-container');
                if (!container) return;
                
                const activities = this.getActivities();
                
                if (activities.length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-8">
                            <div class="w-12 h-12 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-3">
                                <i data-lucide="activity" class="w-6 h-6 text-gray-400"></i>
                            </div>
                            <p class="text-sm text-gray-500">No hay actividades recientes</p>
                            <p class="text-xs text-gray-400 mt-1">Las acciones del dashboard aparecerán aquí</p>
                        </div>
                    `;
                    return;
                }
                
                // Generar HTML de actividades
                const activitiesHTML = activities.map(activity => {
                    const timeAgo = this.getTimeAgo(activity.timestamp);
                    const colorClasses = {
                        blue: 'bg-blue-100 text-blue-600',
                        green: 'bg-green-100 text-green-600',
                        yellow: 'bg-yellow-100 text-yellow-600',
                        red: 'bg-red-100 text-red-600',
                        purple: 'bg-purple-100 text-purple-600',
                        gray: 'bg-gray-100 text-gray-600'
                    };
                    
                    return `
                        <div class="flex items-center py-2 px-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors">
                            <div class="w-8 h-8 ${colorClasses[activity.color]} rounded-lg flex items-center justify-center mr-3 flex-shrink-0">
                                <i data-lucide="${activity.icon}" class="w-4 h-4"></i>
                            </div>
                            <div class="flex-1 min-w-0">
                                <p class="text-sm font-medium text-gray-900 truncate">${activity.title}</p>
                                <p class="text-xs text-gray-500 truncate">${activity.description}</p>
                            </div>
                            <div class="text-xs text-gray-400 ml-2 flex-shrink-0">${timeAgo}</div>
                        </div>
                    `;
                }).join('');
                
                container.innerHTML = activitiesHTML;
                
                // Recrear iconos de Lucide
                if (window.lucide) {
                    lucide.createIcons();
                }
            },
            
            // Inicializar el sistema
            init() {
                this.updateUI();
                
                // Actualizar tiempo transcurrido cada minuto
                setInterval(() => {
                    this.updateUI();
                }, 60000);
                
                // Event listener para botón de refrescar
                const refreshBtn = document.getElementById('btn-refrescar-actividades');
                if (refreshBtn) {
                    refreshBtn.addEventListener('click', () => {
                        this.updateUI();
                        // Efecto visual de refrescar
                        refreshBtn.style.transform = 'rotate(360deg)';
                        setTimeout(() => {
                            refreshBtn.style.transform = 'rotate(0deg)';
                        }, 300);
                    });
                }
            }
        };
        
        // Hacer el manager globalmente disponible
        window.ActivitiesManager = ActivitiesManager;
        
        // ========================================
        // FUNCIONES PARA ACTUALIZAR CONTADORES DE RESEÑAS
        // ========================================
        
        // Función para actualizar el total de reseñas desde el backend
        function actualizarTotalResenas(total) {
            const totalElement = document.getElementById('totalReviews');
            if (totalElement && total !== undefined) {
                totalElement.textContent = total;
            }
        }
        
        // Función para cargar estadísticas de reseñas desde el backend
        async function cargarEstadisticasResenas() {
            try {
                const response = await fetch(`{% url "login:gestionar_resenas" %}?estadisticas=true`);
                const data = await response.json();
                
                if (data.success && data.estadisticas) {
                    // Actualizar el total en el dashboard
                    actualizarTotalResenas(data.estadisticas.total);
                    
                    // Actualizar los contadores individuales en la vista de reseñas
                    const esperaElement = document.getElementById('resenasEspera');
                    const aceptadasElement = document.getElementById('resenasAceptadas');
                    const rechazadasElement = document.getElementById('resenasRechazadas');
                    
                    if (esperaElement) esperaElement.textContent = data.estadisticas.en_espera || 0;
                    if (aceptadasElement) aceptadasElement.textContent = data.estadisticas.aceptadas || 0;
                    if (rechazadasElement) rechazadasElement.textContent = data.estadisticas.rechazadas || 0;
                    
                    console.log('Estadísticas de reseñas cargadas:', data.estadisticas);
                }
            } catch (error) {
                console.error('Error al cargar estadísticas de reseñas:', error);
            }
        }
        
        // Hacer las funciones globalmente disponibles
        window.actualizarTotalResenas = actualizarTotalResenas;
        window.cargarEstadisticasResenas = cargarEstadisticasResenas;
        window.aplicarFiltrosResenas = aplicarFiltrosResenas;

        // ========================================
        // MÓDULO: CONFIGURACIÓN Y UTILIDADES
        // ========================================
        const DashboardConfig = {
            // Colores del gráfico (más vivos y vibrantes)
            colors: {
                bajo: '#10B981',    // Verde vibrante: 0-33%
                medio: '#F59E0B',   // Amarillo vibrante: 34-66%
                alto: '#DC2626'     // Rojo vibrante: 67-100%
            },
            
            // Configuración de animaciones
            animation: {
                duration: 300,
                steps: 50
            }
        };

        // ========================================
        // MÓDULO: FUNCIONES DE UTILIDAD
        // ========================================
        const Utils = {
            // Obtener color según escala de calor (basado en rangos absolutos)
            getHeatColor(value, maxValue = null) {
                console.log(`Evaluando color para valor: ${value}, máximo: ${maxValue}`);
                
                // Si no hay valor, usar verde (escala de calor)
                if (value === 0) {
                    console.log(`Valor ${value} -> Verde (bajo - escala de calor)`);
                    return DashboardConfig.colors.bajo; // Verde para 0 clics
                }
                
                // Usar rangos absolutos: 0-60 → 61-150 → 151+
                if (value <= 60) {
                    console.log(`Valor ${value} -> Verde (bajo - rango absoluto)`);
                    return DashboardConfig.colors.bajo; // Verde para 0-60 clics
                }
                if (value <= 150) {
                    console.log(`Valor ${value} -> Amarillo (medio - rango absoluto)`);
                    return DashboardConfig.colors.medio; // Amarillo para 61-150 clics
                }
                console.log(`Valor ${value} -> Rojo (alto - rango absoluto)`);
                return DashboardConfig.colors.alto; // Rojo para 151+ clics
            },

            // Formatear fecha
            formatDate(date, options) {
                return date.toLocaleDateString('es-ES', options);
            },

            // Animar contador
            animateCounter(element, target) {
                let current = 0;
                const increment = target / DashboardConfig.animation.steps;
                
                const timer = setInterval(() => {
                    current += increment;
                    if (current >= target) {
                        element.textContent = target;
                        clearInterval(timer);
                    } else {
                        element.textContent = Math.floor(current);
                    }
                }, DashboardConfig.animation.duration / DashboardConfig.animation.steps);
            }
        };

        // ========================================
        // MÓDULO: GESTIÓN DEL SIDEBAR
        // ========================================
        const SidebarManager = {
            init() {
                this.sidebar = document.getElementById('sidebar');
                this.sidebarToggle = document.getElementById('sidebar-toggle');
                this.sidebarOverlay = document.getElementById('sidebar-overlay');
                
                this.bindEvents();
            },

            bindEvents() {
            // Toggle sidebar
                this.sidebarToggle.addEventListener('click', () => {
                    this.sidebar.classList.toggle('-translate-x-full');
                    this.sidebarOverlay.classList.toggle('hidden');
            });
            
            // Cerrar sidebar al hacer clic en overlay
                this.sidebarOverlay.addEventListener('click', () => {
                    this.sidebar.classList.add('-translate-x-full');
                    this.sidebarOverlay.classList.add('hidden');
            });
            
            // Cerrar sidebar al redimensionar a desktop
            window.addEventListener('resize', () => {
                if (window.innerWidth >= 1024) {
                        this.sidebar.classList.remove('-translate-x-full');
                        this.sidebarOverlay.classList.add('hidden');
                    }
                });
            }
        };

        // ========================================
        // MÓDULO: GESTIÓN DEL GRÁFICO
        // ========================================
        const ChartManager = {
            init() {
                this.propiedadSelect = document.getElementById('propiedad-select');
                this.totalClicksElement = document.getElementById('total-clicks');
                this.leyendaMaximo = document.getElementById('leyenda-maximo');
                
                // Datos desde Django
                this.datosPropiedades = {
                'todas': { 
                    total: {{ total_clicks|default:"0" }}, 
                    datos: [{% for mes_data in clicks_por_mes %}{{ mes_data.clicks }}{% if not forloop.last %},{% endif %}{% endfor %}] 
                }
            };
            
                // Agregar datos de propiedades individuales usando JSON seguro
                try {
                    const datosPropiedadesRaw = {{ clicks_por_propiedad|safe }};
                    console.log('=== DATOS RAW DE PROPIEDADES ===');
                    console.log('Datos raw completos:', datosPropiedadesRaw);
                    console.log('Tipo de datos:', typeof datosPropiedadesRaw);
                    console.log('Claves disponibles:', Object.keys(datosPropiedadesRaw));
                    
            {% for propiedad in todas_propiedades %}
                    const datosPropiedad_{{ propiedad.id }} = datosPropiedadesRaw && datosPropiedadesRaw['{{ propiedad.id }}'] ? datosPropiedadesRaw['{{ propiedad.id }}'] : null;
                    console.log(`Datos raw para propiedad {{ propiedad.id }} ({{ propiedad.titulo }}):`, datosPropiedad_{{ propiedad.id }});
                    if (datosPropiedad_{{ propiedad.id }}) {
                        console.log(`  - Total: ${datosPropiedad_{{ propiedad.id }}.clicks_totales}`);
                        console.log(`  - Por mes: ${JSON.stringify(datosPropiedad_{{ propiedad.id }}.clicks_por_mes)}`);
                    }
                    
                    this.datosPropiedades['{{ propiedad.id }}'] = {
                        total: datosPropiedad_{{ propiedad.id }} ? datosPropiedad_{{ propiedad.id }}.clicks_totales : 0,
                        datos: datosPropiedad_{{ propiedad.id }} ? datosPropiedad_{{ propiedad.id }}.clicks_por_mes : [0,0,0,0,0,0,0,0,0,0,0,0]
                    };
                    console.log(`Datos finales para propiedad {{ propiedad.id }} ({{ propiedad.titulo }}):`, this.datosPropiedades['{{ propiedad.id }}']);
                    console.log(`  - Total final: ${this.datosPropiedades['{{ propiedad.id }}'].total}`);
                    console.log(`  - Datos finales: ${JSON.stringify(this.datosPropiedades['{{ propiedad.id }}'].datos)}`);
            {% endfor %}
                } catch (error) {
                    console.error('Error al cargar datos de propiedades:', error);
                    // Fallback: datos por defecto
                    {% for propiedad in todas_propiedades %}
                    this.datosPropiedades['{{ propiedad.id }}'] = {
                        total: 0,
                        datos: [0,0,0,0,0,0,0,0,0,0,0,0]
                    };
                    {% endfor %}
                }
                
                // Log final de todos los datos cargados
                console.log('=== DATOS FINALES CARGADOS ===');
                console.log('Todos los datos de propiedades:', this.datosPropiedades);
                
                // Verificar específicamente los datos de "casa arleth"
                console.log('=== VERIFICACIÓN ESPECÍFICA CASA ARLETH ===');
                Object.keys(this.datosPropiedades).forEach(key => {
                    if (key !== 'todas') {
                        console.log(`Propiedad ${key}:`, this.datosPropiedades[key]);
                        console.log(`  - Total: ${this.datosPropiedades[key].total}`);
                        console.log(`  - Datos: ${JSON.stringify(this.datosPropiedades[key].datos)}`);
                        console.log(`  - Datos por mes detallado:`, this.datosPropiedades[key].datos.map((valor, index) => `Mes ${index + 1}: ${valor}`));
                    }
                });
                
                // Verificar que los datos son diferentes entre propiedades
                console.log('=== COMPARACIÓN DE DATOS ===');
                const claves = Object.keys(this.datosPropiedades);
                for (let i = 0; i < claves.length; i++) {
                    for (let j = i + 1; j < claves.length; j++) {
                        const clave1 = claves[i];
                        const clave2 = claves[j];
                        const datos1 = this.datosPropiedades[clave1];
                        const datos2 = this.datosPropiedades[clave2];
                        
                        const sonIguales = JSON.stringify(datos1.datos) === JSON.stringify(datos2.datos);
                        console.log(`${clave1} vs ${clave2}: ${sonIguales ? 'IGUALES' : 'DIFERENTES'}`);
                        if (sonIguales) {
                            console.log(`  - Ambos tienen: ${JSON.stringify(datos1.datos)}`);
                        }
                    }
                }
            
                this.bindEvents();
                
                // Ejecutar inmediatamente y con delay para asegurar que funcione
                this.updateChart('todas');
                setTimeout(() => {
                    this.updateChart('todas');
                }, 100);
            },

            bindEvents() {
                this.propiedadSelect.addEventListener('change', (e) => {
                    console.log('=== CAMBIO DE PROPIEDAD ===');
                    console.log('Nueva propiedad seleccionada:', e.target.value);
                    console.log('Datos disponibles para esta propiedad:', this.datosPropiedades[e.target.value]);
                    this.updateChart(e.target.value);
                });
            },

            updateChart(propiedad) {
                try {
                    console.log('=== INICIANDO ACTUALIZACIÓN DE GRÁFICO ===');
                    console.log('Propiedad solicitada:', propiedad);
                    console.log('Datos disponibles:', Object.keys(this.datosPropiedades));
                    
                    const datos = this.datosPropiedades[propiedad];
                    if (!datos || !datos.datos || !Array.isArray(datos.datos)) {
                        console.log('No hay datos válidos para la propiedad:', propiedad);
                        console.log('Datos encontrados:', datos);
                        return;
                    }
                    
                    console.log('=== ACTUALIZANDO GRÁFICO ===');
                    console.log('Propiedad seleccionada:', propiedad);
                    console.log('Datos encontrados:', datos);
                    console.log('Total de clics:', datos.total);
                    console.log('Datos por mes:', datos.datos);
                    console.log('Datos por mes (detallado):', datos.datos.map((valor, index) => `Mes ${index + 1}: ${valor}`));
                    
                    // Verificar si los datos son diferentes a "todas"
                    if (propiedad !== 'todas') {
                        const datosTodas = this.datosPropiedades['todas'];
                        const sonIguales = JSON.stringify(datos.datos) === JSON.stringify(datosTodas.datos);
                        console.log(`¿Los datos de ${propiedad} son iguales a "todas"? ${sonIguales ? 'SÍ' : 'NO'}`);
                        if (sonIguales) {
                            console.log('PROBLEMA: Los datos son idénticos a "todas las propiedades"');
                        }
                    }
                
                // Actualizar total
                this.totalClicksElement.textContent = datos.total.toLocaleString();
                console.log('Total actualizado en el DOM:', datos.total.toLocaleString());
                
                // Actualizar barras - usar selector más específico
                const barras = document.querySelectorAll('#grafico-barras .bar-chart');
                const numeros = document.querySelectorAll('#grafico-barras .absolute.inset-0.flex.items-center.justify-center.text-xs.font-semibold.text-white');
                
                console.log('=== ACTUALIZANDO BARRAS ===');
                console.log('Barras encontradas:', barras.length);
                console.log('Números encontrados:', numeros.length);
                
                const maxValor = Math.max(...datos.datos);
                console.log('Valor máximo para calcular porcentajes:', maxValor);
                
                barras.forEach((barra, index) => {
                    if (index < datos.datos.length) {
                        const valor = datos.datos[index];
                        
                        // Escalado automático con barras proporcionales
                        let porcentaje;
                        if (maxValor === 0) {
                            // Si no hay datos, todas las barras quedan en 0%
                            porcentaje = 0;
                        } else if (valor === 0) {
                            // Para 0 clics, barra mínima (3% de altura)
                            porcentaje = 3;
                        } else {
                            // Para valores > 0, escalado proporcional real
                            // Rango: 10% a 85% (75% de espacio disponible)
                            const escalado = (valor / maxValor) * 75; // 75% del espacio disponible
                            porcentaje = escalado + 10; // Base del 10% + escalado proporcional
                        }
                        
                        console.log(`Procesando barra ${index}: valor=${valor}, porcentaje=${porcentaje}%`);
                        
                        // Aplicar color basado en la escala de calor (dinámico)
                        const color = Utils.getHeatColor(valor, maxValor);
                        
                        // Aplicar estilos con escalado proporcional
                        barra.style.setProperty('width', '100%', 'important');
                        barra.style.setProperty('border-radius', '0.5rem 0.5rem 0 0', 'important');
                        barra.style.setProperty('position', 'absolute', 'important');
                        barra.style.setProperty('bottom', '0', 'important');
                        barra.style.setProperty('height', `${porcentaje}%`, 'important');
                        barra.style.setProperty('transition', 'all 0.3s ease', 'important');
                        barra.style.setProperty('background-color', color, 'important');
                        
                        // Ajustar opacidad para que se vean bien los colores de la escala de calor
                        if (valor === 0) {
                            barra.style.setProperty('opacity', '0.2', 'important');
                        } else {
                            barra.style.setProperty('opacity', '0.9', 'important');
                        }
                        
                        // ACTUALIZAR LA BARRA DE FONDO PROPORCIONALMENTE
                        const contenedorBarra = barra.parentElement;
                        if (contenedorBarra) {
                            // Ajustar la altura del contenedor de fondo proporcionalmente
                            // Para 0 clics, hacer la barra de fondo más grande para que se vea el color gris
                            let alturaContenedor;
                            if (valor === 0) {
                                alturaContenedor = 25; // Más grande para 0 clics (25px)
                            } else {
                                alturaContenedor = Math.max(porcentaje + 8, 20); // Mínimo 20px para otros valores
                            }
                            contenedorBarra.style.setProperty('height', `${alturaContenedor}px`, 'important');
                            contenedorBarra.style.setProperty('transition', 'all 0.3s ease', 'important');
                        }
                        
                        console.log(`Barra ${index} actualizada: valor=${valor}, color=${color}, altura=${porcentaje}%`);
                        
                        // Actualizar el atributo data-value
                        barra.setAttribute('data-value', valor);
                        
                        // Actualizar número
                        if (numeros[index]) {
                            numeros[index].textContent = valor;
                            // Para 0 clics, mostrar el número en gris
                            if (valor === 0) {
                                numeros[index].style.color = '#9ca3af';
                            } else {
                                numeros[index].style.color = 'white';
                            }
                            console.log(`Número ${index} actualizado a: ${valor}`);
                        }
                    }
                });
                
                // Verificar que las barras se actualizaron correctamente
                console.log('=== VERIFICACIÓN FINAL DE BARRAS ===');
                barras.forEach((barra, index) => {
                    console.log(`Barra ${index} final:`, {
                        height: barra.style.height,
                        backgroundColor: barra.style.backgroundColor,
                        dataValue: barra.getAttribute('data-value'),
                        textContent: numeros[index] ? numeros[index].textContent : 'N/A'
                    });
                });
                
                // Verificar que las barras se actualizaron correctamente
                console.log('=== VERIFICACIÓN POST-ACTUALIZACIÓN ===');
                const barrasVerificacion = document.querySelectorAll('#grafico-barras .bar-chart');
                console.log('Barras después de actualización:', barrasVerificacion.length);
                
                // Actualizar máximo en la leyenda
                const maxIndex = datos.datos.indexOf(maxValor);
                const meses = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 
                              'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
                this.leyendaMaximo.textContent = `Máximo: ${maxValor} clics (${meses[maxIndex]})`;
                
                } catch (error) {
                    console.error('Error al actualizar el gráfico:', error);
                }
            }
        };


        // ========================================
        // MÓDULO: GESTIÓN DE PROPIEDADES
        // ========================================
        const PropertyManager = {
            init() {
                this.dashboardContent = document.getElementById('dashboard-content');
                this.gestionContent = document.getElementById('gestion-propiedades-content');
                this.btnInicio = document.getElementById('btn-inicio');
                this.btnGestionar = document.getElementById('btn-gestionar-propiedades');
                this.btnNuevaGestion = document.getElementById('btn-nueva-propiedad-gestion');
                this.btnAgregarPrimera = document.getElementById('btn-agregar-primera-propiedad');
                
                this.bindEvents();
            },

            bindEvents() {
                // Botón de inicio
                this.btnInicio.addEventListener('click', () => {
                    this.showDashboard();
                });
                
                // Mostrar gestión de propiedades
                this.btnGestionar.addEventListener('click', () => {
                    this.showGestionPropiedades();
                });
                
                
                // Nueva propiedad desde gestión
                this.btnNuevaGestion.addEventListener('click', () => {
                    PropertyModalManager.openModal();
                });
                
                // Agregar primera propiedad
                if (this.btnAgregarPrimera) {
                    this.btnAgregarPrimera.addEventListener('click', () => {
                        PropertyModalManager.openModal();
                    });
                }
            },

            showGestionPropiedades() {
                this.dashboardContent.classList.add('hidden');
                this.gestionContent.classList.remove('hidden');
                
                // Actualizar estado del sidebar
                this.updateSidebarState('gestion');
                
                // Recrear iconos
                lucide.createIcons();
            },

            showDashboard() {
                this.gestionContent.classList.add('hidden');
                this.dashboardContent.classList.remove('hidden');
                
                // Actualizar estado del sidebar
                this.updateSidebarState('dashboard');
                
                // Recrear iconos
                lucide.createIcons();
            },

        };

        // ========================================
        // MÓDULO: GESTIÓN DE CONFIGURACIONES
        // ========================================
        const ConfigManager = {
            init() {
                this.configContent = document.getElementById('configuraciones-content');
                this.btnConfiguraciones = document.getElementById('btn-configuraciones');
                this.form = document.getElementById('configuracion-perfil-form');
                this.fotoInput = document.getElementById('foto-perfil-input');
                this.btnCambiarFoto = document.getElementById('btn-cambiar-foto');
                this.fotoPreview = document.getElementById('foto-perfil-preview');
                
                this.bindEvents();
            },

            bindEvents() {
                // Mostrar configuraciones
                this.btnConfiguraciones.addEventListener('click', () => {
                    this.showConfiguraciones();
                });
                
                
                // Navegación desde configuraciones
                const btnInicio = document.getElementById('btn-inicio');
                const btnGestionar = document.getElementById('btn-gestionar-propiedades');
                
                if (btnInicio) {
                    btnInicio.addEventListener('click', () => {
                        this.showDashboard();
                    });
                }
                
                if (btnGestionar) {
                    btnGestionar.addEventListener('click', () => {
                        this.showGestionPropiedades();
                    });
                }
                
                // Cambiar foto de perfil
                this.btnCambiarFoto.addEventListener('click', () => {
                    this.fotoInput.click();
                });
                
                // Preview de foto
                this.fotoInput.addEventListener('change', (e) => {
                    this.handleFotoChange(e);
                });
                
                // Envío del formulario (solo para configuraciones)
                if (this.form.id === 'configuracion-perfil-form') {
                    this.form.addEventListener('submit', (e) => {
                        e.preventDefault();
                        this.handleFormSubmit();
                    });
                }
                
                // Inicializar gestión de cambio de contraseña
                this.initPasswordManager();
            },

            showConfiguraciones() {
                showSection('configuraciones-content');
                updateSidebarState('config');
                lucide.createIcons();
            },

            showDashboard() {
                showSection('dashboard-content');
                updateSidebarState('dashboard');
                lucide.createIcons();
            },

            showGestionPropiedades() {
                showSection('gestion-propiedades-content');
                updateSidebarState('gestion');
                lucide.createIcons();
            },


            handleFotoChange(e) {
                const file = e.target.files[0];
                if (file) {
                    // Validar tipo de archivo
                    if (!file.type.startsWith('image/')) {
                        mostrarMensaje('Por favor selecciona solo archivos de imagen.', 'danger');
                        return;
                    }
                    
                    // Validar tamaño (5MB)
                    if (file.size > 5 * 1024 * 1024) {
                        mostrarMensaje('La imagen debe ser menor a 5MB.', 'danger');
                        return;
                    }
                    
                    // Mostrar preview
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        this.fotoPreview.innerHTML = `<img src="${e.target.result}" alt="Foto de perfil" class="w-full h-full object-cover">`;
                    };
                    reader.readAsDataURL(file);
                }
            },

            async handleFormSubmit() {
                console.log('=== INICIANDO ACTUALIZACIÓN DE PERFIL ===');
                const formData = new FormData(this.form);
                
                // Log de los datos que se van a enviar
                console.log('Datos del formulario:');
                for (let [key, value] of formData.entries()) {
                    console.log(`${key}: ${value}`);
                }
                
                try {
                    const response = await fetch('/login/actualizar-perfil/', {
                        method: 'POST',
                        body: formData,
                        headers: {
                            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                            'X-Requested-With': 'XMLHttpRequest'
                        }
                    });
                    
                    console.log('Respuesta del servidor:', response.status, response.statusText);
                    const result = await response.json();
                    console.log('Resultado JSON:', result);
                    
                    if (result.success) {
                        console.log('Perfil actualizado exitosamente');
                        mostrarMensaje('Perfil actualizado exitosamente.', 'success');
                        // Actualizar la foto en el sidebar si cambió
                        if (result.foto_url) {
                            this.updateSidebarFoto(result.foto_url);
                        }
                    } else {
                        console.log('Error en la respuesta:', result.message);
                        mostrarMensaje(result.message || 'Error al actualizar el perfil.', 'danger');
                    }
                } catch (error) {
                    console.error('Error en la petición:', error);
                    mostrarMensaje('Error al actualizar el perfil.', 'danger');
                }
            },

            updateSidebarFoto(fotoUrl) {
                const sidebarFoto = document.querySelector('#sidebar footer .w-7');
                if (sidebarFoto && fotoUrl) {
                    sidebarFoto.innerHTML = `<img src="${fotoUrl}" alt="Foto de perfil" class="w-full h-full object-cover rounded-full">`;
                }
            },

            initPasswordManager() {
                const passwordForm = document.getElementById('cambiar-password-form');
                const btnEnviarSMS = document.getElementById('btn-enviar-sms');
                const btnVerificarSMS = document.getElementById('btn-verificar-sms');
                const btnCancelarPassword = document.getElementById('cancelar-password');
                const btnCambiarPassword = document.getElementById('btn-cambiar-password');
                
                // Event listeners para cambio de contraseña
                if (btnEnviarSMS) {
                    btnEnviarSMS.addEventListener('click', enviarCodigoSMS);
                }
                
                if (btnVerificarSMS) {
                    btnVerificarSMS.addEventListener('click', verificarCodigoSMS);
                }
                
                if (btnCancelarPassword) {
                    btnCancelarPassword.addEventListener('click', () => {
                        this.resetPasswordForm();
                    });
                }
                
                if (passwordForm) {
                    passwordForm.addEventListener('submit', (e) => {
                        e.preventDefault();
                        this.handlePasswordChange();
                    });
                }
                
                // Validación en tiempo real de contraseñas
                const nuevaPassword = document.getElementById('nueva_password');
                const confirmarPassword = document.getElementById('confirmar_nueva_password');
                
                if (nuevaPassword && confirmarPassword) {
                    [nuevaPassword, confirmarPassword].forEach(input => {
                        input.addEventListener('input', () => {
                            this.validatePasswords();
                        });
                    });
                }
            },

            validatePasswords() {
                const nuevaPassword = document.getElementById('nueva_password').value;
                const confirmarPassword = document.getElementById('confirmar_nueva_password').value;
                const btnCambiarPassword = document.getElementById('btn-cambiar-password');
                
                // Validar que las contraseñas coincidan
                if (nuevaPassword && confirmarPassword) {
                    if (nuevaPassword === confirmarPassword) {
                        if (nuevaPassword.length >= 8) {
                            // Habilitar botón si está verificado por SMS o tiene contraseña actual
                            const passwordActual = document.getElementById('password_actual').value;
                            if (passwordActual || smsVerified) {
                                btnCambiarPassword.disabled = false;
                            }
                        } else {
                            btnCambiarPassword.disabled = true;
                            mostrarMensajePassword('La contraseña debe tener al menos 8 caracteres.', 'danger');
                        }
                    } else {
                        btnCambiarPassword.disabled = true;
                        mostrarMensajePassword('Las contraseñas no coinciden.', 'danger');
                    }
                } else {
                    btnCambiarPassword.disabled = true;
                }
            },

            resetPasswordForm() {
                const form = document.getElementById('cambiar-password-form');
                if (form) form.reset();
                
                // Limpiar variables globales
                smsCodeSent = false;
                smsVerified = false;
                if (smsTimer) {
                    clearInterval(smsTimer);
                    smsTimer = null;
                }
                
                // Ocultar sección de SMS
                const smsSection = document.getElementById('sms-verification-section');
                if (smsSection) smsSection.classList.add('hidden');
                
                // Deshabilitar botón
                const btnCambiarPassword = document.getElementById('btn-cambiar-password');
                if (btnCambiarPassword) btnCambiarPassword.disabled = true;
                
                // Limpiar mensajes
                const messagesContainer = document.getElementById('password-messages');
                if (messagesContainer) {
                    messagesContainer.innerHTML = '';
                    messagesContainer.classList.add('hidden');
                }
            },

            async handlePasswordChange() {
                const formData = new FormData(document.getElementById('cambiar-password-form'));
                const passwordActual = formData.get('password_actual');
                const nuevaPassword = formData.get('nueva_password');
                const confirmarPassword = formData.get('confirmar_nueva_password');
                
                // Validaciones
                if (!nuevaPassword || !confirmarPassword) {
                    mostrarMensajePassword('Por favor completa todos los campos.', 'danger');
                    return;
                }
                
                if (nuevaPassword !== confirmarPassword) {
                    mostrarMensajePassword('Las contraseñas no coinciden.', 'danger');
                    return;
                }
                
                if (nuevaPassword.length < 8) {
                    mostrarMensajePassword('La contraseña debe tener al menos 8 caracteres.', 'danger');
                    return;
                }
                
                // Verificar que tenga contraseña actual O verificación SMS
                if (!passwordActual && !smsVerified) {
                    mostrarMensajePassword('Debes ingresar tu contraseña actual o verificar por SMS.', 'danger');
                    return;
                }
                
                try {
                    const response = await fetch('/login/cambiar-password/', {
                        method: 'POST',
                        body: formData,
                        headers: {
                            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                            'X-Requested-With': 'XMLHttpRequest'
                        }
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        mostrarMensajePassword('Contraseña cambiada exitosamente.', 'success');
                        this.resetPasswordForm();
                    } else {
                        mostrarMensajePassword(result.message || 'Error al cambiar la contraseña.', 'danger');
                    }
                } catch (error) {
                    console.error('Error:', error);
                    mostrarMensajePassword('Error al cambiar la contraseña.', 'danger');
                }
            }
        };

        // ========================================
        // MÓDULO: GESTIÓN DEL MODAL DE NUEVO USUARIO
        // ========================================
        const UsuarioModalManager = {
            init() {
                this.modal = document.getElementById('modal-nuevo-usuario');
                this.btnAbrir = document.getElementById('btn-nuevo-usuario');
                this.btnCerrar = document.getElementById('cerrar-modal-usuario');
                this.btnCancelar = document.getElementById('cancelar-modal-usuario');
                this.form = document.getElementById('crearUsuarioForm');
                this.messagesContainer = document.getElementById('modal-messages-usuario');
                
                // Tabs
                this.tabCrearUsuario = document.getElementById('tab-crear-usuario');
                this.tabGestionarUsuarios = document.getElementById('tab-gestionar-usuarios');
                this.contentCrearUsuario = document.getElementById('content-crear-usuario');
                this.contentGestionarUsuarios = document.getElementById('content-gestionar-usuarios');
                
                // Gestión de usuarios
                this.btnRefrescarUsuarios = document.getElementById('btn-refrescar-usuarios');
                this.usuariosList = document.getElementById('usuarios-list');
                this.usuariosMessages = document.getElementById('usuarios-messages');
                
                this.bindEvents();
                this.initFormHandlers();
                this.initTabHandlers();
            },

            bindEvents() {
                // Abrir modal
                this.btnAbrir.addEventListener('click', () => {
                    this.openModal();
                });
                
                // Cerrar modal
                this.btnCerrar.addEventListener('click', () => {
                    this.closeModal();
                });
                
                this.btnCancelar.addEventListener('click', () => {
                    this.closeModal();
                });
                
                // Cerrar al hacer clic fuera del modal
                this.modal.addEventListener('click', (e) => {
                    if (e.target === this.modal) {
                        this.closeModal();
                    }
                });
                
                // Cerrar con tecla Escape
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape' && !this.modal.classList.contains('hidden')) {
                        this.closeModal();
                    }
                });
            },

            openModal() {
                this.modal.classList.remove('hidden');
                document.body.style.overflow = 'hidden';
                // Recrear iconos de Lucide para el modal
                lucide.createIcons();
            },

            closeModal() {
                this.modal.classList.add('hidden');
                document.body.style.overflow = 'auto';
                this.resetForm();
            },

            resetForm() {
                this.form.reset();
                this.clearMessages();
                // Limpiar preview de foto
                const fotoPreview = document.getElementById('foto-preview-usuario');
                const fotoPlaceholder = document.getElementById('foto-placeholder-usuario');
                if (fotoPreview) fotoPreview.classList.add('hidden');
                if (fotoPlaceholder) fotoPlaceholder.classList.remove('hidden');
            },

            showMessage(message, type = 'success') {
                const bgColor = type === 'success' ? 'bg-green-50 border-green-200 text-green-800' : 'bg-red-50 border-red-200 text-red-800';
                const iconColor = type === 'success' ? 'text-green-600' : 'text-red-600';
                const icon = type === 'success' ? 'check-circle' : 'alert-circle';
                
                this.messagesContainer.innerHTML = `
                    <div class="border rounded-lg p-4 ${bgColor} flex items-start">
                        <i data-lucide="${icon}" class="w-5 h-5 ${iconColor} mr-3 mt-0.5"></i>
                        <div class="flex-1">
                            <p class="text-sm font-medium">${message}</p>
                        </div>
                        <button type="button" onclick="this.parentElement.parentElement.remove()" class="ml-3 text-gray-400 hover:text-gray-600">
                            <i data-lucide="x" class="w-4 h-4"></i>
                        </button>
                    </div>
                `;
                this.messagesContainer.classList.remove('hidden');
                // Recrear iconos de Lucide
                lucide.createIcons();
            },

            clearMessages() {
                this.messagesContainer.innerHTML = '';
                this.messagesContainer.classList.add('hidden');
            },

            initFormHandlers() {
                // Preview de foto de perfil
                const fotoInput = document.getElementById('foto_perfil_usuario');
                const fotoPreview = document.getElementById('foto-preview-usuario');
                const fotoPreviewImg = document.getElementById('foto-preview-img-usuario');
                const fotoPlaceholder = document.getElementById('foto-placeholder-usuario');
                
                if (fotoInput) {
                    fotoInput.addEventListener('change', (e) => {
                        const file = e.target.files[0];
                        if (file) {
                            // Validar que sea una imagen
                            if (!file.type.startsWith('image/')) {
                                alert('Por favor selecciona solo archivos de imagen.');
                                this.resetForm();
                                return;
                            }
                            
                            // Validar tamaño (5MB)
                            if (file.size > 5 * 1024 * 1024) {
                                alert('La imagen debe ser menor a 5MB.');
                                this.resetForm();
                                return;
                            }
                            
                            // Mostrar preview
                            const reader = new FileReader();
                            reader.onload = (e) => {
                                fotoPreviewImg.src = e.target.result;
                                fotoPreview.classList.remove('hidden');
                                fotoPlaceholder.classList.add('hidden');
                            };
                            reader.readAsDataURL(file);
                        } else {
                            // Ocultar preview si no hay archivo
                            fotoPreview.classList.add('hidden');
                            fotoPlaceholder.classList.remove('hidden');
                        }
                    });
                }
                
                // Validación antes de enviar (solo para nuevo usuario)
                if (this.form.id === 'crearUsuarioForm') {
                    this.form.addEventListener('submit', (e) => {
                        e.preventDefault();
                        this.handleFormSubmit();
                    });
                }
            },

            async handleFormSubmit() {
                const formData = new FormData(this.form);
                
                try {
                    const response = await fetch(this.form.action, {
                        method: 'POST',
                        body: formData,
                        headers: {
                            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                            'X-Requested-With': 'XMLHttpRequest'
                        }
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        if (result.success) {
                            this.showMessage(result.message, 'success');
                            
                            // Agregar actividad
                            const nombre = formData.get('nombre') || 'Nuevo usuario';
                            const apellido = formData.get('apellido') || '';
                            const nombreCompleto = `${nombre} ${apellido}`.trim();
                            
                            ActivitiesManager.addActivity(
                                'user', 
                                'Usuario creado', 
                                `"${nombreCompleto}" agregado al sistema`, 
                                'user-plus', 
                                'green'
                            );
                            
                            setTimeout(() => {
                                this.closeModal();
                                // Recargar la página para actualizar las estadísticas
                                window.location.reload();
                            }, 2000);
                        } else {
                            // Mostrar errores específicos del formulario
                            if (result.errors) {
                                let errorMessage = result.message || 'Por favor corrige los siguientes errores:';
                                for (const [field, errors] of Object.entries(result.errors)) {
                                    errorMessage += `\n• ${field}: ${errors.join(', ')}`;
                                }
                                this.showMessage(errorMessage, 'danger');
                            } else {
                                this.showMessage(result.message || 'Error al crear el usuario', 'danger');
                            }
                        }
                    } else {
                        this.showMessage('Error al crear el usuario. Por favor intenta de nuevo.', 'danger');
                    }
                } catch (error) {
                    console.error('Error:', error);
                    this.showMessage('Error al crear el usuario. Por favor intenta de nuevo.', 'danger');
                }
            },

            initTabHandlers() {
                // Tab: Crear Usuario
                this.tabCrearUsuario.addEventListener('click', () => {
                    this.showTab('crear');
                });
                
                // Tab: Gestionar Usuarios
                this.tabGestionarUsuarios.addEventListener('click', () => {
                    this.showTab('gestionar');
                });
                
                // Botón refrescar usuarios
                this.btnRefrescarUsuarios.addEventListener('click', () => {
                    this.cargarUsuarios();
                });
            },

            showTab(tabName) {
                // Remover clases activas de todos los tabs
                this.tabCrearUsuario.classList.remove('bg-green-600', 'text-white');
                this.tabCrearUsuario.classList.add('text-gray-600', 'hover:bg-gray-200');
                this.tabGestionarUsuarios.classList.remove('bg-green-600', 'text-white');
                this.tabGestionarUsuarios.classList.add('text-gray-600', 'hover:bg-gray-200');
                
                // Ocultar todos los contenidos
                this.contentCrearUsuario.classList.add('hidden');
                this.contentGestionarUsuarios.classList.add('hidden');
                
                if (tabName === 'crear') {
                    // Activar tab crear usuario
                    this.tabCrearUsuario.classList.remove('text-gray-600', 'hover:bg-gray-200');
                    this.tabCrearUsuario.classList.add('bg-green-600', 'text-white');
                    this.contentCrearUsuario.classList.remove('hidden');
                } else if (tabName === 'gestionar') {
                    // Activar tab gestionar usuarios
                    this.tabGestionarUsuarios.classList.remove('text-gray-600', 'hover:bg-gray-200');
                    this.tabGestionarUsuarios.classList.add('bg-green-600', 'text-white');
                    this.contentGestionarUsuarios.classList.remove('hidden');
                    // Cargar usuarios cuando se muestra el tab
                    this.cargarUsuarios();
                }
                
                lucide.createIcons();
            },

            async cargarUsuarios() {
                try {
                    this.usuariosList.innerHTML = `
                        <div class="text-center py-8 text-gray-500">
                            <i data-lucide="loader" class="w-8 h-8 mx-auto mb-4 text-gray-300 animate-spin"></i>
                            <p>Cargando usuarios...</p>
                        </div>
                    `;
                    lucide.createIcons();
                    
                    const response = await fetch('/login/listar-usuarios-admin/', {
                        method: 'GET',
                        headers: {
                            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                            'X-Requested-With': 'XMLHttpRequest'
                        }
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        this.mostrarUsuarios(result.usuarios);
                    } else {
                        this.mostrarErrorUsuarios(result.message || 'Error al cargar usuarios');
                    }
                } catch (error) {
                    console.error('Error:', error);
                    this.mostrarErrorUsuarios('Error al cargar usuarios');
                }
            },

            mostrarUsuarios(usuarios) {
                if (usuarios.length === 0) {
                    this.usuariosList.innerHTML = `
                        <div class="text-center py-8 text-gray-500">
                            <i data-lucide="users" class="w-12 h-12 mx-auto mb-4 text-gray-300"></i>
                            <p>No hay usuarios administrativos registrados</p>
                        </div>
                    `;
                } else {
                    this.usuariosList.innerHTML = usuarios.map(usuario => `
                        <div class="bg-white border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center space-x-4">
                                    <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center overflow-hidden">
                                        ${usuario.foto_perfil ? 
                                            `<img src="${usuario.foto_perfil}" alt="Foto de perfil" class="w-full h-full object-cover">` :
                                            `<i data-lucide="user" class="w-6 h-6 text-blue-600"></i>`
                                        }
                                    </div>
                                    <div>
                                        <h4 class="font-semibold text-gray-900">${usuario.nombre_completo}</h4>
                                        <p class="text-sm text-gray-600">${usuario.email}</p>
                                        <p class="text-xs text-gray-500">Creado: ${usuario.fecha_creacion}</p>
                                    </div>
                                </div>
                                <div class="flex items-center space-x-2">
                                    <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full ${usuario.activo ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                                        ${usuario.activo ? 'Activo' : 'Inactivo'}
                                    </span>
                                    <button onclick="UsuarioModalManager.confirmarEliminarUsuario(${usuario.id}, '${usuario.nombre_completo}')" 
                                            class="text-red-600 hover:text-red-800 transition-colors" title="Eliminar usuario">
                                        <i data-lucide="trash-2" class="w-4 h-4"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    `).join('');
                }
                lucide.createIcons();
            },

            mostrarErrorUsuarios(mensaje) {
                this.usuariosList.innerHTML = `
                    <div class="text-center py-8 text-red-500">
                        <i data-lucide="alert-circle" class="w-12 h-12 mx-auto mb-4 text-red-300"></i>
                        <p>${mensaje}</p>
                    </div>
                `;
                lucide.createIcons();
            },

            confirmarEliminarUsuario(usuarioId, nombreUsuario) {
                window.usuarioAEliminar = usuarioId;
                document.getElementById('usuario-nombre-eliminar').textContent = nombreUsuario;
                
                const modal = document.getElementById('modal-eliminar-usuario');
                modal.classList.remove('hidden');
                
                lucide.createIcons();
            }
        };

        // ========================================
        // MÓDULO: GESTIÓN DEL MODAL DE NUEVA PROPIEDAD
        // ========================================
        const PropertyModalManager = {
            init() {
                this.modal = document.getElementById('modal-nueva-propiedad');
                this.btnAbrir = document.getElementById('btn-nueva-propiedad');
                this.btnCerrar = document.getElementById('cerrar-modal');
                this.btnCancelar = document.getElementById('cancelar-modal');
                this.form = document.getElementById('crearPropiedadForm');
                this.messagesContainer = document.getElementById('modal-messages');
                
                this.bindEvents();
                this.initFormHandlers();
            },

            bindEvents() {
                // Abrir modal
                this.btnAbrir.addEventListener('click', () => {
                    this.openModal();
                });
                
                // Cerrar modal
                this.btnCerrar.addEventListener('click', () => {
                    this.closeModal();
                });
                
                this.btnCancelar.addEventListener('click', () => {
                    this.closeModal();
                });
                
                // Cerrar al hacer clic fuera del modal
                this.modal.addEventListener('click', (e) => {
                    if (e.target === this.modal) {
                        this.closeModal();
                    }
                });
                
                // Cerrar con tecla Escape
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape' && !this.modal.classList.contains('hidden')) {
                        this.closeModal();
                    }
                });
            },

            openModal() {
                this.modal.classList.remove('hidden');
                document.body.style.overflow = 'hidden';
                // Recrear iconos de Lucide para el modal
                lucide.createIcons();
            },

            closeModal() {
                this.modal.classList.add('hidden');
                document.body.style.overflow = 'auto';
                this.resetForm();
            },

            resetForm() {
                this.form.reset();
                this.clearMessages();
                // Limpiar preview de fotos
                const fotosPreview = document.getElementById('fotos-preview');
                const fotosGrid = document.getElementById('fotos-grid');
                if (fotosPreview) fotosPreview.classList.add('hidden');
                if (fotosGrid) fotosGrid.innerHTML = '';
            },

            showMessage(message, type = 'success') {
                const bgColor = type === 'success' ? 'bg-green-50 border-green-200 text-green-800' : 'bg-red-50 border-red-200 text-red-800';
                const iconColor = type === 'success' ? 'text-green-600' : 'text-red-600';
                const icon = type === 'success' ? 'check-circle' : 'alert-circle';
                
                this.messagesContainer.innerHTML = `
                    <div class="border rounded-lg p-4 ${bgColor} flex items-start">
                        <i data-lucide="${icon}" class="w-5 h-5 ${iconColor} mr-3 mt-0.5"></i>
                        <div class="flex-1">
                            <p class="text-sm font-medium">${message}</p>
                        </div>
                        <button type="button" onclick="this.parentElement.parentElement.remove()" class="ml-3 text-gray-400 hover:text-gray-600">
                            <i data-lucide="x" class="w-4 h-4"></i>
                        </button>
                    </div>
                `;
                this.messagesContainer.classList.remove('hidden');
                // Recrear iconos de Lucide
                lucide.createIcons();
            },

            clearMessages() {
                this.messagesContainer.innerHTML = '';
                this.messagesContainer.classList.add('hidden');
            },

            initFormHandlers() {
                // Form validation
                const precioInput = document.getElementById('{{ form.precio.id_for_label }}');
                const metrosInput = document.getElementById('{{ form.metros_cuadrados.id_for_label }}');
                
                // Formato de precio
                if (precioInput) {
                    precioInput.addEventListener('input', function(e) {
                        let value = e.target.value.replace(/[^\d.]/g, '');
                        if (value && !isNaN(value)) {
                            value = parseFloat(value).toFixed(2);
                            e.target.value = value;
                        }
                    });
                }
                
                // Validación antes de enviar (solo para nueva propiedad)
                if (this.form.id === 'crearPropiedadForm') {
                    this.form.addEventListener('submit', (e) => {
                        e.preventDefault();
                        this.handleFormSubmit();
                    });
                }
                
                // Preview de imagen principal
                const imagenPrincipalInput = document.getElementById('{{ form.imagen_principal.id_for_label }}');
                if (imagenPrincipalInput) {
                    imagenPrincipalInput.addEventListener('change', (e) => {
                        this.validateImageFile(e.target, 'imagen principal');
                    });
                }
                
                // Preview de imagen secundaria
                const imagenSecundariaInput = document.getElementById('{{ form.imagen_secundaria.id_for_label }}');
                if (imagenSecundariaInput) {
                    imagenSecundariaInput.addEventListener('change', (e) => {
                        this.validateImageFile(e.target, 'imagen secundaria');
                    });
                }
                
                // Sistema de múltiples fotos adicionales
                this.initPhotoUpload();
            },

            initPhotoUpload() {
                const fotosInput = document.getElementById('fotosInput');
                const uploadArea = document.getElementById('uploadArea');
                let fotosSeleccionadas = [];
                
                if (!fotosInput || !uploadArea) return;
                
                // Evento para seleccionar archivos
                fotosInput.addEventListener('change', (e) => {
                    this.handleFiles(e.target.files, fotosSeleccionadas);
                });
                
                // Drag and Drop
                uploadArea.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    uploadArea.classList.add('dragover');
                });
                
                uploadArea.addEventListener('dragleave', (e) => {
                    e.preventDefault();
                    uploadArea.classList.remove('dragover');
                });
                
                uploadArea.addEventListener('drop', (e) => {
                    e.preventDefault();
                    uploadArea.classList.remove('dragover');
                    const files = e.dataTransfer.files;
                    this.handleFiles(files, fotosSeleccionadas);
                });
                
                // Hacer fotosSeleccionadas accesible globalmente
                window.fotosSeleccionadas = fotosSeleccionadas;
            },

            handleFiles(files, fotosSeleccionadas) {
                const validFiles = Array.from(files).filter(file => {
                    // Validar tipo de archivo
                    if (!file.type.startsWith('image/')) {
                        alert(`El archivo ${file.name} no es una imagen válida.`);
                        return false;
                    }
                    
                    // Validar tamaño
                    if (file.size > 5 * 1024 * 1024) { // 5MB
                        alert(`La imagen ${file.name} excede el tamaño máximo de 5MB.`);
                        return false;
                    }
                    
                    // Validar cantidad máxima
                    if (fotosSeleccionadas.length + 1 > 10) {
                        alert('Puedes seleccionar máximo 10 fotos adicionales.');
                        return false;
                    }
                    
                    return true;
                });
                
                // Agregar archivos válidos
                fotosSeleccionadas.push(...validFiles);
                this.showFotosPreview(fotosSeleccionadas);
            },

            showFotosPreview(fotosSeleccionadas) {
                const previewDiv = document.getElementById('fotos-preview');
                const gridDiv = document.getElementById('fotos-grid');
                
                if (fotosSeleccionadas.length === 0) {
                    previewDiv.classList.add('hidden');
                    return;
                }
                
                previewDiv.classList.remove('hidden');
                gridDiv.innerHTML = '';
                
                fotosSeleccionadas.forEach((file, index) => {
                    const reader = new FileReader();
                    
                    reader.onload = (e) => {
                        const col = document.createElement('div');
                        col.className = 'col-span-1';
                        col.innerHTML = `
                            <div class="foto-preview-item">
                                <button type="button" class="foto-preview-remove" onclick="PropertyModalManager.removeFotoPreview(${index})">
                                    <i data-lucide="x" class="w-3 h-3"></i>
                                </button>
                                <img src="${e.target.result}" alt="Preview ${index + 1}" class="w-full h-32 object-cover rounded">
                                <div class="foto-preview-info">
                                    <small class="text-gray-600">${file.name}</small>
                                    <small class="text-gray-500 block">${(file.size / 1024 / 1024).toFixed(2)} MB</small>
                                </div>
                            </div>
                        `;
                        gridDiv.appendChild(col);
                        // Recrear iconos de Lucide
                        lucide.createIcons();
                    };
                    
                    reader.readAsDataURL(file);
                });
            },

            removeFotoPreview(index) {
                if (window.fotosSeleccionadas) {
                    window.fotosSeleccionadas.splice(index, 1);
                    this.showFotosPreview(window.fotosSeleccionadas);
                }
            },

            validateImageFile(input, fieldName) {
                const file = input.files[0];
                if (file) {
                    if (!file.type.startsWith('image/')) {
                        alert(`Por favor selecciona solo archivos de imagen para la ${fieldName}.`);
                        input.value = '';
                        return false;
                    }
                    
                    if (file.size > 5 * 1024 * 1024) { // 5MB
                        alert(`La ${fieldName} debe ser menor a 5MB.`);
                        input.value = '';
                        return false;
                    }
                }
                return true;
            },

            async handleFormSubmit() {
                const formData = new FormData(this.form);
                
                // Agregar las fotos adicionales al FormData
                if (window.fotosSeleccionadas) {
                    window.fotosSeleccionadas.forEach((file) => {
                        formData.append('fotos_adicionales', file);
                    });
                }
                
                try {
                    const response = await fetch(this.form.action, {
                        method: 'POST',
                        body: formData,
                        headers: {
                            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                            'X-Requested-With': 'XMLHttpRequest'
                        }
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        if (result.success) {
                            this.showMessage('¡Propiedad creada exitosamente!', 'success');
                            
                            // Agregar actividad
                            const titulo = formData.get('titulo') || 'Nueva propiedad';
                            ActivitiesManager.addActivity(
                                'property', 
                                'Propiedad creada', 
                                `"${titulo}" agregada al catálogo`, 
                                'home', 
                                'green'
                            );
                            
                            setTimeout(() => {
                                this.closeModal();
                                // Recargar la página para actualizar las estadísticas
                                window.location.reload();
                            }, 2000);
                        } else {
                            // Mostrar errores específicos del formulario
                            if (result.errors) {
                                let errorMessage = result.message || 'Por favor corrige los siguientes errores:';
                                for (const [field, errors] of Object.entries(result.errors)) {
                                    errorMessage += `\n• ${field}: ${errors.join(', ')}`;
                                }
                                this.showMessage(errorMessage, 'danger');
                            } else {
                                this.showMessage(result.message || 'Error al crear la propiedad', 'danger');
                            }
                        }
                    } else {
                        this.showMessage('Error al crear la propiedad. Por favor intenta de nuevo.', 'danger');
                    }
                } catch (error) {
                    console.error('Error:', error);
                    this.showMessage('Error al crear la propiedad. Por favor intenta de nuevo.', 'danger');
                }
            }
        };

        // ========================================
        // MÓDULO: ANIMACIONES Y CONTADORES
        // ========================================
        const AnimationManager = {
            init() {
                this.animateCounters();
                this.updateDate();
            },

            animateCounters() {
                const counters = document.querySelectorAll('[id^="total"]');
                
                counters.forEach(counter => {
                    const target = parseInt(counter.textContent) || 0;
                    if (target > 0) {
                        counter.textContent = '0';
                        Utils.animateCounter(counter, target);
                    }
                });
            },

            updateDate() {
                const currentDate = new Date();
                
                // Diferentes formatos según el tamaño de pantalla
                const optionsFull = { 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric',
                    weekday: 'long'
                };
                const optionsMedium = { 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric'
                };
                const optionsShort = { 
                    day: 'numeric',
                    month: 'short',
                    year: 'numeric'
                };
                const optionsMinimal = { 
                    day: 'numeric',
                    month: 'short'
                };
                
                // Obtener todos los elementos
                const currentDateFullElement = document.getElementById('currentDateFull');
                const currentDateMediumElement = document.getElementById('currentDateMedium');
                const currentDateShortElement = document.getElementById('currentDateShort');
                const currentDateMinimalElement = document.getElementById('currentDateMinimal');
                
                console.log('Actualizando fecha...', { 
                    currentDateFullElement, 
                    currentDateMediumElement, 
                    currentDateShortElement, 
                    currentDateMinimalElement 
                });
                
                // Función para formatear fecha directamente
                const formatDate = (date, options) => {
                    try {
                        return date.toLocaleDateString('es-ES', options);
                    } catch (error) {
                        console.error('Error formateando fecha:', error);
                        return date.toLocaleDateString();
                    }
                };
                
                // Actualizar fecha completa (XL+)
                if (currentDateFullElement) {
                    const formattedDate = formatDate(currentDate, optionsFull);
                    currentDateFullElement.textContent = formattedDate;
                    console.log('Fecha completa actualizada:', formattedDate);
                } else {
                    console.log('Elemento currentDateFull no encontrado');
                }
                
                // Actualizar fecha media (LG)
                if (currentDateMediumElement) {
                    const formattedDate = formatDate(currentDate, optionsMedium);
                    currentDateMediumElement.textContent = formattedDate;
                    console.log('Fecha media actualizada:', formattedDate);
                } else {
                    console.log('Elemento currentDateMedium no encontrado');
                }
                
                // Actualizar fecha corta (MD)
                if (currentDateShortElement) {
                    const formattedDate = formatDate(currentDate, optionsShort);
                    currentDateShortElement.textContent = formattedDate;
                    console.log('Fecha corta actualizada:', formattedDate);
                } else {
                    console.log('Elemento currentDateShort no encontrado');
                }
                
                // Actualizar fecha mínima (SM y menor)
                if (currentDateMinimalElement) {
                    const formattedDate = formatDate(currentDate, optionsMinimal);
                    currentDateMinimalElement.textContent = formattedDate;
                    console.log('Fecha mínima actualizada:', formattedDate);
                } else {
                    console.log('Elemento currentDateMinimal no encontrado');
                }
            }
        };

        // ========================================
        // FUNCIONES GLOBALES PARA GESTIÓN DE PROPIEDADES
        // ========================================
        let propiedadAEliminar = null;

        // ========================================
        // FUNCIONES GLOBALES PARA GESTIÓN DE USUARIOS
        // ========================================
        let usuarioAEliminar = null;

        // ========================================
        // FUNCIONES GLOBALES PARA CAMBIO DE CONTRASEÑA
        // ========================================
        let smsTimer = null;
        let smsCodeSent = false;
        let smsVerified = false;

        // Función para alternar visibilidad de contraseña
        function togglePasswordVisibility(inputId) {
            const input = document.getElementById(inputId);
            const button = input.nextElementSibling;
            const icon = button.querySelector('i');
            
            if (input.type === 'password') {
                input.type = 'text';
                icon.setAttribute('data-lucide', 'eye-off');
            } else {
                input.type = 'password';
                icon.setAttribute('data-lucide', 'eye');
            }
            lucide.createIcons();
        }

        // Función para mostrar mensajes de cambio de contraseña
        function mostrarMensajePassword(mensaje, tipo) {
            const messagesContainer = document.getElementById('password-messages');
            const bgColor = tipo === 'success' ? 'bg-green-50 border-green-200 text-green-800' : 'bg-red-50 border-red-200 text-red-800';
            const iconColor = tipo === 'success' ? 'text-green-600' : 'text-red-600';
            const icon = tipo === 'success' ? 'check-circle' : 'alert-circle';
            
            messagesContainer.innerHTML = `
                <div class="border rounded-lg p-4 ${bgColor} flex items-start">
                    <i data-lucide="${icon}" class="w-5 h-5 ${iconColor} mr-3 mt-0.5"></i>
                    <div class="flex-1">
                        <p class="text-sm font-medium">${mensaje}</p>
                    </div>
                    <button type="button" onclick="this.parentElement.parentElement.remove()" class="ml-3 text-gray-400 hover:text-gray-600">
                        <i data-lucide="x" class="w-4 h-4"></i>
                    </button>
                </div>
            `;
            messagesContainer.classList.remove('hidden');
            lucide.createIcons();
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (messagesContainer.innerHTML) {
                    messagesContainer.innerHTML = '';
                    messagesContainer.classList.add('hidden');
                }
            }, 5000);
        }

        // Función para iniciar timer de SMS
        function iniciarTimerSMS() {
            let tiempo = 300; // 5 minutos en segundos
            const timerElement = document.getElementById('sms-timer');
            
            smsTimer = setInterval(() => {
                const minutos = Math.floor(tiempo / 60);
                const segundos = tiempo % 60;
                timerElement.textContent = `${minutos}:${segundos.toString().padStart(2, '0')}`;
                
                if (tiempo <= 0) {
                    clearInterval(smsTimer);
                    timerElement.textContent = '0:00';
                    mostrarMensajePassword('El código SMS ha expirado. Solicita uno nuevo.', 'danger');
                    smsCodeSent = false;
                    smsVerified = false;
                    document.getElementById('sms-verification-section').classList.add('hidden');
                }
                tiempo--;
            }, 1000);
        }

        // Función para enviar código SMS
        async function enviarCodigoSMS() {
            try {
                const response = await fetch('/login/enviar-codigo-sms/', {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                        'X-Requested-With': 'XMLHttpRequest',
                        'Content-Type': 'application/json'
                    }
                });
                
                const result = await response.json();
                
                if (result.success) {
                    mostrarMensajePassword('Código SMS enviado exitosamente.', 'success');
                    smsCodeSent = true;
                    document.getElementById('sms-verification-section').classList.remove('hidden');
                    iniciarTimerSMS();
                } else {
                    mostrarMensajePassword(result.message || 'Error al enviar el código SMS.', 'danger');
                }
            } catch (error) {
                console.error('Error:', error);
                mostrarMensajePassword('Error al enviar el código SMS.', 'danger');
            }
        }

        // Función para verificar código SMS
        async function verificarCodigoSMS() {
            const codigo = document.getElementById('codigo_sms').value;
            
            if (!codigo || codigo.length !== 6) {
                mostrarMensajePassword('Por favor ingresa un código de 6 dígitos.', 'danger');
                return;
            }
            
            try {
                const response = await fetch('/login/verificar-codigo-sms/', {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                        'X-Requested-With': 'XMLHttpRequest',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ codigo: codigo })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    mostrarMensajePassword('Código verificado exitosamente. Ahora puedes cambiar tu contraseña.', 'success');
                    smsVerified = true;
                    document.getElementById('btn-cambiar-password').disabled = false;
                    clearInterval(smsTimer);
                    document.getElementById('sms-timer').textContent = 'Verificado';
                } else {
                    mostrarMensajePassword(result.message || 'Código incorrecto.', 'danger');
                }
            } catch (error) {
                console.error('Error:', error);
                mostrarMensajePassword('Error al verificar el código.', 'danger');
            }
        }

        // Función para confirmar eliminación
        function confirmarEliminar(propiedadId, titulo) {
            propiedadAEliminar = propiedadId;
            document.getElementById('propiedad-titulo-eliminar').textContent = titulo;
            
            const modal = document.getElementById('modal-eliminar-propiedad');
            modal.classList.remove('hidden');
            
            // Recrear iconos
            lucide.createIcons();
        }

        // Función para eliminar propiedad
        async function eliminarPropiedad(propiedadId) {
            try {
                const response = await fetch(`/login/eliminar-propiedad-ajax/${propiedadId}/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Obtener el título de la propiedad antes de eliminarla
                    const row = document.querySelector(`tr[data-propiedad-id="${propiedadId}"]`);
                    const titulo = row ? row.querySelector('td:first-child').textContent.trim() : 'Propiedad';
                    
                    // Remover fila de la tabla
                    if (row) {
                        row.remove();
                    }
                    
                    // Agregar actividad
                    ActivitiesManager.addActivity(
                        'property', 
                        'Propiedad eliminada', 
                        `"${titulo}" removida del catálogo`, 
                        'trash-2', 
                        'red'
                    );
                    
                    // Mostrar mensaje de éxito
                    mostrarMensaje(data.message, 'success');
                    
                    // Cerrar modal
                    const modal = document.getElementById('modal-eliminar-propiedad');
                    modal.classList.add('hidden');
                    
                    // Actualizar contador
                    actualizarContadorPropiedades();
                } else {
                    mostrarMensaje(data.message, 'danger');
                }
            } catch (error) {
                console.error('Error:', error);
                mostrarMensaje('Error al eliminar la propiedad', 'danger');
            }
        }

        // Función para eliminar usuario
        async function eliminarUsuario(usuarioId) {
            try {
                const response = await fetch(`/login/eliminar-usuario-admin/${usuarioId}/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Agregar actividad
                    ActivitiesManager.addActivity(
                        'user', 
                        'Usuario eliminado', 
                        'Usuario administrativo removido del sistema', 
                        'user-minus', 
                        'red'
                    );
                    
                    // Mostrar mensaje de éxito
                    mostrarMensaje(data.message, 'success');
                    
                    // Cerrar modal
                    const modal = document.getElementById('modal-eliminar-usuario');
                    modal.classList.add('hidden');
                    
                    // Recargar la lista de usuarios
                    if (UsuarioModalManager && UsuarioModalManager.cargarUsuarios) {
                        UsuarioModalManager.cargarUsuarios();
                    }
                } else {
                    mostrarMensaje(data.message, 'danger');
                }
            } catch (error) {
                console.error('Error:', error);
                mostrarMensaje('Error al eliminar el usuario', 'danger');
            }
        }

        // Función para mostrar mensajes
        function mostrarMensaje(mensaje, tipo) {
            const alertDiv = document.createElement('div');
            const bgColor = tipo === 'success' ? 'bg-green-50 border-green-200 text-green-800' : 'bg-red-50 border-red-200 text-red-800';
            const iconColor = tipo === 'success' ? 'text-green-600' : 'text-red-600';
            const icon = tipo === 'success' ? 'check-circle' : 'alert-circle';
            
            alertDiv.className = `border rounded-lg p-4 ${bgColor} flex items-start mb-4`;
            alertDiv.innerHTML = `
                <i data-lucide="${icon}" class="w-5 h-5 ${iconColor} mr-3 mt-0.5"></i>
                <div class="flex-1">
                    <p class="text-sm font-medium">${mensaje}</p>
                </div>
                <button type="button" onclick="this.parentElement.remove()" class="ml-3 text-gray-400 hover:text-gray-600">
                    <i data-lucide="x" class="w-4 h-4"></i>
                </button>
            `;
            
            const container = document.querySelector('.flex-1.overflow-y-auto');
            container.insertBefore(alertDiv, container.firstChild);
            
            // Recrear iconos
            lucide.createIcons();
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 5000);
        }

        // Función para actualizar contador de propiedades
        function actualizarContadorPropiedades() {
            const filasVisibles = document.querySelectorAll('#propertiesTableBody tr:not([style*="display: none"])').length;
            const contador = document.getElementById('propiedades-count');
            if (contador) {
                contador.textContent = filasVisibles;
            }
        }

        // Función para búsqueda
        function initSearch() {
            const searchInput = document.getElementById('searchInput');
            if (searchInput) {
                searchInput.addEventListener('keyup', function() {
                    const searchTerm = this.value.toLowerCase();
                    const table = document.getElementById('propertiesTable');
                    const rows = table.getElementsByTagName('tbody')[0].getElementsByTagName('tr');
                    
                    for (let row of rows) {
                        const title = row.querySelector('td:nth-child(2)').textContent.toLowerCase();
                        const location = row.querySelector('td:nth-child(6)').textContent.toLowerCase();
                        
                        if (title.includes(searchTerm) || location.includes(searchTerm)) {
                            row.style.display = '';
                        } else {
                            row.style.display = 'none';
                        }
                    }
                    
                    // Actualizar contador
                    actualizarContadorPropiedades();
                });
            }
        }

        // ========================================
        // INICIALIZACIÓN PRINCIPAL
        // ========================================
        document.addEventListener('DOMContentLoaded', function() {
            try {
                // Inicializar iconos de Lucide
                lucide.createIcons();
                
                // Inicializar todos los módulos
                SidebarManager.init();
                ChartManager.init();
                AnimationManager.init();
                ActivitiesManager.init();
                PropertyModalManager.init();
                UsuarioModalManager.init();
                PropertyManager.init();
                ConfigManager.init();
                
                // Asegurar que la fecha se actualice después de la inicialización
                setTimeout(() => {
                    AnimationManager.updateDate();
                }, 100);
                
                // Actualizar la fecha cada minuto
                setInterval(() => {
                    AnimationManager.updateDate();
                }, 60000);
                
                // Fallback: actualizar fecha inmediatamente
                AnimationManager.updateDate();
                
                // Agregar actividades de ejemplo si no hay ninguna
                setTimeout(() => {
                    const activities = ActivitiesManager.getActivities();
                    if (activities.length === 0) {
                        ActivitiesManager.addActivity('system', 'Dashboard iniciado', 'Sistema de actividades activado', 'zap', 'green');
                        ActivitiesManager.addActivity('info', 'Bienvenido al dashboard', 'Todas las funciones están disponibles', 'home', 'blue');
                    }
                }, 1000);
                
                // Cargar estadísticas de reseñas desde el backend
                setTimeout(() => {
                    cargarEstadisticasResenas();
                }, 500);
                
                // Inicializar funcionalidades de gestión
                initSearch();
                
                // Event listeners para modal de eliminación de propiedades
                document.getElementById('cancelar-eliminar').addEventListener('click', function() {
                    document.getElementById('modal-eliminar-propiedad').classList.add('hidden');
                });
                
                document.getElementById('confirmar-eliminar').addEventListener('click', function() {
                    if (propiedadAEliminar) {
                        eliminarPropiedad(propiedadAEliminar);
                    }
                });
                
                // Event listeners para modal de eliminación de usuarios
                document.getElementById('cancelar-eliminar-usuario').addEventListener('click', function() {
                    document.getElementById('modal-eliminar-usuario').classList.add('hidden');
                });
                
                document.getElementById('confirmar-eliminar-usuario').addEventListener('click', function() {
                    if (usuarioAEliminar) {
                        eliminarUsuario(usuarioAEliminar);
                    }
                });
                
                // Event listeners para gestión de reseñas
                const btnGestionarResenas = document.getElementById('btn-gestionar-resenas');
                const btnRefrescarResenas = document.getElementById('btn-refrescar-resenas');
                
                if (btnGestionarResenas) {
                    btnGestionarResenas.addEventListener('click', function() {
                        showSection('gestion-resenas-content');
                        updateSidebarState('resenas');
                        window.cargarResenas();
                    });
                }
                
                
                if (btnRefrescarResenas) {
                    btnRefrescarResenas.addEventListener('click', function() {
                        window.cargarResenas(currentPage);
                    });
                }
                
                // Event listeners para filtros de reseñas
                const filtroEstado = document.getElementById('filtro-estado');
                const filtroPropiedad = document.getElementById('filtro-propiedad');
                const filtroCalificacion = document.getElementById('filtro-calificacion');
                
                if (filtroEstado) {
                    filtroEstado.addEventListener('change', function() {
                        aplicarFiltrosResenas();
                    });
                }
                
                if (filtroPropiedad) {
                    filtroPropiedad.addEventListener('change', function() {
                        aplicarFiltrosResenas();
                    });
                }
                
                if (filtroCalificacion) {
                    filtroCalificacion.addEventListener('change', function() {
                        aplicarFiltrosResenas();
                    });
                }
                
                // Event listener para botón limpiar filtros
                const btnLimpiarFiltros = document.getElementById('btn-limpiar-filtros');
                if (btnLimpiarFiltros) {
                    btnLimpiarFiltros.addEventListener('click', function() {
                        // Resetear todos los filtros a sus valores por defecto
                        if (filtroEstado) filtroEstado.value = 'todos';
                        if (filtroPropiedad) filtroPropiedad.value = 'todas';
                        if (filtroCalificacion) filtroCalificacion.value = 'todas';
                        
                        // Recargar reseñas sin filtros
                        window.cargarResenas(1);
                    });
                }
                
                // Event listeners para botones "Volver al Inicio"
                const btnVolverInicioConfig = document.getElementById('btn-volver-inicio-config');
                const btnVolverInicioResenas = document.getElementById('btn-volver-inicio-resenas');
                const btnVolverInicioGestion = document.getElementById('btn-volver-inicio-gestion');
                
                if (btnVolverInicioConfig) {
                    btnVolverInicioConfig.addEventListener('click', function() {
                        showSection('dashboard-content');
                        updateSidebarState('dashboard');
                    });
                }
                
                if (btnVolverInicioResenas) {
                    btnVolverInicioResenas.addEventListener('click', function() {
                        showSection('dashboard-content');
                        updateSidebarState('dashboard');
                    });
                }
                
                if (btnVolverInicioGestion) {
                    btnVolverInicioGestion.addEventListener('click', function() {
                        showSection('dashboard-content');
                        updateSidebarState('dashboard');
                    });
                }
                
                console.log('Dashboard inicializado correctamente');
            } catch (error) {
                console.error('Error al inicializar el dashboard:', error);
            }
        });

        // ========================================
        // MÓDULO: GESTIÓN DE RESEÑAS
        // ========================================
        
        // Variable para la página actual
        let currentPage = 1;

        // Función para ver una propiedad específica
        window.verPropiedad = function(propiedadId) {
            console.log('Ver propiedad:', propiedadId);
            // Aquí puedes implementar la lógica para mostrar la propiedad
            // Por ejemplo, abrir un modal o navegar a la página de la propiedad
            alert(`Ver propiedad con ID: ${propiedadId}`);
        };

        // Función para aplicar filtros de reseñas
        function aplicarFiltrosResenas() {
            const filtroEstado = document.getElementById('filtro-estado')?.value || 'todos';
            const filtroPropiedad = document.getElementById('filtro-propiedad')?.value || 'todas';
            const filtroCalificacion = document.getElementById('filtro-calificacion')?.value || 'todas';
            
            // Recargar reseñas con los filtros aplicados
            window.cargarResenas(1, {
                estado: filtroEstado,
                propiedad: filtroPropiedad,
                calificacion: filtroCalificacion
            });
        }

        // Función para eliminar reseña
        async function eliminarResena(resenaId) {
            // Crear modal de confirmación personalizado
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-xl shadow-2xl max-w-md w-full mx-4 transform transition-all duration-300 scale-100">
                    <!-- Header del modal -->
                    <div class="bg-gradient-to-r from-red-500 to-red-600 px-6 py-4 rounded-t-xl">
                        <div class="flex items-center">
                            <div class="w-10 h-10 bg-white bg-opacity-20 rounded-full flex items-center justify-center mr-3">
                                <i data-lucide="trash-2" class="w-6 h-6 text-white"></i>
                            </div>
                            <div>
                                <h3 class="text-lg font-bold text-white">Eliminar Reseña</h3>
                                <p class="text-red-100 text-sm">Acción irreversible</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Contenido del modal -->
                    <div class="px-6 py-6">
                        <div class="flex items-start space-x-4">
                            <div class="w-12 h-12 bg-red-100 rounded-full flex items-center justify-center flex-shrink-0">
                                <i data-lucide="alert-triangle" class="w-6 h-6 text-red-600"></i>
                            </div>
                            <div class="flex-1">
                                <h4 class="text-lg font-semibold text-gray-900 mb-2">¿Estás seguro?</h4>
                                <p class="text-gray-600 mb-4">Esta reseña será eliminada permanentemente del sistema. Esta acción no se puede deshacer.</p>
                                <div class="bg-red-50 border border-red-200 rounded-lg p-3">
                                    <div class="flex items-center">
                                        <i data-lucide="info" class="w-4 h-4 text-red-600 mr-2"></i>
                                        <span class="text-sm text-red-700 font-medium">Se actualizarán automáticamente todos los contadores</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Botones del modal -->
                    <div class="px-6 py-4 bg-gray-50 rounded-b-xl flex justify-end space-x-3">
                        <button id="cancelar-eliminar" class="px-6 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition-colors font-medium">
                            Cancelar
                        </button>
                        <button id="confirmar-eliminar" class="px-6 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors font-medium flex items-center">
                            <i data-lucide="trash-2" class="w-4 h-4 mr-2"></i>
                            Eliminar Reseña
                        </button>
                    </div>
                </div>
            `;
            
            // Agregar el modal al DOM
            document.body.appendChild(modal);
            
            // Inicializar iconos de Lucide
            lucide.createIcons();
            
            // Crear una promesa para manejar la respuesta
            return new Promise((resolve) => {
                const cancelarBtn = modal.querySelector('#cancelar-eliminar');
                const confirmarBtn = modal.querySelector('#confirmar-eliminar');
                
                const limpiarModal = () => {
                    modal.remove();
                };
                
                cancelarBtn.addEventListener('click', () => {
                    limpiarModal();
                    resolve(false);
                });
                
                confirmarBtn.addEventListener('click', async () => {
                    limpiarModal();
                    resolve(true);
                });
                
                // Cerrar al hacer clic fuera del modal
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        limpiarModal();
                        resolve(false);
                    }
                });
                
                // Cerrar con tecla Escape
                const handleEscape = (e) => {
                    if (e.key === 'Escape') {
                        limpiarModal();
                        resolve(false);
                        document.removeEventListener('keydown', handleEscape);
                    }
                };
                document.addEventListener('keydown', handleEscape);
            }).then(async (confirmado) => {
                if (!confirmado) {
                    return;
                }

            try {
                const response = await fetch(`{% url "login:eliminar_resena" %}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                    },
                    body: JSON.stringify({
                        resena_id: resenaId
                    })
                });

                const data = await response.json();

                if (data.success) {
                    // Eliminar el elemento visual de la lista inmediatamente
                    const resenaElement = document.querySelector(`[data-resena-id="${resenaId}"]`);
                    if (resenaElement) {
                        // Agregar animación de desvanecimiento antes de eliminar
                        resenaElement.style.transition = 'all 0.3s ease';
                        resenaElement.style.opacity = '0';
                        resenaElement.style.transform = 'translateX(-100%)';
                        
                        setTimeout(() => {
                            resenaElement.remove();
                        }, 300);
                    }
                    
                    // Agregar actividad
                    ActivitiesManager.addActivity(
                        'review', 
                        'Reseña eliminada', 
                        'Reseña eliminada permanentemente del sistema', 
                        'trash-2', 
                        'red'
                    );
                    
                    // Actualizar estadísticas inmediatamente
                    cargarEstadisticasResenas();
                    
                    // Mostrar notificación
                    mostrarNotificacion('success', 'Reseña eliminada exitosamente', 'La reseña ha sido eliminada permanentemente.');
                    
                    // Limpiar completamente la interfaz y recargar
                    setTimeout(() => {
                        // Limpiar cualquier elemento residual
                        const resenasList = document.getElementById('resenas-list');
                        if (resenasList) {
                            // Limpiar completamente la lista
                            resenasList.innerHTML = '';
                        }
                        
                        // Limpiar cualquier estado residual de filtros
                        const filtroEstado = document.getElementById('filtro-estado');
                        const filtroPropiedad = document.getElementById('filtro-propiedad');
                        const filtroCalificacion = document.getElementById('filtro-calificacion');
                        
                        if (filtroEstado && filtroEstado.value !== 'todos') {
                            filtroEstado.value = 'todos';
                        }
                        if (filtroPropiedad && filtroPropiedad.value !== 'todas') {
                            filtroPropiedad.value = 'todas';
                        }
                        if (filtroCalificacion && filtroCalificacion.value !== 'todas') {
                            filtroCalificacion.value = 'todas';
                        }
                        
                        // Recargar la lista de reseñas
                        window.cargarResenas(currentPage);
                    }, 500);
                } else {
                    mostrarNotificacion('error', 'Error al eliminar reseña', data.message || 'No se pudo eliminar la reseña.');
                }
            } catch (error) {
                console.error('Error al eliminar reseña:', error);
                mostrarNotificacion('error', 'Error al eliminar reseña', 'Ocurrió un error inesperado.');
            }
            });
        }
        
        // Hacer las funciones globales para que puedan ser llamadas desde onclick
        window.eliminarResena = eliminarResena;
        window.cargarResenas = async function(page = 1, filtros = {}) {
            try {
                currentPage = page;
                
                // Construir parámetros de la URL
                const params = new URLSearchParams();
                params.append('page', page);
                
                if (filtros.estado && filtros.estado !== 'todos') {
                    params.append('estado', filtros.estado);
                }
                if (filtros.propiedad && filtros.propiedad !== 'todas') {
                    params.append('propiedad', filtros.propiedad);
                }
                if (filtros.calificacion && filtros.calificacion !== 'todas') {
                    params.append('calificacion', filtros.calificacion);
                }
                
                const response = await fetch(`{% url "login:gestionar_resenas" %}?${params.toString()}`);
                const data = await response.json();
                
                if (data.success) {
                    const resenasList = document.getElementById('resenas-list');
                    const resenasCount = document.getElementById('resenas-count');
                    
                    resenasList.innerHTML = '';
                    resenasCount.textContent = data.pagination.total_resenas;
                    
                    // Actualizar contadores con datos reales del backend
                    if (data.estadisticas) {
                        // Actualizar el total en el dashboard
                        actualizarTotalResenas(data.estadisticas.total);
                        
                        // Actualizar los contadores individuales en la vista de reseñas
                        const esperaElement = document.getElementById('resenasEspera');
                        const aceptadasElement = document.getElementById('resenasAceptadas');
                        const rechazadasElement = document.getElementById('resenasRechazadas');
                        
                        if (esperaElement) esperaElement.textContent = data.estadisticas.en_espera || 0;
                        if (aceptadasElement) aceptadasElement.textContent = data.estadisticas.aceptadas || 0;
                        if (rechazadasElement) rechazadasElement.textContent = data.estadisticas.rechazadas || 0;
                    }
                    
                    if (data.resenas.length === 0) {
                        resenasList.innerHTML = `
                            <div class="text-center py-6 sm:py-8 text-gray-500">
                                <i data-lucide="star" class="w-8 h-8 sm:w-12 sm:h-12 mx-auto mb-3 sm:mb-4 text-gray-300"></i>
                                <p class="text-sm sm:text-base">No hay reseñas para moderar</p>
                            </div>
                        `;
                    } else {
                        data.resenas.forEach(resena => {
                        const resenaElement = document.createElement('div');
                        resenaElement.className = 'bg-white rounded-lg border border-gray-200 p-4 sm:p-6 mb-3 sm:mb-4';
                        resenaElement.setAttribute('data-resena-id', resena.id);
                            
                            // Generar estrellas con Lucide icons
                            let estrellas = '';
                            for (let i = 1; i <= 5; i++) {
                                if (i <= resena.calificacion) {
                                    estrellas += '<i data-lucide="star" class="w-4 h-4 text-yellow-400 fill-current"></i>';
                                } else {
                                    estrellas += '<i data-lucide="star" class="w-4 h-4 text-gray-300"></i>';
                                }
                            }
                            
                            // Determinar color del estado
                            let estadoColor = '';
                            let estadoTexto = '';
                            switch(resena.estado) {
                                case 'Pendiente de Aprobación':
                                    estadoColor = 'bg-yellow-100 text-yellow-800';
                                    estadoTexto = 'Pendiente';
                                    break;
                                case 'Aprobada':
                                    estadoColor = 'bg-green-100 text-green-800';
                                    estadoTexto = 'Aprobada';
                                    break;
                                case 'Rechazada':
                                    estadoColor = 'bg-red-100 text-red-800';
                                    estadoTexto = 'Rechazada';
                                    break;
                            }
                            
                            resenaElement.innerHTML = `
                                <div class="bg-gradient-to-r from-white to-gray-50 rounded-xl border border-gray-200 shadow-sm hover:shadow-md transition-all duration-300">
                                    <!-- Header de la reseña -->
                                    <div class="bg-gradient-to-r from-blue-50 to-indigo-50 px-4 sm:px-6 py-3 sm:py-4 rounded-t-xl border-b border-gray-200">
                                        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between">
                                            <div class="flex items-center space-x-3 sm:space-x-4 mb-2 sm:mb-0">
                                                <!-- Avatar del usuario -->
                                                <div class="w-10 h-10 sm:w-12 sm:h-12 bg-gradient-to-r from-blue-500 to-indigo-600 rounded-full flex items-center justify-center text-white font-bold text-sm sm:text-lg flex-shrink-0">
                                                    ${resena.nombre_usuario.charAt(0).toUpperCase()}
                                                </div>
                                                <div class="min-w-0 flex-1">
                                                    <h4 class="font-bold text-gray-900 text-base sm:text-lg truncate">${resena.nombre_usuario}</h4>
                                                    <p class="text-xs sm:text-sm text-gray-600 flex items-center truncate">
                                                        <i data-lucide="mail" class="w-3 h-3 mr-1 flex-shrink-0"></i>
                                                        <span class="truncate">${resena.email_usuario}</span>
                                                    </p>
                                                </div>
                                            </div>
                                            <span class="px-2 sm:px-3 py-1 rounded-full text-xs sm:text-sm font-medium ${estadoColor} shadow-sm self-start sm:self-auto">
                                                ${estadoTexto}
                                            </span>
                                        </div>
                                    </div>
                                    
                                    <!-- Contenido principal -->
                                    <div class="p-4 sm:p-6">
                                        <!-- Calificación destacada -->
                                        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-3 sm:mb-4">
                                            <div class="flex items-center space-x-2 sm:space-x-3 mb-2 sm:mb-0">
                                                <div class="flex items-center space-x-1">
                                                    ${estrellas}
                                                </div>
                                                <span class="text-base sm:text-lg font-bold text-gray-900">${resena.calificacion}/5</span>
                                            </div>
                                            <div class="text-xs sm:text-sm text-gray-500 flex items-center">
                                                <i data-lucide="calendar" class="w-3 h-3 sm:w-4 sm:h-4 mr-1"></i>
                                                ${resena.fecha_creacion}
                                            </div>
                                        </div>
                                        
                                        <!-- Propiedad -->
                                        <div class="mb-3 sm:mb-4">
                                            <h6 class="text-xs sm:text-sm font-semibold text-gray-700 mb-1 sm:mb-2 flex items-center">
                                                <i data-lucide="home" class="w-3 h-3 sm:w-4 sm:h-4 mr-1 sm:mr-2 text-blue-600"></i>
                                                Propiedad
                                            </h6>
                                            <div class="p-2 sm:p-3 bg-gray-50 rounded-lg border border-gray-200">
                                                <span class="text-blue-600 font-semibold cursor-pointer hover:text-blue-800 transition-colors text-sm sm:text-base truncate block" onclick="verPropiedad(${resena.propiedad_id})">
                                                    ${resena.propiedad_titulo}
                                                </span>
                                            </div>
                                        </div>
                                        
                                        <!-- Título de la reseña -->
                                        ${resena.titulo ? `
                                        <div class="mb-3 sm:mb-4">
                                            <h6 class="text-xs sm:text-sm font-semibold text-gray-700 mb-1 sm:mb-2 flex items-center">
                                                <i data-lucide="message-square" class="w-3 h-3 sm:w-4 sm:h-4 mr-1 sm:mr-2 text-green-600"></i>
                                                Título de la Reseña
                                            </h6>
                                            <div class="bg-white rounded-lg p-3 sm:p-4 border border-gray-200 shadow-sm">
                                                <h5 class="font-bold text-gray-900 text-base sm:text-lg">"${resena.titulo}"</h5>
                                            </div>
                                        </div>
                                        ` : ''}
                                        
                                        <!-- Comentario -->
                                        <div class="mb-3 sm:mb-4">
                                            <h6 class="text-xs sm:text-sm font-semibold text-gray-700 mb-1 sm:mb-2 flex items-center">
                                                <i data-lucide="file-text" class="w-3 h-3 sm:w-4 sm:h-4 mr-1 sm:mr-2 text-purple-600"></i>
                                                Descripción
                                            </h6>
                                            <div class="bg-white rounded-lg p-3 sm:p-4 border border-gray-200 shadow-sm">
                                                <p class="text-gray-700 leading-relaxed italic text-sm sm:text-base">"${resena.comentario}"</p>
                                            </div>
                                        </div>
                                    </div>
                                    
                    <!-- Botones de acción -->
                    ${resena.estado === 'Pendiente de Aprobación' ? `
                    <div class="bg-gray-50 px-4 sm:px-6 py-3 sm:py-4 rounded-b-xl border-t border-gray-200">
                        <div class="flex flex-col sm:flex-row gap-2 sm:gap-3">
                            <button onclick="aprobarResena(${resena.id})" class="flex-1 bg-gradient-to-r from-green-500 to-green-600 text-white px-4 sm:px-6 py-2 sm:py-3 rounded-lg hover:from-green-600 hover:to-green-700 transition-all duration-200 text-xs sm:text-sm font-medium flex items-center justify-center shadow-sm hover:shadow-md">
                                <i data-lucide="check" class="w-3 h-3 sm:w-4 sm:h-4 mr-1 sm:mr-2"></i>
                                Aprobar Reseña
                            </button>
                            <button onclick="rechazarResena(${resena.id})" class="flex-1 bg-gradient-to-r from-red-500 to-red-600 text-white px-4 sm:px-6 py-2 sm:py-3 rounded-lg hover:from-red-600 hover:to-red-700 transition-all duration-200 text-xs sm:text-sm font-medium flex items-center justify-center shadow-sm hover:shadow-md">
                                <i data-lucide="x" class="w-3 h-3 sm:w-4 sm:h-4 mr-1 sm:mr-2"></i>
                                Rechazar Reseña
                            </button>
                        </div>
                    </div>
                    ` : (resena.estado === 'Aprobada' || resena.estado === 'Rechazada') ? `
                    <div class="bg-gray-50 px-4 sm:px-6 py-3 sm:py-4 rounded-b-xl border-t border-gray-200">
                        <div class="flex justify-end">
                            <button onclick="eliminarResena(${resena.id})" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition-colors text-sm font-medium flex items-center shadow-sm hover:shadow-md">
                                <i data-lucide="trash-2" class="w-4 h-4 mr-2"></i>
                                Eliminar Reseña
                            </button>
                        </div>
                    </div>
                    ` : ''}
                                </div>
                            `;
                            resenasList.appendChild(resenaElement);
                        });
                    }
                    
                    // Agregar controles de paginación
                    if (data.pagination.total_pages > 1) {
                        const paginationHTML = crearControlesPaginacion(data.pagination);
                        resenasList.appendChild(paginationHTML);
                    }
                    
                    // Reinicializar iconos
                    lucide.createIcons();
                } else {
                    console.error('Error al cargar reseñas:', data.message);
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }

        // Función para crear controles de paginación
        function crearControlesPaginacion(pagination) {
            const paginationDiv = document.createElement('div');
            paginationDiv.className = 'pagination-container';
            paginationDiv.style.cssText = `
                display: flex;
                justify-content: center;
                align-items: center;
                gap: 10px;
                margin-top: 30px;
                padding: 20px;
                background: #f8f9fa;
                border-radius: 10px;
                border: 1px solid #e9ecef;
            `;
            
            let paginationHTML = `
                <div style="display: flex; align-items: center; gap: 15px;">
                    <span style="color: #6c757d; font-size: 14px;">
                        Página ${pagination.current_page} de ${pagination.total_pages} 
                        (${pagination.total_resenas} reseñas)
                    </span>
                    
                    <div style="display: flex; gap: 5px;">
            `;
            
            // Botón anterior
            if (pagination.has_previous) {
                paginationHTML += `
                    <button onclick="cargarResenas(${pagination.previous_page})" style="
                        background: #007bff;
                        color: white;
                        border: none;
                        padding: 8px 12px;
                        border-radius: 6px;
                        cursor: pointer;
                        font-size: 14px;
                        transition: all 0.2s ease;
                    " onmouseover="this.style.background='#0056b3'" 
                       onmouseout="this.style.background='#007bff'">
                        <i class="fas fa-chevron-left"></i> Anterior
                    </button>
                `;
            } else {
                paginationHTML += `
                    <button disabled style="
                        background: #e9ecef;
                        color: #6c757d;
                        border: none;
                        padding: 8px 12px;
                        border-radius: 6px;
                        font-size: 14px;
                        cursor: not-allowed;
                    ">
                        <i class="fas fa-chevron-left"></i> Anterior
                    </button>
                `;
            }
            
            // Números de página
            const startPage = Math.max(1, pagination.current_page - 2);
            const endPage = Math.min(pagination.total_pages, pagination.current_page + 2);
            
            for (let i = startPage; i <= endPage; i++) {
                if (i === pagination.current_page) {
                    paginationHTML += `
                        <button style="
                            background: #28a745;
                            color: white;
                            border: none;
                            padding: 8px 12px;
                            border-radius: 6px;
                            font-size: 14px;
                            font-weight: bold;
                        ">${i}</button>
                    `;
                } else {
                    paginationHTML += `
                        <button onclick="cargarResenas(${i})" style="
                            background: white;
                            color: #007bff;
                            border: 1px solid #007bff;
                            padding: 8px 12px;
                            border-radius: 6px;
                            cursor: pointer;
                            font-size: 14px;
                            transition: all 0.2s ease;
                        " onmouseover="this.style.background='#007bff'; this.style.color='white'" 
                           onmouseout="this.style.background='white'; this.style.color='#007bff'">
                            ${i}
                        </button>
                    `;
                }
            }
            
            // Botón siguiente
            if (pagination.has_next) {
                paginationHTML += `
                    <button onclick="cargarResenas(${pagination.next_page})" style="
                        background: #007bff;
                        color: white;
                        border: none;
                        padding: 8px 12px;
                        border-radius: 6px;
                        cursor: pointer;
                        font-size: 14px;
                        transition: all 0.2s ease;
                    " onmouseover="this.style.background='#0056b3'" 
                       onmouseout="this.style.background='#007bff'">
                        Siguiente <i class="fas fa-chevron-right"></i>
                    </button>
                `;
            } else {
                paginationHTML += `
                    <button disabled style="
                        background: #e9ecef;
                        color: #6c757d;
                        border: none;
                        padding: 8px 12px;
                        border-radius: 6px;
                        font-size: 14px;
                        cursor: not-allowed;
                    ">
                        Siguiente <i class="fas fa-chevron-right"></i>
                    </button>
                `;
            }
            
            paginationHTML += `
                    </div>
                </div>
            `;
            
            paginationDiv.innerHTML = paginationHTML;
            return paginationDiv;
        }

        // Función para aprobar reseña
        window.aprobarResena = async function(resenaId) {
            if (!confirm('¿Estás seguro de que quieres aprobar esta reseña?')) {
                return;
            }
            
            try {
                const response = await fetch(`/login/aprobar-resena/${resenaId}/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                        'Content-Type': 'application/json',
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Agregar actividad
                    ActivitiesManager.addActivity(
                        'review', 
                        'Reseña aprobada', 
                        'Nueva reseña aprobada y publicada', 
                        'check-circle', 
                        'green'
                    );
                    
                    // Recargar estadísticas desde el backend
                    cargarEstadisticasResenas();
                    
                    mostrarNotificacion('success', 'Reseña aprobada exitosamente', 'La reseña ha sido aprobada y ahora es visible públicamente.');
                    window.cargarResenas(currentPage); // Recargar la lista manteniendo la página actual
                } else {
                    mostrarNotificacion('error', 'Error al aprobar la reseña', data.message);
                }
            } catch (error) {
                console.error('Error:', error);
                mostrarNotificacion('error', 'Error al aprobar la reseña', 'Por favor intenta de nuevo.');
            }
        }

        // Función para rechazar reseña
        window.rechazarResena = async function(resenaId) {
            mostrarConfirmacionRechazo(resenaId);
        }

        // ========================================
        // SISTEMA DE NOTIFICACIONES HERMOSAS
        // ========================================
        
        // Función para mostrar notificaciones hermosas
        function mostrarNotificacion(tipo, titulo, mensaje, duracion = 4000) {
            // Crear el contenedor de notificaciones si no existe
            let container = document.getElementById('notificaciones-container');
            if (!container) {
                container = document.createElement('div');
                container.id = 'notificaciones-container';
                container.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    z-index: 10000;
                    display: flex;
                    flex-direction: column;
                    gap: 10px;
                `;
                document.body.appendChild(container);
            }
            
            // Definir colores y iconos según el tipo
            const configs = {
                success: {
                    color: '#4CAF50',
                    icon: 'fas fa-check-circle',
                    bgColor: 'linear-gradient(135deg, #4CAF50, #45a049)',
                    borderColor: '#4CAF50'
                },
                error: {
                    color: '#f44336',
                    icon: 'fas fa-exclamation-circle',
                    bgColor: 'linear-gradient(135deg, #f44336, #d32f2f)',
                    borderColor: '#f44336'
                },
                warning: {
                    color: '#ff9800',
                    icon: 'fas fa-exclamation-triangle',
                    bgColor: 'linear-gradient(135deg, #ff9800, #f57c00)',
                    borderColor: '#ff9800'
                },
                info: {
                    color: '#2196F3',
                    icon: 'fas fa-info-circle',
                    bgColor: 'linear-gradient(135deg, #2196F3, #1976D2)',
                    borderColor: '#2196F3'
                }
            };
            
            const config = configs[tipo] || configs.info;
            
            // Crear la notificación
            const notificacion = document.createElement('div');
            notificacion.style.cssText = `
                background: white;
                border-radius: 12px;
                padding: 20px;
                box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
                border-left: 4px solid ${config.borderColor};
                max-width: 400px;
                min-width: 300px;
                position: relative;
                animation: slideInRight 0.4s ease;
                cursor: pointer;
                transition: all 0.3s ease;
            `;
            
            notificacion.innerHTML = `
                <div style="display: flex; align-items: flex-start; gap: 15px;">
                    <div style="
                        width: 40px;
                        height: 40px;
                        background: ${config.bgColor};
                        border-radius: 50%;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        flex-shrink: 0;
                        animation: pulse 0.6s ease;
                    ">
                        <i class="${config.icon}" style="color: white; font-size: 18px;"></i>
                    </div>
                    
                    <div style="flex: 1;">
                        <h4 style="
                            margin: 0 0 8px 0;
                            color: #2c3e50;
                            font-size: 16px;
                            font-weight: 600;
                        ">${titulo}</h4>
                        
                        <p style="
                            margin: 0;
                            color: #7f8c8d;
                            font-size: 14px;
                            line-height: 1.4;
                        ">${mensaje}</p>
                    </div>
                    
                    <button onclick="cerrarNotificacion(this)" style="
                        background: none;
                        border: none;
                        color: #bdc3c7;
                        font-size: 18px;
                        cursor: pointer;
                        padding: 0;
                        width: 24px;
                        height: 24px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        border-radius: 50%;
                        transition: all 0.2s ease;
                    " onmouseover="this.style.background='#ecf0f1'; this.style.color='#e74c3c'" 
                       onmouseout="this.style.background='none'; this.style.color='#bdc3c7'">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <div style="
                    position: absolute;
                    bottom: 0;
                    left: 0;
                    height: 3px;
                    background: ${config.bgColor};
                    border-radius: 0 0 12px 12px;
                    animation: progressBar ${duracion}ms linear;
                "></div>
            `;
            
            // Agregar estilos CSS si no existen
            if (!document.getElementById('notificaciones-styles')) {
                const styles = document.createElement('style');
                styles.id = 'notificaciones-styles';
                styles.textContent = `
                    @keyframes slideInRight {
                        from {
                            opacity: 0;
                            transform: translateX(100%);
                        }
                        to {
                            opacity: 1;
                            transform: translateX(0);
                        }
                    }
                    
                    @keyframes slideOutRight {
                        from {
                            opacity: 1;
                            transform: translateX(0);
                        }
                        to {
                            opacity: 0;
                            transform: translateX(100%);
                        }
                    }
                    
                    @keyframes pulse {
                        0% { transform: scale(1); }
                        50% { transform: scale(1.1); }
                        100% { transform: scale(1); }
                    }
                    
                    @keyframes progressBar {
                        from { width: 100%; }
                        to { width: 0%; }
                    }
                `;
                document.head.appendChild(styles);
            }
            
            // Agregar efecto hover
            notificacion.addEventListener('mouseenter', () => {
                notificacion.style.transform = 'translateX(-5px)';
                notificacion.style.boxShadow = '0 15px 40px rgba(0, 0, 0, 0.25)';
            });
            
            notificacion.addEventListener('mouseleave', () => {
                notificacion.style.transform = 'translateX(0)';
                notificacion.style.boxShadow = '0 10px 30px rgba(0, 0, 0, 0.2)';
            });
            
            // Agregar a la página
            container.appendChild(notificacion);
            
            // Auto-eliminar después del tiempo especificado
            setTimeout(() => {
                if (notificacion.parentNode) {
                    cerrarNotificacion(notificacion.querySelector('button'));
                }
            }, duracion);
        }
        
        // Función para cerrar notificaciones
        function cerrarNotificacion(button) {
            const notificacion = button.closest('div');
            notificacion.style.animation = 'slideOutRight 0.3s ease';
            setTimeout(() => {
                if (notificacion.parentNode) {
                    notificacion.remove();
                }
            }, 300);
        }

        // Función para mostrar confirmación de rechazo hermoso
        function mostrarConfirmacionRechazo(resenaId) {
            // Crear el modal de confirmación
            const confirmModal = document.createElement('div');
            confirmModal.id = 'modal-confirmacion-rechazo';
            confirmModal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.6);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 10001;
                animation: fadeIn 0.3s ease;
            `;
            
            confirmModal.innerHTML = `
                <div style="
                    background: white;
                    border-radius: 20px;
                    padding: 40px;
                    text-align: center;
                    max-width: 500px;
                    width: 90%;
                    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
                    animation: slideIn 0.4s ease;
                    position: relative;
                ">
                    <div style="
                        width: 80px;
                        height: 80px;
                        background: linear-gradient(135deg, #f44336, #d32f2f);
                        border-radius: 50%;
                        margin: 0 auto 20px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        animation: pulse 0.6s ease;
                    ">
                        <i class="fas fa-exclamation-triangle" style="color: white; font-size: 32px;"></i>
                    </div>
                    
                    <h3 style="
                        color: #2c3e50;
                        margin-bottom: 15px;
                        font-size: 24px;
                        font-weight: 600;
                    ">¿Rechazar Reseña?</h3>
                    
                    <p style="
                        color: #7f8c8d;
                        font-size: 16px;
                        line-height: 1.5;
                        margin-bottom: 25px;
                    ">¿Estás seguro de que quieres rechazar esta reseña? Esta acción no se puede deshacer.</p>
                    
                    <div style="
                        background: #fff3cd;
                        border: 1px solid #ffeaa7;
                        border-radius: 10px;
                        padding: 15px;
                        margin-bottom: 25px;
                        border-left: 4px solid #f39c12;
                    ">
                        <p style="
                            color: #856404;
                            font-size: 14px;
                            margin: 0;
                            font-style: italic;
                        ">⚠️ La reseña será rechazada y no se mostrará públicamente</p>
                    </div>
                    
                    <div style="display: flex; gap: 15px; justify-content: center;">
                        <button onclick="cerrarConfirmacionRechazo()" style="
                            background: #6c757d;
                            color: white;
                            border: none;
                            padding: 12px 30px;
                            border-radius: 25px;
                            font-size: 16px;
                            font-weight: 600;
                            cursor: pointer;
                            transition: all 0.3s ease;
                            box-shadow: 0 4px 15px rgba(108, 117, 125, 0.3);
                        " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(108, 117, 125, 0.4)'" 
                           onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(108, 117, 125, 0.3)'">
                            <i class="fas fa-times" style="margin-right: 8px;"></i>
                            Cancelar
                        </button>
                        
                        <button onclick="confirmarRechazoResena(${resenaId})" style="
                            background: linear-gradient(135deg, #f44336, #d32f2f);
                            color: white;
                            border: none;
                            padding: 12px 30px;
                            border-radius: 25px;
                            font-size: 16px;
                            font-weight: 600;
                            cursor: pointer;
                            transition: all 0.3s ease;
                            box-shadow: 0 4px 15px rgba(244, 67, 54, 0.3);
                        " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(244, 67, 54, 0.4)'" 
                           onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(244, 67, 54, 0.3)'">
                            <i class="fas fa-ban" style="margin-right: 8px;"></i>
                            Rechazar
                        </button>
                    </div>
                </div>
            `;
            
            // Agregar estilos CSS para las animaciones si no existen
            if (!document.getElementById('confirm-modal-styles')) {
                const styles = document.createElement('style');
                styles.id = 'confirm-modal-styles';
                styles.textContent = `
                    @keyframes fadeIn {
                        from { opacity: 0; }
                        to { opacity: 1; }
                    }
                    
                    @keyframes slideIn {
                        from { 
                            opacity: 0;
                            transform: translateY(-50px) scale(0.9);
                        }
                        to { 
                            opacity: 1;
                            transform: translateY(0) scale(1);
                        }
                    }
                    
                    @keyframes pulse {
                        0%, 20%, 50%, 80%, 100% {
                            transform: scale(1);
                        }
                        40% {
                            transform: scale(1.1);
                        }
                        60% {
                            transform: scale(1.05);
                        }
                    }
                    
                    @keyframes fadeOut {
                        from { opacity: 1; }
                        to { opacity: 0; }
                    }
                `;
                document.head.appendChild(styles);
            }
            
            document.body.appendChild(confirmModal);
            
            // Cerrar modal al hacer clic fuera de él
            confirmModal.addEventListener('click', function(e) {
                if (e.target === confirmModal) {
                    cerrarConfirmacionRechazo();
                }
            });
            
            // Cerrar modal con tecla Escape
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape' && document.getElementById('modal-confirmacion-rechazo')) {
                    cerrarConfirmacionRechazo();
                }
            });
        }

        // Función para cerrar el modal de confirmación
        function cerrarConfirmacionRechazo() {
            const modal = document.getElementById('modal-confirmacion-rechazo');
            if (modal) {
                modal.style.animation = 'fadeOut 0.3s ease';
                setTimeout(() => {
                    if (modal.parentNode) {
                        modal.remove();
                    }
                }, 300);
            }
        }

        // Función para eliminar reseña de la lista actual
        function eliminarResenaDeLista(resenaId) {
            const resenasList = document.getElementById('resenas-list');
            const resenaElement = resenasList.querySelector(`[data-resena-id="${resenaId}"]`);
            
            if (resenaElement) {
                // Animación de desvanecimiento
                resenaElement.style.transition = 'all 0.3s ease';
                resenaElement.style.opacity = '0';
                resenaElement.style.transform = 'translateX(-100%)';
                
                setTimeout(() => {
                    if (resenaElement.parentNode) {
                        resenaElement.remove();
                        
                        // Actualizar contador
                        const resenasCount = document.getElementById('resenas-count');
                        if (resenasCount) {
                            const currentCount = parseInt(resenasCount.textContent) || 0;
                            resenasCount.textContent = Math.max(0, currentCount - 1);
                        }
                        
                        // Verificar si la página quedó vacía
                        const resenasRestantes = resenasList.querySelectorAll('[data-resena-id]');
                        if (resenasRestantes.length === 0) {
                            // Si no hay más reseñas en la página actual, recargar
                            window.cargarResenas(currentPage);
                        }
                    }
                }, 300);
            }
        }

        // Función para limpiar todos los modales
        function limpiarModales() {
            const modales = [
                'modal-confirmacion-rechazo',
                'modal-exito-resena'
            ];
            
            modales.forEach(id => {
                const modal = document.getElementById(id);
                if (modal && modal.parentNode) {
                    modal.remove();
                }
            });
        }

        // Función para confirmar el rechazo
        async function confirmarRechazoResena(resenaId) {
            cerrarConfirmacionRechazo();
            
            try {
                const response = await fetch(`/login/rechazar-resena/${resenaId}/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                        'Content-Type': 'application/json',
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Agregar actividad
                    ActivitiesManager.addActivity(
                        'review', 
                        'Reseña rechazada', 
                        'Reseña rechazada y eliminada del sistema', 
                        'x-circle', 
                        'red'
                    );
                    
                    // Recargar estadísticas desde el backend
                    cargarEstadisticasResenas();
                    
                    mostrarNotificacion('success', 'Reseña rechazada exitosamente', 'La reseña ha sido rechazada y eliminada de la lista.');
                    // Eliminar la reseña de la lista actual sin recargar
                    eliminarResenaDeLista(resenaId);
                } else {
                    mostrarNotificacion('error', 'Error al rechazar la reseña', data.message);
                }
            } catch (error) {
                console.error('Error:', error);
                mostrarNotificacion('error', 'Error al rechazar la reseña', 'Por favor intenta de nuevo.');
            }
        }
    </script>
    
    <!-- Optimized Dashboard JavaScript -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            'use strict';
            
            // Get configuration and utilities
            const CONFIG = window.DashboardConfig;
            const utils = window.DashboardUtils;
            
            // DOM elements
            const elements = {
                sidebar: document.getElementById('sidebar'),
                sidebarToggle: document.getElementById('sidebar-toggle'),
                sidebarCollapse: document.getElementById('sidebar-collapse'),
                sidebarOverlay: document.getElementById('sidebar-overlay'),
                mainContent: document.getElementById('main-content'),
                navButtons: document.querySelectorAll('[data-section]'),
                touchElements: document.querySelectorAll('button, .nav-button, .widget-card'),
                chartBars: document.querySelectorAll('.bar-chart')
            };
            
            // Sidebar state management
            const sidebarState = {
                isCollapsed: () => elements.sidebar ? elements.sidebar.classList.contains('collapsed') : false,
                isOpen: () => elements.sidebar ? elements.sidebar.classList.contains('open') : false,
                
                open: () => {
                    if (elements.sidebar) {
                        elements.sidebar.classList.add('open');
                    }
                    if (elements.sidebarOverlay) {
                        elements.sidebarOverlay.classList.add('active');
                    }
                    document.body.style.overflow = 'hidden';
                },
                
                close: () => {
                    if (elements.sidebar) {
                        elements.sidebar.classList.remove('open');
                    }
                    if (elements.sidebarOverlay) {
                        elements.sidebarOverlay.classList.remove('active');
                    }
                    document.body.style.overflow = '';
                },
                
                collapse: () => {
                    if (elements.sidebar) {
                        elements.sidebar.classList.add('collapsed');
                    }
                    if (elements.mainContent) {
                        elements.mainContent.classList.add('sidebar-collapsed');
                    }
                    const icon = elements.sidebarCollapse?.querySelector('i');
                    if (icon) icon.className = 'fas fa-chevron-right text-gray-600 text-lg';
                    localStorage.setItem(CONFIG.storage.key, 'true');
                    utils.setCSSVariable('--sidebar-width', `${CONFIG.sidebar.collapsed}px`);
                    utils.setCSSVariable('--main-margin', `${CONFIG.sidebar.collapsed}px`);
                },
                
                expand: () => {
                    if (elements.sidebar) {
                        elements.sidebar.classList.remove('collapsed');
                    }
                    if (elements.mainContent) {
                        elements.mainContent.classList.remove('sidebar-collapsed');
                    }
                    const icon = elements.sidebarCollapse?.querySelector('i');
                    if (icon) icon.className = 'fas fa-chevron-left text-gray-600 text-lg';
                    localStorage.setItem(CONFIG.storage.key, 'false');
                    utils.setCSSVariable('--sidebar-width', `${CONFIG.sidebar.width}px`);
                    utils.setCSSVariable('--main-margin', `${CONFIG.sidebar.width}px`);
                },
                
                toggle: () => {
                    if (sidebarState.isCollapsed()) {
                        sidebarState.expand();
                    } else {
                        sidebarState.collapse();
                    }
                }
            };
            
            // Initialize sidebar state - only for large screens
            function initializeSidebar() {
                if (utils.isLargeScreen()) {
                    const isCollapsed = localStorage.getItem(CONFIG.storage.key) === 'true';
                    if (isCollapsed) {
                        sidebarState.collapse();
                    }
                }
                // For medium and mobile screens, let CSS handle everything
            }
            
            // Handle responsive behavior - simplified
            function handleResize() {
                if (utils.isMobileScreen()) {
                    sidebarState.close();
                    elements.sidebarCollapse?.classList.add('hidden');
                    elements.sidebarCollapse?.classList.remove('flex');
                } else if (utils.isLargeScreen()) {
                    sidebarState.close();
                    if (elements.sidebarCollapse) {
                        elements.sidebarCollapse.style.display = 'flex';
                        elements.sidebarCollapse.classList.remove('hidden');
                        elements.sidebarCollapse.classList.add('flex');
                    }
                    
                    const isCollapsed = localStorage.getItem(CONFIG.storage.key) === 'true';
                    if (isCollapsed) {
                        sidebarState.collapse();
                    } else {
                        sidebarState.expand();
                    }
                }
                // For medium screens, let CSS handle everything automatically
            }
            
            // Event listeners
            function setupEventListeners() {
                // Sidebar controls
                elements.sidebarToggle?.addEventListener('click', () => {
                    if (utils.isMobileScreen()) {
                        if (sidebarState.isOpen()) {
                            sidebarState.close();
                        } else {
                            sidebarState.open();
                        }
                    }
                });
                
                elements.sidebarCollapse?.addEventListener('click', () => {
                    if (utils.isLargeScreen()) {
                        sidebarState.toggle();
                    }
                });
                
                elements.sidebarOverlay?.addEventListener('click', sidebarState.close);
                
                // Resize handling with debouncing
                let resizeTimeout;
                window.addEventListener('resize', () => {
                    clearTimeout(resizeTimeout);
                    resizeTimeout = setTimeout(handleResize, 100);
                });
                
                // Touch interactions
                elements.touchElements.forEach(element => {
                    element.addEventListener('touchstart', function() {
                        this.style.transform = 'scale(0.98)';
                    });
                    
                    element.addEventListener('touchend', function() {
                        this.style.transform = 'scale(1)';
                    });
                });
                
                // Prevent iOS double-tap zoom
                let lastTouchEnd = 0;
                document.addEventListener('touchend', function(event) {
                    const now = Date.now();
                    if (now - lastTouchEnd <= 300) {
                        event.preventDefault();
                    }
                    lastTouchEnd = now;
                }, false);
            }
            
            // Initialize everything
            function init() {
                // Initialize external libraries
                if (window.lucide) {
                    lucide.createIcons();
                }
                
                // Initialize dashboard components
                initializeSidebar();
                setupEventListeners();
            }
            
            // Start initialization
            init();
        });
    </script>
    
    <!-- CSRF Token -->
    {% csrf_token %}
    
    <!-- Script de fallback para la fecha -->
    <script>
        // Script inmediato para mostrar la fecha
        (function() {
            const currentDate = new Date();
            const options = { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric',
                weekday: 'long'
            };
            const optionsShort = { 
                day: 'numeric',
                month: 'short'
            };
            
            // Función para actualizar fecha
            function updateDateElements() {
                const elements = [
                    { id: 'currentDateFull', options: options },
                    { id: 'currentDateMedium', options: options },
                    { id: 'currentDateShort', options: options },
                    { id: 'currentDateMinimal', options: optionsShort }
                ];
                
                elements.forEach(({ id, options: opts }) => {
                    const element = document.getElementById(id);
                    if (element) {
                        element.textContent = currentDate.toLocaleDateString('es-ES', opts);
                        console.log(`Fecha actualizada en ${id}:`, element.textContent);
                    } else {
                        console.log(`Elemento ${id} no encontrado`);
                    }
                });
            }
            
            // Ejecutar inmediatamente
            updateDateElements();
            
            // Ejecutar cuando el DOM esté listo
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', updateDateElements);
            }
            
            // Ejecutar con delay
            setTimeout(updateDateElements, 100);
            setTimeout(updateDateElements, 500);
            setTimeout(updateDateElements, 1000);
        })();
    </script>
</body>
</html>